<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="PickMeal.PickMeal.mapper.ReviewWishMapper">

    <insert id="saveInteraction" parameterType="PickMeal.PickMeal.dto.ReviewWishDTO">
        INSERT INTO review_wish (res_id, user_id, rating, content, is_wish)
        VALUES (#{resId}, #{userId}, #{rating}, #{content}, #{isWish})
        ON DUPLICATE KEY UPDATE
        rating = COALESCE(#{rating}, rating),
        content = COALESCE(#{content}, content),
        is_wish = COALESCE(#{isWish}, is_wish),
        updated_at = CURRENT_TIMESTAMP
    </insert>

    <select id="getPopularRest" resultType="Pickmeal.Pickmeal.RestaurantDTO">
        SELECT r.res_id, r.res_name, r.address, r.lon, r.lat, r.region_name, r.representative_menu, r.menu_price, r.rest_views
        FROM restaurant r
        JOIN (
            SELECT res_id, COUNT(*) AS wish_count
            FROM review_wish
            WHERE is_wish = 1
            GROUP BY res_id
            ORDER BY wish_count DESC
            LIMIT 10
        ) rw ON r.res_id
        ORDER BY rw.wish_count DESC
        LIMIT 10
    </select>

</mapper>