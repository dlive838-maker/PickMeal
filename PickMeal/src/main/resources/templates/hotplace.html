<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pick Meal - Hot Place</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Fredoka', sans-serif; background-color: #fff; margin: 0; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }
        header, header *, .italic-text { font-style: italic !important; }
        .main-container { flex-grow: 1; display: flex; margin-top: 80px; overflow: hidden; height: calc(100vh - 140px); }
        .side-panel { width: 380px; background: white; border-right: 1px solid #eee; display: flex; flex-direction: column; z-index: 10; height: 100%; }
        .filter-header-section { padding: 12px 18px; display: flex; flex-direction: column; gap: 8px; border-bottom: 1px solid #f5f5f5; }

        .location-badge { background-color: #FF8A5B; color: white; padding: 10px 14px; border-radius: 10px; font-weight: 800; cursor: pointer; font-size: 13px; text-align: center; font-style: italic; transition: 0.3s; }
        .food-badge { background-color: #FFB74D; border-color: #FFB74D; }

        .custom-pin {
            width: 32px; height: 32px; background: #FF8A5B; border-radius: 50% 50% 50% 0;
            transform: rotate(-45deg); cursor: pointer; display: flex; align-items: center; justify-content: center;
            box-shadow: 2px 2px 8px rgba(0,0,0,0.2); border: 2px solid white;
        }
        .custom-pin::after { content: ''; width: 9px; height: 9px; background: white; border-radius: 50%; }
        .custom-pin:hover { background: #FF5E1F; transform: rotate(-45deg) scale(1.15); z-index: 100; }

        .pin-tooltip {
            padding: 10px 15px; background: white; border-radius: 12px; border: 2px solid #FF8A5B;
            font-weight: 800; color: #333; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            white-space: nowrap; pointer-events: none;
        }

        #map { flex-grow: 1; height: 100%; }
        .place-list { flex-grow: 1; overflow-y: auto; }
        .place-item { padding: 20px; border-bottom: 1px solid #f9f9f9; cursor: pointer; transition: 0.2s; }
        .place-item:hover { background: #fffaf8; border-left: 6px solid #FF8A5B; }
        .info-btn { display: inline-block; margin-top: 10px; padding: 6px 14px; background: #f3f4f6; color: #6b7280; border-radius: 8px; font-size: 11px; font-weight: 800; text-decoration: none; font-style: italic; }
        .info-btn:hover { background: #FF8A5B; color: white; }

        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 999; }
        .modal-window { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 24px; z-index: 1000; overflow: hidden; box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
        .active-item { background-color: #fff5f0 !important; color: #FF8A5B !important; font-weight: 800; }
        .scroller::-webkit-scrollbar { width: 5px; }
        .scroller::-webkit-scrollbar-thumb { background: rgba(0, 0, 0, 0.05); border-radius: 10px; }
    </style>
</head>
<body>

<header th:replace="~{fragments/header :: headerFragment}"></header>

<div class="main-container">
    <aside class="side-panel">
        <div class="filter-header-section">
            <div class="location-badge" id="btn-area-open"><span id="display-area">ğŸ“ ì§€ì—­ì„ ì„ íƒí•˜ì„¸ìš”</span></div>
            <div class="location-badge food-badge" id="btn-food-open"><span id="display-food">ğŸ´ ìŒì‹ ì¢…ë¥˜ ì„ íƒ</span></div>
        </div>
        <div id="placesList" class="place-list scroller"></div>
    </aside>
    <div id="map"></div>
</div>

<div class="modal-overlay" id="overlay"></div>

<div class="modal-window w-[600px]" id="modal-area">
    <div class="p-4 bg-[#FF8A5B] text-white font-black text-center italic">SELECT AREA</div>
    <div class="flex h-[350px]">
        <ul id="sidoList" class="w-1/3 overflow-y-auto p-2 border-r scroller"></ul>
        <ul id="sigugunList" class="w-1/3 overflow-y-auto p-2 border-r scroller"></ul>
        <ul id="dongList" class="w-1/3 overflow-y-auto p-2 scroller"></ul>
    </div>
</div>

<div class="modal-window w-[500px]" id="modal-food">
    <div class="p-4 bg-[#FFB74D] text-white font-black text-center italic">SELECT FOOD</div>
    <div class="flex h-[350px]">
        <ul id="foodCategoryList" class="w-1/2 overflow-y-auto p-2 border-r scroller"></ul>
        <ul id="foodNameList" class="w-1/2 overflow-y-auto p-2 scroller"><li class="p-3 text-center text-gray-300">ì¹´í…Œê³ ë¦¬ ì„ íƒ</li></ul>
    </div>
</div>

<footer th:replace="~{fragments/footer :: footerFragment}"></footer>

<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=24546b16104e0273c6d8c5c4cc508b44&libraries=services"></script>

<script th:inline="javascript">
    var map = new kakao.maps.Map(document.getElementById('map'), { center: new kakao.maps.LatLng(37.4980, 127.0276), level: 3 });
    var ps = new kakao.maps.services.Places();
    var geocoder = new kakao.maps.services.Geocoder();
    var currentOverlays = [];
    var areaData = {}, foodData = {};
    let currentSelection = { sido: null, sigugun: null, dong: null, foodName: null };

    const hoverTooltip = new kakao.maps.CustomOverlay({ zIndex: 10, yAnchor: 2.2 });

    const overlay = document.getElementById('overlay');
    const modalArea = document.getElementById('modal-area');
    const modalFood = document.getElementById('modal-food');

    // ëª¨ë‹¬ ì œì–´ í•¨ìˆ˜
    function closeAll() { [overlay, modalArea, modalFood].forEach(m => m.style.display = 'none'); }
    document.getElementById('btn-area-open').onclick = () => { overlay.style.display = 'block'; modalArea.style.display = 'block'; loadAreaData(); };
    document.getElementById('btn-food-open').onclick = () => { overlay.style.display = 'block'; modalFood.style.display = 'block'; loadFoodData(); };
    overlay.onclick = closeAll;

    function createCustomPin(position, place, stats) {
        const content = document.createElement('div');
        content.className = 'custom-pin';

        const pinOverlay = new kakao.maps.CustomOverlay({
            position: position,
            content: content,
            yAnchor: 1.1
        });

        content.onmouseover = () => {
            // 1. í˜„ì¬ ë¦¬ìŠ¤íŠ¸ì— ì´ë¯¸ í‘œì‹œëœ ìµœì‹  ìˆ«ìê°€ ìˆëŠ”ì§€ ë¨¼ì € í™•ì¸í•©ë‹ˆë‹¤.
            const latestCountElement = document.querySelector(`#wish-count-${stats.resId}`);
            // 2. ë§Œì•½ ë¦¬ìŠ¤íŠ¸ ìˆ«ìê°€ ìˆë‹¤ë©´ ê·¸ê±¸ ì“°ê³ , ì—†ìœ¼ë©´ ì›ë˜ DB ìˆ«ìë¥¼ ì”ë‹ˆë‹¤.
            const displayCount = latestCountElement ? latestCountElement.innerText : stats.heartCount;
            const tooltipContent = `
                <div class="pin-tooltip">
                    <div class="mb-2 text-[15px] font-black border-b pb-1">${place.place_name}</div>
                    <div class="flex gap-4 text-[13px] text-orange-500 font-bold italic items-center">
                        <span class="flex items-center gap-1.5">ğŸ‘ï¸ <span class="text-gray-700">${stats.viewCount}</span></span>
                        <span class="flex items-center gap-1.5">â¤ï¸ <span id="wish-count-${stats.resId || place.id}" class="text-gray-700">${stats.heartCount}</span>
                        <span class="flex items-center gap-1.5">ğŸ“ <span class="text-gray-700">${stats.reviewCount}</span></span>
                    </div>
                </div>`;
            hoverTooltip.setContent(tooltipContent);
            hoverTooltip.setPosition(position);
            hoverTooltip.setMap(map);
        };

        content.onmouseout = () => { hoverTooltip.setMap(null); };
        content.onclick = () => {
            fetch(`/hotplace/view?kakaoPlaceId=${place.id}`, { method: 'POST' });
            window.open('https://place.map.kakao.com/' + place.id, '_blank');
        };

        pinOverlay.setMap(map);
        currentOverlays.push(pinOverlay);
    }

    async function renderPlaces(data, status) {
        currentOverlays.forEach(o => o.setMap(null)); currentOverlays = [];
        const listEl = document.getElementById('placesList');
        listEl.innerHTML = '';

        if (status === kakao.maps.services.Status.OK) {
            const placeIds = data.map(p => p.id);
            let statsMap = {};
            try {
                const response = await fetch('/hotplace/stats', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(placeIds)
                });
                const statsList = await response.json();
                statsList.forEach(s => statsMap[s.kakaoPlaceId] = s);
            } catch (e) { console.error("í†µê³„ ë¡œë“œ ì‹¤íŒ¨:", e); }

            data.forEach(place => {
                const pos = new kakao.maps.LatLng(place.y, place.x);
                const stats = statsMap[place.id] || { viewCount: 0, heartCount: 0, reviewCount: 0 };
                createCustomPin(pos, place, stats);

                const item = document.createElement('div');
                item.className = 'place-item';
                item.innerHTML = `
                    <h4 class="font-black text-gray-800 text-xl mb-1 italic">${place.place_name}</h4>
                    <div class="flex gap-4 mb-2 text-[13px] font-bold text-orange-400 italic items-center">
                        <span class="flex items-center gap-1.5">ğŸ‘ï¸ <span class="text-gray-700">${stats.viewCount}</span></span>
                        <span class="flex items-center gap-1.5">â¤ï¸ <span id="wish-count-${stats.resId}" class="text-gray-700">${stats.heartCount}</span></span>
                        <span class="flex items-center gap-1.5">ğŸ“ <span class="text-gray-700">${stats.reviewCount}</span></span>
                    </div>
                    <p class="text-[12px] text-[#FF8A5B] font-black uppercase mb-1 italic">${place.category_name.split('>').pop()}</p>
                    <p class="text-[13px] text-gray-400 font-bold italic">${place.address_name}</p>
                    <a href="https://place.map.kakao.com/${place.id}" target="_blank" class="info-btn">INFO</a>
                `;
                item.onclick = (e) => { if(e.target.tagName !== 'A') { map.panTo(pos); fetch(`/hotplace/view?kakaoPlaceId=${place.id}`, { method: 'POST' }); } };
                listEl.appendChild(item);
            });
        }
    }

    async function loadAreaData() {
        if (Object.keys(areaData).length) return;
        const res = await fetch('/Korea_city_List.json');
        areaData = await res.json();
        renderSido();
    }

    function renderSido() {
        const list = document.getElementById('sidoList'); list.innerHTML = '';
        Object.keys(areaData).forEach(sido => {
            const li = document.createElement('li'); li.className = "p-3 cursor-pointer hover:bg-orange-50 rounded-lg font-bold";
            li.innerText = sido;
            li.onclick = () => { resetActive('sidoList'); li.classList.add('active-item'); currentSelection.sido = sido; renderSigugun(sido); };
            list.appendChild(li);
        });
    }

    function renderSigugun(sido) {
        const list = document.getElementById('sigugunList'); list.innerHTML = '';
        Object.keys(areaData[sido]).forEach(sigu => {
            const li = document.createElement('li'); li.className = "p-3 cursor-pointer hover:bg-orange-50 rounded-lg font-bold";
            li.innerText = sigu;
            li.onclick = () => { resetActive('sigugunList'); li.classList.add('active-item'); currentSelection.sigugun = sigu; renderDong(sido, sigu); };
            list.appendChild(li);
        });
    }

    function renderDong(sido, sigu) {
        const list = document.getElementById('dongList'); list.innerHTML = '';
        areaData[sido][sigu].forEach(dong => {
            const li = document.createElement('li'); li.className = "p-3 cursor-pointer hover:bg-orange-50 rounded-lg font-bold";
            li.innerText = dong;
            li.onclick = () => { currentSelection.dong = dong; document.getElementById('display-area').innerText = `${sido} ${sigu} ${dong}`; closeAll(); updateSearch(); };
            list.appendChild(li);
        });
    }

    async function loadFoodData() {
        if (Object.keys(foodData).length) return;
        const res = await fetch('/Food_List.json');
        foodData = await res.json();
        renderFoodCategory();
    }

    function renderFoodCategory() {
        const list = document.getElementById('foodCategoryList'); list.innerHTML = '';
        Object.keys(foodData).forEach(cat => {
            const li = document.createElement('li'); li.className = "p-3 cursor-pointer hover:bg-orange-50 rounded-lg font-bold";
            li.innerText = cat;
            li.onclick = () => { resetActive('foodCategoryList'); li.classList.add('active-item'); renderFoodNames(cat); };
            list.appendChild(li);
        });
    }

    function renderFoodNames(cat) {
        const list = document.getElementById('foodNameList'); list.innerHTML = '';
        foodData[cat].forEach(food => {
            const li = document.createElement('li'); li.className = "p-3 cursor-pointer hover:bg-orange-50 rounded-lg font-bold";
            li.innerText = food.name;
            li.onclick = () => { currentSelection.foodName = food.name; document.getElementById('display-food').innerText = food.name; closeAll(); updateSearch(); };
            list.appendChild(li);
        });
    }

    function updateSearch() {
        let keyword = "";
        if (currentSelection.dong) keyword += `${currentSelection.sido} ${currentSelection.sigugun} ${currentSelection.dong} `;
        if (currentSelection.foodName) keyword += currentSelection.foodName;
        if (!keyword.trim()) return;
        geocoder.addressSearch(`${currentSelection.sido} ${currentSelection.sigugun} ${currentSelection.dong}`, (result, status) => {
            if (status === kakao.maps.services.Status.OK) { map.setCenter(new kakao.maps.LatLng(result[0].y, result[0].x)); ps.keywordSearch(keyword, renderPlaces); }
        });
    }

    function resetActive(id) {
        const list = document.getElementById(id);
        if (list) Array.from(list.children).forEach(li => li.classList.remove('active-item'));
    }

    window.onload = () => { map.relayout(); ps.keywordSearch('ë§›ì§‘', renderPlaces); };
</script>
</body>
</html>