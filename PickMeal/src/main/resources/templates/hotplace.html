<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pick Meal - Hot Place</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Fredoka', sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh; /* 화면 전체 높이 사용 */
            background-color: #FFF5F0;
        }

        /* 지도가 헤더 아래부터 화면 끝까지 꽉 차도록 설정 */
        .map-container {
            flex-grow: 1;
            width: 100%;
            position: relative;
            margin-top: 80px; /* 헤더의 높이에 맞춰 조절하세요 */
        }

        #map {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
<header th:replace="~{fragments/header :: headerFragment}"></header>

<div id = "areaPage" style = "display:none;" class="max-w-4xl mx-auto bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden absolute top-20 left-0 right-0 z-50">

    <div  class="flex h-[500px] text-sm">

        <div class="w-1/3 border-r border-gray-100 flex flex-col">
            <div class="p-3 bg-gray-50 font-bold text-gray-500 text-center border-b">시/도</div>
            <ul id="sidoList" class="scroller overflow-y-auto flex-1 p-2">
            </ul>
        </div>

        <div class="w-1/3 border-r border-gray-100 flex flex-col">
            <div class="p-3 bg-gray-50 font-bold text-gray-500 text-center border-b">시/군/구</div>
            <ul id="sigugunList" class="scroller overflow-y-auto flex-1 p-2">
                <li class="p-3 text-center text-gray-300">시/도를 먼저 선택하세요</li>
            </ul>
        </div>

        <div class="w-1/3 flex flex-col">
            <div class="p-3 bg-gray-50 font-bold text-gray-500 text-center border-b">읍/면/동</div>
            <ul id="dongList" class="scroller overflow-y-auto flex-1 p-2">
                <li class="p-3 text-center text-gray-300">시/군/구를 먼저 선택하세요</li>
            </ul>
        </div>

    </div>
</div>

<main class="map-container">
    <div id="map" style="height:600px; width: 100%;">
        <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=24546b16104e0273c6d8c5c4cc508b44&libraries=services,clusterer,drawing"></script>
    </div>

    <button type = "button" id="showArea"><img src="/images/mapFilter.png" alt="showArea"></button>

</main>

<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=24546b16104e0273c6d8c5c4cc508b44&libraries=services,clusterer,drawing"></script>

<script>
    var container = document.getElementById('map');
    var options = {
        center: new kakao.maps.LatLng(37.49027, 126.92753), // 신림역 부근 좌표
        level: 3
    };

    var map = new kakao.maps.Map(container, options);

    // 지도 컨트롤 추가
    var mapTypeControl = new kakao.maps.MapTypeControl();
    map.addControl(mapTypeControl, kakao.maps.ControlPosition.TOPRIGHT);

    var zoomControl = new kakao.maps.ZoomControl();
    map.addControl(zoomControl, kakao.maps.ControlPosition.RIGHT);
var marker = new kakao.maps.Marker({ map: map, position: options.center });
    // 창 크기 변경 시 지도 크기 재조정
    window.onresize = function() {
        map.relayout();
    };

        var imageSrc = '/images/location.png';
var imageSize = new kakao.maps.Size(64, 69);
var imageOption = {offset: new kakao.maps.Point(27, 69)};

var markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize, imageOption);

    var marker = new kakao.maps.Marker({
    map: map,
    position: options.center,
    image: markerImage
     });

// 주소 필터 페이지 부분 js
    var areaData = {};
    var ps = new kakao.maps.services.Places();

    let currentSelection = { sido: null, sigugun: null, dong: null };

    const showAreaButton = document.getElementById('showArea');
    const areaPage = document.getElementById('areaPage');

    showAreaButton.addEventListener('click', function() {
        if (areaPage.style.display === 'none') {
            areaPage.style.display = 'block';
            loadAreaData();
        } else {
            areaPage.style.display = 'none';
        }
    });

    async function loadAreaData() {
        if (Object.keys(areaData).length > 0) return;

        try {
            const response = await fetch('/Korea_city_List.json');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            areaData = await response.json();
            renderSido();
        } catch (error) {
            console.error("행정구역 데이터 로딩 실패:", error);
            alert("지역 데이터를 불러오는데 실패했습니다.");
        }
    }

    function renderSido() {
            const list = document.getElementById('sidoList');
            list.innerHTML = '';

            Object.keys(areaData).forEach(sido => {
                const li = document.createElement('li');
                li.className = "p-3 cursor-pointer hover:bg-gray-50 rounded transition text-gray-700";
                li.innerText = sido;
                li.onclick = () => selectSido(li, sido);
                list.appendChild(li);
        });
    }

    function selectSido(element, sido) {

        resetActive('sidoList');
        element.classList.add('active-item');

        currentSelection.sido = sido;

        renderSigugun(sido);
        document.getElementById('dongList').innerHTML = '<li class="p-3 text-center text-gray-300">시/군/구를 먼저 선택하세요</li>';
    }

    function renderSigugun(sido) {
            const list = document.getElementById('sigugunList');
            list.innerHTML = '';

            const siguguns = Object.keys(areaData[sido]);
            siguguns.forEach(sigugun => {
                const li = document.createElement('li');
                li.className = "p-3 cursor-pointer hover:bg-gray-50 rounded transition text-gray-700";
                li.innerText = sigugun;
                li.onclick = () => selectSigugun(li, sido, sigugun);
                list.appendChild(li);
        });
    }

    function selectSigugun(element, sido, sigugun) {

        resetActive('sigugunList');
        element.classList.add('active-item');
        currentSelection.sigugun = sigugun;
        renderDong(sido, sigugun);
    }

    function renderDong(sido, sigugun) {
            const list = document.getElementById('dongList');
            list.innerHTML = '';

            const dongs = areaData[sido][sigugun];
            dongs.forEach(dong => {
                const li = document.createElement('li');
                li.className = "p-3 cursor-pointer hover:bg-gray-50 rounded transition text-gray-700";
                li.innerText = dong;
                li.onclick = () => selectDong(li, sido, sigugun, dong);
                list.appendChild(li);
        });
    }

    function selectDong(element, sido, sigugun, dong) {

        resetActive('dongList');
        element.classList.add('active-item');

        currentSelection.dong = dong;

        const fullAddress = `${sido} ${sigugun} ${dong}`;
        addTag(fullAddress);
        searchMapLocation(fullAddress);

        areaPage.style.display = 'none';
    }

    function resetActive(listId) {
        const list = document.getElementById(listId);
        Array.from(list.children).forEach(li => li.classList.remove('active-item'));
    }

    function addTag(text) {
        const container = document.getElementById('selectedTags');
        if (container) {
            container.innerHTML = '';
            const tag = document.createElement('div');
            tag.className = "bg-[#FF8A5B] text-white px-3 py-1 rounded-full text-xs font-bold shadow-sm flex items-center gap-2";
            tag.innerHTML = `${text} <button onclick="this.parentElement.remove()" class="hover:text-red-200">✕</button>`;
            container.appendChild(tag);
        }
    }

    function searchMapLocation(keyword) {
        ps.keywordSearch(keyword, placesSearchCB);
    }

    function placesSearchCB(data, status, pagination) {
        if (status === kakao.maps.services.Status.OK) {
            var bounds = new kakao.maps.LatLngBounds();

            var center = new kakao.maps.LatLng(data[0].y, data[0].x);
            map.setCenter(center);
            map.setLevel(3);

            marker.setPosition(center);
        }
    }

</script>

<footer th:replace="~{fragments/footer :: footerFragment}"></footer>
</body>
</html>