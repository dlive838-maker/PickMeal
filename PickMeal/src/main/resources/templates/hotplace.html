<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pick Meal - Hot Place</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Fredoka', sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh; /* í™”ë©´ ì „ì²´ ë†’ì´ ì‚¬ìš© */
            background-color: #FFF5F0;
        }

        /* ì§€ë„ê°€ í—¤ë” ì•„ë˜ë¶€í„° í™”ë©´ ëê¹Œì§€ ê½‰ ì°¨ë„ë¡ ì„¤ì • */
        .map-container {
            flex-grow: 1;
            width: 100%;
            position: relative;
            margin-top: 80px; /* í—¤ë”ì˜ ë†’ì´ì— ë§ì¶° ì¡°ì ˆí•˜ì„¸ìš” */
        }

        #map {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
<header th:replace="~{fragments/header :: headerFragment}"></header>

<div id = "areaPage" style = "display:none;" class="max-w-4xl mx-auto bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden absolute top-20 left-0 right-0 z-50">

    <div  class="flex h-[500px] text-sm">

        <div class="w-1/3 border-r border-gray-100 flex flex-col">
            <div class="p-3 bg-gray-50 font-bold text-gray-500 text-center border-b">ì‹œ/ë„</div>
            <ul id="sidoList" class="scroller overflow-y-auto flex-1 p-2">
            </ul>
        </div>

        <div class="w-1/3 border-r border-gray-100 flex flex-col">
            <div class="p-3 bg-gray-50 font-bold text-gray-500 text-center border-b">ì‹œ/êµ°/êµ¬</div>
            <ul id="sigugunList" class="scroller overflow-y-auto flex-1 p-2">
                <li class="p-3 text-center text-gray-300">ì‹œ/ë„ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”</li>
            </ul>
        </div>

        <div class="w-1/3 flex flex-col">
            <div class="p-3 bg-gray-50 font-bold text-gray-500 text-center border-b">ì/ë©´/ë™</div>
            <ul id="dongList" class="scroller overflow-y-auto flex-1 p-2">
                <li class="p-3 text-center text-gray-300">ì‹œ/êµ°/êµ¬ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”</li>
            </ul>
        </div>

    </div>
</div>

<div id = "foodSelectPage" style = "display:none;" class="max-w-4xl mx-auto bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden absolute top-20 left-0 right-0 z-50">
    <div  class="flex h-[500px] text-sm">

        <div class="w-1/3 border-r border-gray-100 flex flex-col">
            <div class="p-3 bg-gray-50 font-bold text-gray-500 text-center border-b">ìŒì‹ ì¢…ë¥˜</div>
            <ul id="foodCategoryList" class="scroller overflow-y-auto flex-1 p-2">
            </ul>
        </div>

        <div class="w-1/3 border-r border-gray-100 flex flex-col">
            <div class="p-3 bg-gray-50 font-bold text-gray-500 text-center border-b">ìŒì‹ ì´ë¦„</div>
            <ul id="foodNameList" class="scroller overflow-y-auto flex-1 p-2">
                <li class="p-3 text-center text-gray-300">ìŒì‹ ì¢…ë¥˜ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”</li>
            </ul>
        </div>

    </div>
</div>

<main class="map-container">
    <div id="map" style="height:100%; width: 100%;">
        <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=24546b16104e0273c6d8c5c4cc508b44&libraries=services,clusterer,drawing"></script>
    </div>

    <div id="selectedTags" class="absolute top-5 left-5 z-20 flex flex-wrap gap-2"></div>

    <div class="absolute bottom-10 right-5 z-20 flex gap-3">
        <button type="button" id="showArea" class="w-14 h-14 bg-white rounded-full shadow-lg flex items-center justify-center hover:bg-gray-50 transition transform hover:scale-105">
            <img src="/images/mapFilter.png" alt="showArea" class="w-8 h-8">
        </button>
        <button type="button" id="showFood" style = "display:none;" class="w-14 h-14 bg-white rounded-full shadow-lg flex items-center justify-center hover:bg-gray-50 transition transform hover:scale-105">
            <img src="/images/foodFilter.png" alt="showFood" class="w-8 h-8">
        </button>
    </div>

</main>


<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=24546b16104e0273c6d8c5c4cc508b44&libraries=services,clusterer,drawing"></script>

<script th:inline="javascript"> // ìˆ˜ì •
    var container = document.getElementById('map');
    var options = {
        center: new kakao.maps.LatLng(37.49027, 126.92753),
        level: 3
    };

    var map = new kakao.maps.Map(container, options);

    const myDbRestaurants = /*[[${restaurantList}]]*/ [];

    // í•€(ë§ˆì»¤)ì˜ ëª¨ì–‘ê³¼ ì´ë¯¸ì§€ ì„¤ì •í•˜ê¸° - ì¶”ê°€
    const myImageSrc = '/images/foodLocation.png';
    const myImageSize = new kakao.maps.Size(35, 35);
    const myMarkerImage = new kakao.maps.MarkerImage(myImageSrc, myImageSize);

    var markers = []; // ì¶”ê°€
    const overlay = new kakao.maps.CustomOverlay({
    zIndex: 3,
    yAnchor: 1.2
   });

   // ì§€ë„ì— í•€ ê½‚ê¸° ì‹œì‘ - ì¶”ê°€
    myDbRestaurants.forEach(res => {
    const position = new kakao.maps.LatLng(res.lat, res.lon);

    // ë§ˆì»¤ ìƒì„± - ì¶”ê°€
    const marker = new kakao.maps.Marker({
        map: map,
        position: position,
        // titleì€ ê¸°ë³¸ ì´ë¦„í‘œ ë°©ì§€ë¥¼ ìœ„í•´ ë„£ì§€ ì•ŠìŠµë‹ˆë‹¤.
        image: myMarkerImage
    });

    // ì •ë³´ì°½ ë””ìì¸ ì •ì˜ - ì¶”ê°€
    // ì •ë³´ì°½ ë””ìì¸ ì •ì˜
    const content =
        '<div style="padding:20px; line-height:1.8; font-family: sans-serif; min-width: 240px; ' +
        '            background-color: white; border-radius: 15px; border: 1px solid #ccc; ' +
        '            box-shadow: 0px 4px 10px rgba(0,0,0,0.1); box-sizing: border-box;">' +
        '   <div style="margin-bottom: 8px;">' +
        '       <span style="color:#FF5722; font-size:17px; font-weight:bold; display: block;">' + res.res_name + '</span>' +
        '   </div>' +
        '   <div style="font-size:13px; color:#888; margin-bottom: 5px; word-break: keep-all;">' +
        '       ğŸ“ ' + (res.address || 'ì£¼ì†Œ ì •ë³´ ì—†ìŒ') +
        '   </div>' +
        '   <div style="font-size:14px; color:#666; word-break: break-all; margin-bottom: 5px;">' +
        '       <span style="font-weight:bold; color:#333;">ì¶”ì²œ:</span> ' + (res.representative_menu || 'ì •ë³´ì—†ìŒ') +
        '   </div>' +
        '   <div style="font-size:14px; color:#666;">' +
        '       <span style="font-weight:bold; color:#333;">ê°€ê²©:</span> ' + (res.menu_price > 0 ? res.menu_price + 'ì›' : 'ê°€ê²© ì •ë³´ ì—†ìŒ') +
        '   </div>' +
        '</div>';

    // [ì„¼ì„œ ì—°ê²°] ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë ¸ì„ ë•Œ - ì¶”ê°€
    kakao.maps.event.addListener(marker, 'mouseover', function() {
        overlay.setContent(content);
        overlay.setPosition(marker.getPosition());
        overlay.setMap(map);
    });

    // [ì„¼ì„œ ì—°ê²°] ë§ˆìš°ìŠ¤ê°€ ë²—ì–´ë‚¬ì„ ë•Œ - ì¶”ê°€
    kakao.maps.event.addListener(marker, 'mouseout', function() {
        overlay.setMap(null);
    });

    // ë§ˆì»¤ë¥¼ ë¦¬ìŠ¤íŠ¸ì— ë‹´ê¸° - ì¶”ê°€
    markers.push(marker);
    });

    // ì§€ë„ ì»¨íŠ¸ë¡¤ ì¶”ê°€
    var mapTypeControl = new kakao.maps.MapTypeControl();
    map.addControl(mapTypeControl, kakao.maps.ControlPosition.TOPRIGHT);

    var zoomControl = new kakao.maps.ZoomControl();
    map.addControl(zoomControl, kakao.maps.ControlPosition.RIGHT);

    // var marker = new kakao.maps.Marker({ map: map, position: options.center });

    // ì°½ í¬ê¸° ë³€ê²½ ì‹œ ì§€ë„ í¬ê¸° ì¬ì¡°ì •
    window.onresize = function() {
        map.relayout();
    };

    var markers = [];

    var imageSrc = '/images/location.png';
    var imageSize = new kakao.maps.Size(64, 69);
    var imageOption = {offset: new kakao.maps.Point(27, 69)};

    var markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize, imageOption);

    var marker = new kakao.maps.Marker({
        map: map,
        position: options.center,
        image: markerImage
    });

    markers.push(marker);

    function removeMarker(){
        for (var i = 0; i < markers.length; i++) {
          markers[i].setMap(null);
        }
    }

    // ì£¼ì†Œ í•„í„° í˜ì´ì§€ ë¶€ë¶„ js
    var areaData = {};
    var ps = new kakao.maps.services.Places();

    let currentSelection = {
        sido: null,
        sigugun: null,
        dong: null,
        foodCategory: null,
        foodName: null
    };

    const showAreaButton = document.getElementById('showArea');
    const areaPage = document.getElementById('areaPage');

    showAreaButton.addEventListener('click', function() {
        if (areaPage.style.display === 'none') {
            areaPage.style.display = 'block';
            loadAreaData();
        } else {
            areaPage.style.display = 'none';
        }
    });

    async function loadAreaData() {
        if (Object.keys(areaData).length > 0) return;

        try {
            const response = await fetch('/Korea_city_List.json');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            areaData = await response.json();
            renderSido();
        } catch (error) {
            console.error("í–‰ì •êµ¬ì—­ ë°ì´í„° ë¡œë”© ì‹¤íŒ¨:", error);
            alert("ì§€ì—­ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }
    }

    function renderSido() {
            const list = document.getElementById('sidoList');
            list.innerHTML = '';

            Object.keys(areaData).forEach(sido => {
                const li = document.createElement('li');
                li.className = "p-3 cursor-pointer hover:bg-gray-50 rounded transition text-gray-700";
                li.innerText = sido;
                li.onclick = () => selectSido(li, sido);
                list.appendChild(li);
        });
    }

    function selectSido(element, sido) {

        resetActive('sidoList');
        element.classList.add('active-item');

        currentSelection.sido = sido;

        renderSigugun(sido);
        document.getElementById('dongList').innerHTML = '<li class="p-3 text-center text-gray-300">ì‹œ/êµ°/êµ¬ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”</li>';
    }

    function renderSigugun(sido) {
            const list = document.getElementById('sigugunList');
            list.innerHTML = '';

            const siguguns = Object.keys(areaData[sido]);
            siguguns.forEach(sigugun => {
                const li = document.createElement('li');
                li.className = "p-3 cursor-pointer hover:bg-gray-50 rounded transition text-gray-700";
                li.innerText = sigugun;
                li.onclick = () => selectSigugun(li, sido, sigugun);
                list.appendChild(li);
        });
    }

    function selectSigugun(element, sido, sigugun) {

        resetActive('sigugunList');
        element.classList.add('active-item');
        currentSelection.sigugun = sigugun;
        renderDong(sido, sigugun);
    }

    function renderDong(sido, sigugun) {
            const list = document.getElementById('dongList');
            list.innerHTML = '';

            const dongs = areaData[sido][sigugun];
            dongs.forEach(dong => {
                const li = document.createElement('li');
                li.className = "p-3 cursor-pointer hover:bg-gray-50 rounded transition text-gray-700";
                li.innerText = dong;
                li.onclick = () => selectDong(li, sido, sigugun, dong);
                list.appendChild(li);
        });
    }

    function selectDong(element, sido, sigugun, dong) {
        resetActive('dongList');
        element.classList.add('active-item');

        currentSelection.dong = dong;

        areaPage.style.display = 'none';
        updateSearch();
        showFoodButton.style.display = 'block';
    }

    function resetActive(listId) {
        const list = document.getElementById(listId);
        Array.from(list.children).forEach(li => li.classList.remove('active-item'));
    }

    var isIncludeFood = false;

    function updateSearch() {
        let keyword = "";
        const tags = [];

        if (currentSelection.dong) {
            const address = `${currentSelection.sido} ${currentSelection.sigugun} ${currentSelection.dong}`;
            keyword += address;
            tags.push({ text: address, type: 'address' });
        }

        if (currentSelection.foodName) {
            const food = currentSelection.foodName;
            if (keyword) keyword += " ";
            keyword += food;
            tags.push({ text: food, type: 'food' });
            isIncludeFood = true;
        }

        renderTags(tags);

        if (keyword) {
            searchMapLocation(keyword);
        }
    }

    function renderTags(tags) {
        const container = document.getElementById('selectedTags');
        if (!container) return;

        container.innerHTML = '';
        tags.forEach(tag => {
            const tagElement = document.createElement('div');
            tagElement.className = "bg-[#FF8A5B] text-white px-3 py-1 rounded-full text-xs font-bold shadow-sm flex items-center gap-2 cursor-pointer hover:bg-[#FF7043] transition";
            tagElement.innerHTML = `${tag.text} <span class="text-white/80 hover:text-white">âœ•</span>`;

            tagElement.onclick = (e) => {
                e.stopPropagation();
                removeSelection(tag.type);
            };

            container.appendChild(tagElement);
        });
    }

    function removeSelection(type) {
        if (type === 'address') {
            currentSelection.sido = null;
            currentSelection.sigugun = null;
            currentSelection.dong = null;
            resetActive('sidoList');
            resetActive('sigugunList');
            resetActive('dongList');
            document.getElementById('sigugunList').innerHTML = '<li class="p-3 text-center text-gray-300">ì‹œ/ë„ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”</li>';
            document.getElementById('dongList').innerHTML = '<li class="p-3 text-center text-gray-300">ì‹œ/êµ°/êµ¬ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”</li>';

        } else if (type === 'food') {
            currentSelection.foodCategory = null;
            currentSelection.foodName = null;
            resetActive('foodCategoryList');
            resetActive('foodNameList');
            document.getElementById('foodNameList').innerHTML = '<li class="p-3 text-center text-gray-300">ìŒì‹ ì¢…ë¥˜ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”</li>';
        }
        updateSearch();
    }

    function searchMapLocation(keyword) {
        ps.keywordSearch(keyword, placesSearchCB);
    }

    function placesSearchCB(data, status, pagination) {
        removeMarker();
        if (status === kakao.maps.services.Status.OK) {
            var bounds = new kakao.maps.LatLngBounds();

            for(var i = 0; i < data.length; i++){
                var placePosition = new kakao.maps.LatLng(data[i].y, data[i].x);
                bounds.extend(placePosition);
            }
            if(isIncludeFood) {
                for(var i = 0; i < 5; i++){
                    var placePosition = new kakao.maps.LatLng(data[i].y, data[i].x);
                    var foodImageSrc = '/images/foodLocation.png';
                    var foodImageSize = new kakao.maps.Size(32, 35);
                    var foodImageOption = {offset: new kakao.maps.Point(16, 35)};

                    var foodMarkerImage = new kakao.maps.MarkerImage(foodImageSrc, foodImageSize, foodImageOption);

                    var foodMarker = new kakao.maps.Marker({
                        map: map,
                        position: placePosition,
                        image: foodMarkerImage
                    });

                    var iwContent = '<div style="padding:5px;">' + data[i].place_name + ' <br><a href="' + data[i].place_url + '" style="color:blue" target="_blank">ìƒì„¸í˜ì´ì§€</a><a href="https://map.kakao.com/link/to/' + data[i].place_name + ',' + data[i].y + ',' + data[i].x + '" style="color:blue" target="_blank">ê¸¸ì°¾ê¸°</a></div>';

                    var infoWindow = new kakao.maps.InfoWindow({
                        position : placePosition,
                        content : iwContent
                    });

                    infoWindow.open(map, foodMarker);

                    markers.push(foodMarker);
                }
                isIncludeFood = false;
            }


            map.setBounds(bounds);
        }
    }

    // ìŒì‹ ì„ íƒ í˜ì´ì§€ ë¶€ë¶„ js
    var foodData = {};

    var currentSelectFood = null;

    const showFoodButton = document.getElementById('showFood');
    const foodSelectPage = document.getElementById('foodSelectPage');

    showFoodButton.addEventListener('click', function() {
        if (foodSelectPage.style.display === 'none') {
            foodSelectPage.style.display = 'block';
            loadFoodData();
        } else {
            foodSelectPage.style.display = 'none';
        }

    });

    async function loadFoodData() {
        if (Object.keys(foodData).length > 0) return;

        try {
            const response = await fetch('/Food_List.json');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            foodData = await response.json();
            renderFoodCategory();
        } catch (error) {
            console.error("ìŒì‹ ë°ì´í„° ë¡œë”© ì‹¤íŒ¨:", error);
            alert("ìŒì‹ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }
    }

    function renderFoodCategory() {
            const list = document.getElementById('foodCategoryList');
            list.innerHTML = '';

            Object.keys(foodData).forEach(foodCategory => {
                const li = document.createElement('li');
                li.className = "p-3 cursor-pointer hover:bg-gray-50 rounded transition text-gray-700";
                li.innerText = foodCategory;
                li.onclick = () => selectFoodCategory(li, foodCategory);
                list.appendChild(li);
        });
    }

    function selectFoodCategory(element, foodCategory) {
        resetActive('foodCategoryList');
        element.classList.add('active-item');

        currentSelection.foodCategory = foodCategory;

        renderFoodName(foodCategory);
    }

    function renderFoodName(foodCategory) {
            const list = document.getElementById('foodNameList');
            list.innerHTML = '';

            const foods = foodData[foodCategory];
            foods.forEach(food => {
                const li = document.createElement('li');
                li.className = "p-3 cursor-pointer hover:bg-gray-50 rounded transition text-gray-700";
                li.innerText = food.name;

                li.onclick = () => selectFoodName(li, foodCategory, food.name);
                list.appendChild(li);
        });
    }

    function selectFoodName(element, foodCategory, foodName) {
        resetActive('foodNameList');
        element.classList.add('active-item');
        currentSelection.foodName = foodName;

        foodSelectPage.style.display = 'none';
        updateSearch();


    }

</script>

<footer th:replace="~{fragments/footer :: footerFragment}"></footer>
</body>
</html>