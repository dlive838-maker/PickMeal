<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pick Meal - Hot Place</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Fredoka', sans-serif; background-color: #fff; margin: 0; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }
        header, header *, .italic-text { font-style: italic !important; }
        .main-container { flex-grow: 1; display: flex; margin-top: 80px; overflow: hidden; height: calc(100vh - 140px); }
        .side-panel { width: 380px; background: white; border-right: 1px solid #eee; display: flex; flex-direction: column; z-index: 10; height: 100%; }
        .filter-header-section { padding: 12px 18px; display: flex; flex-direction: column; gap: 8px; border-bottom: 1px solid #f5f5f5; }

        .location-badge { background-color: #FF8A5B; color: white; padding: 10px 14px; border-radius: 10px; font-weight: 800; cursor: pointer; font-size: 13px; text-align: center; font-style: italic; transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);


}
        .food-badge { background-color: #FFB74D; border-color: #FFB74D; }
        .location-badge:hover {
    transform: translateY(-2px); /* ìœ„ë¡œ ì‚´ì§ ë– ì˜¤ë¦„ */
    box-shadow: 0 5px 15px rgba(0,0,0,0.1); /* ê·¸ë¦¼ì ê°•í™” */
    filter: brightness(1.05); /* ìƒ‰ìƒì„ 5% ë°ê²Œ í•˜ì—¬ ê°•ì¡° */
}

/* [ì¶”ê°€] í´ë¦­ ì‹œ(Active) ê¾¹ ëˆŒë¦¬ëŠ” íš¨ê³¼ */
.location-badge:active {
    transform: translateY(0);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

        .ani-btn {
            display: flex; align-items: center; gap: 4px; transition: all 0.2s ease-in-out;
            cursor: pointer; border: none; background: none; padding: 0;
            font-size: 1.2rem; color: transparent; -webkit-text-stroke: 1.5px #666;
        }
        .ani-btn:hover {
    transform: scale(1.2); /* 1.2ë°°ë¡œ ë¶€ë“œëŸ½ê²Œ ì»¤ì§ */
}

.ani-btn:hover {
    -webkit-text-stroke: 1.5px #444; /* í…Œë‘ë¦¬ ì„ ì„ ì¡°ê¸ˆ ë” ì§„í•˜ê²Œ */
}

        .ani-btn.liked { color: #FF4757 !important; -webkit-text-stroke: 1.5px #FF4757; }
        .ani-btn.animate { animation: heart-pop 0.4s ease-out; }
        @keyframes heart-pop { 0% { transform: scale(1); } 50% { transform: scale(1.4); } 100% { transform: scale(1); } }
        .heart-count-text { color: #444; font-size: 13px; font-weight: 700; -webkit-text-stroke: 0; }

        .star-rating { display: flex; flex-direction: row-reverse; justify-content: center; gap: 4px; margin-bottom: 5px; }
        .star-rating input { display: none; }
        .star-rating label { font-size: 2rem; color: #ccc; cursor: pointer; transition: 0.2s; }
        .star-rating input:checked ~ label, .star-rating label:hover, .star-rating label:hover ~ label { color: #FFB74D; }

        .custom-pin {
            width: 32px; height: 32px; background: #FF8A5B; border-radius: 50% 50% 50% 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform: rotate(-45deg); cursor: pointer; display: flex; align-items: center; justify-content: center;
            box-shadow: 2px 2px 8px rgba(0,0,0,0.2); border: 2px solid white;
        }
        .custom-pin:hover {
    transform: rotate(-45deg) scale(1.2) translateY(-5px) !important;
    /* ê¸°ì¡´ -45ë„ íšŒì „ì„ ìœ ì§€í•˜ë©´ì„œ, 1.2ë°° ì»¤ì§€ê³  ìœ„ë¡œ 5px ì´ë™ */
    background: #FF4757 !important; /* í˜¸ë²„ ì‹œ ìƒ‰ìƒì„ ì¢€ ë” ì§„í•œ ë¹¨ê°•ìœ¼ë¡œ ë³€ê²½ (ì„ íƒì‚¬í•­) */
    box-shadow: 0 10px 20px rgba(0,0,0,0.3);
}
        .custom-pin::after { content: ''; width: 9px; height: 9px; background: white; border-radius: 50%; }
        .pin-tooltip { padding: 10px 15px; background: white; border-radius: 12px; border: 2px solid #FF8A5B; font-weight: 800; color: #333; box-shadow: 0 4px 12px rgba(0,0,0,0.15); white-space: nowrap; pointer-events: none; }

        #map { flex-grow: 1; height: 100%; }
        .place-list { flex-grow: 1; overflow-y: auto; }
        .place-item { padding: 20px; border-bottom: 1px solid #f9f9f9; cursor: pointer; transition: 0.2s; }
        .place-item:hover { background: #fffaf8; border-left: 6px solid #FF8A5B; }
        .info-btn { display: inline-block; margin-top: 10px; padding: 6px 14px; background: #f3f4f6; color: #6b7280; border-radius: 8px; font-size: 11px; font-weight: 800; text-decoration: none; font-style: italic; border: none; cursor: pointer; }
        .info-btn:hover { background: #FF8A5B; color: white; }

        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 999; }
        .modal-window { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 24px; z-index: 1000; overflow: hidden; box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
        .scroller::-webkit-scrollbar { width: 5px; }
        .scroller::-webkit-scrollbar-thumb { background: rgba(0, 0, 0, 0.05); border-radius: 10px; }

        .review-card { padding: 15px; border-bottom: 1px solid #f0f0f0; background: white; margin-bottom: 8px; border-radius: 12px; position: relative; }
        .review-user { font-weight: 800; color: #FF8A5B; font-size: 13px; margin-bottom: 4px; font-style: italic; }
        .review-text { font-weight: 600; color: #444; font-size: 14px; line-height: 1.4; }
        .edit-label { position: absolute; top: 12px; right: 15px; font-size: 11px; color: #bbb; font-weight: 800; cursor: pointer; font-style: italic; }
        .edit-label:hover { color: #FF8A5B; }
    </style>
</head>
<body>

<header th:replace="~{fragments/header :: headerFragment}"></header>

<div class="main-container">
    <aside class="side-panel">
        <div class="filter-header-section">
            <div class="location-badge" id="btn-area-open"><span id="display-area">ğŸ“ ì§€ì—­ì„ ì„ íƒí•˜ì„¸ìš”</span></div>
            <div class="location-badge food-badge" id="btn-food-open"><span id="display-food">ğŸ´ ìŒì‹ ì¢…ë¥˜ ì„ íƒ</span></div>

            <div class="relative mt-2 flex items-center gap-2">
                <div class="relative flex-grow">
                    <input type="text" id="keywordInput"
                           class="w-full p-3 pr-10 rounded-xl border-2 border-gray-100 outline-none focus:border-[#FF8A5B] transition-all font-semibold text-sm"
                           placeholder="ê°€ê²Œëª… í˜¹ì€ í‚¤ì›Œë“œ ì…ë ¥">
                    <button id="btnSearch" class="absolute right-3 top-1/2 -translate-y-1/2 text-[#FF8A5B] hover:scale-110 transition-transform">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>
        <div id="placesList" class="place-list scroller"></div>
    </aside>
    <div id="map"></div>
</div>

<div class="modal-overlay" id="overlay"></div>

<div class="modal-window w-[600px]" id="modal-area">
    <div class="p-4 bg-[#FF8A5B] text-white font-black text-center italic">SELECT AREA</div>
    <div class="flex h-[350px]">
        <ul id="sidoList" class="w-1/3 overflow-y-auto p-2 border-r scroller"></ul>
        <ul id="sigugunList" class="w-1/3 overflow-y-auto p-2 border-r scroller"></ul>
        <ul id="dongList" class="w-1/3 overflow-y-auto p-2 scroller"></ul>
    </div>
</div>

<div class="modal-window w-[500px]" id="modal-food">
    <div class="p-4 bg-[#FFB74D] text-white font-black text-center italic">SELECT FOOD</div>
    <div class="flex h-[350px]">
        <ul id="foodCategoryList" class="w-1/2 overflow-y-auto p-2 border-r scroller"></ul>
        <ul id="foodNameList" class="w-1/2 overflow-y-auto p-2 scroller"></ul>
    </div>
</div>

<div class="modal-window w-[450px]" id="modal-review">
    <button onclick="closeAll()" class="absolute top-4 right-4 text-white z-20 hover:scale-110 transition-transform">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M6 18L18 6M6 6l12 12" />
        </svg>
    </button>
    <div class="p-4 bg-[#FF8A5B] text-white font-black text-center italic">REVIEWS</div>
    <div id="reviewList" class="h-[320px] overflow-y-auto scroller p-5 bg-[#fafafa]"></div>
    <div class="p-4 bg-white border-t flex flex-col gap-3">
        <input type="hidden" id="editReviewId">
        <div class="star-rating" id="starRating">
            <input type="radio" id="5-stars" name="rating" value="5" /><label for="5-stars">â˜…</label>
            <input type="radio" id="4-stars" name="rating" value="4" /><label for="4-stars">â˜…</label>
            <input type="radio" id="3-stars" name="rating" value="3" /><label for="3-stars">â˜…</label>
            <input type="radio" id="2-stars" name="rating" value="2" /><label for="2-stars">â˜…</label>
            <input type="radio" id="1-stars" name="rating" value="1" /><label for="1-stars">â˜…</label>
        </div>
        <textarea id="reviewInput" class="w-full h-20 p-3 border border-gray-200 rounded-xl outline-none resize-none text-sm font-semibold" placeholder="ë¦¬ë·°ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”!"></textarea>
        <div class="flex gap-2">
            <button id="btnDelete" class="hidden w-1/3 bg-gray-200 text-gray-500 py-3 rounded-xl font-black italic transition-all active:scale-95">DELETE</button>
            <button id="submitReview" class="flex-1 bg-[#FF8A5B] text-white py-3 rounded-xl font-black italic shadow-md transition-all active:scale-95">POST REVIEW</button>
        </div>
    </div>
</div>

<footer th:replace="~{fragments/footer :: footerFragment}"></footer>

<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=24546b16104e0273c6d8c5c4cc508b44&libraries=services"></script>

<script th:inline="javascript">
    var map = new kakao.maps.Map(document.getElementById('map'), { center: new kakao.maps.LatLng(37.4980, 127.0276), level: 3 });
    var ps = new kakao.maps.services.Places();
    var geocoder = new kakao.maps.services.Geocoder();
    var currentOverlays = [];
    var areaData = {}, foodData = {};
    let currentSelection = { sido: null, sigugun: null, dong: null, foodName: null };
    let activePlaceId = null;
    const currentLoginUser = /*[[${#authentication.name}]]*/ 'guest';
    const keywordInput = document.getElementById('keywordInput');
const btnSearch = document.getElementById('btnSearch');

    const overlay = document.getElementById('overlay');
    const modalArea = document.getElementById('modal-area');
    const modalFood = document.getElementById('modal-food');
    const modalReview = document.getElementById('modal-review');
    const hoverTooltip = new kakao.maps.CustomOverlay({ zIndex: 10, yAnchor: 2.2 });

    function closeAll() { [overlay, modalArea, modalFood, modalReview].forEach(m => m.style.display = 'none'); }
    document.getElementById('btn-area-open').onclick = () => { overlay.style.display = 'block'; modalArea.style.display = 'block'; loadAreaData(); };
    document.getElementById('btn-food-open').onclick = () => { overlay.style.display = 'block'; modalFood.style.display = 'block'; loadFoodData(); };
    overlay.onclick = closeAll;

    // ë¡œê·¸ì¸ ì²´í¬ ê³µí†µ í•¨ìˆ˜
    function checkLogin() {
        if (currentLoginUser === 'anonymousUser' || currentLoginUser === 'guest') {
            if (confirm("ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤. ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                location.href = "/users/login";
            }
            return false;
        }
        return true;
    }

    async function handleView(id, url) {
        try { await fetch(`/hotplace/view/${id}`, { method: 'POST' }); window.open(url, '_blank'); updateStats(id); } catch (e) { window.open(url, '_blank'); }
    }

    async function handleHeart(id, event) {
    event.stopPropagation();
    const btn = event.currentTarget;

    // [ìˆ˜ì •] í´ë¦­í•˜ìë§ˆì ë¬´ì¡°ê±´ ì• ë‹ˆë©”ì´ì…˜ ì‹¤í–‰ (ë¡œê·¸ì¸ ì—¬ë¶€/ì·¨ì†Œ ì—¬ë¶€ ìƒê´€ì—†ìŒ)
    btn.classList.add('animate');
    setTimeout(() => btn.classList.remove('animate'), 400);

    // 1. ë¡œê·¸ì¸ ì²´í¬ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
    if (!checkLogin()) return;

    // 2. ì„œë²„ í†µì‹ 
    const res = await fetch(`/hotplace/heart/${id}`, { method: 'POST' });

    if (res.ok) {
        // ì„œë²„ ì²˜ë¦¬ê°€ ì„±ê³µí•˜ë©´ í•˜íŠ¸ ìƒ‰ìƒ(liked í´ë˜ìŠ¤)ë§Œ í† ê¸€
        btn.classList.toggle('liked');
        updateStats(id);
    }
}

    async function openReviewModal(id, event) {
        if(event) event.stopPropagation();
        activePlaceId = id; resetReviewForm();
        overlay.style.display = 'block'; modalReview.style.display = 'block'; loadReviews(id);
    }

    async function loadReviews(id) {
        const res = await fetch(`/hotplace/reviews/${id}`);
        const reviews = await res.json();
        const listEl = document.getElementById('reviewList');
        listEl.innerHTML = reviews.length > 0
            ? reviews.map(r => `
                <div class="review-card shadow-sm">
                    <div class="review-user">@${r.userId}</div>
                    <div class="review-text">${r.content}</div>
                    ${r.userId === currentLoginUser ? `<span class="edit-label" onclick="setEditMode('${r.reviewId}', '${r.content}', '${r.rating}')">EDIT</span>` : ''}
                </div>`).join('')
            : '<div class="h-full flex items-center justify-center text-gray-400 font-black italic">ì²« ë¦¬ë·°ë¥¼ ë‚¨ê²¨ë³´ì„¸ìš”!</div>';
    }

    function resetReviewForm() {
        document.getElementById('editReviewId').value = ''; document.getElementById('reviewInput').value = '';
        document.getElementById('submitReview').innerText = "POST REVIEW"; document.getElementById('btnDelete').classList.add('hidden');
        document.querySelectorAll('input[name="rating"]').forEach(el => el.checked = false);
    }

    // ê¸°ì¡´ í•¨ìˆ˜ë¥¼ ì•„ë˜ ë‚´ìš©ìœ¼ë¡œ êµì²´
function setEditMode(reviewId, content, rating) {
    document.getElementById('editReviewId').value = reviewId;
    document.getElementById('reviewInput').value = content;
    document.getElementById('submitReview').innerText = "UPDATE";
    document.getElementById('btnDelete').classList.remove('hidden');

const starId = Number(rating) + "-stars";
    const ratingBtn = document.getElementById(starId);

    if(ratingBtn) {
        ratingBtn.checked = true;
    }

    document.getElementById('reviewInput').focus();
}
    document.getElementById('submitReview').onclick = async () => {
        if (!checkLogin()) return;
        const content = document.getElementById('reviewInput').value;
        const reviewId = document.getElementById('editReviewId').value;
        const rating = document.querySelector('input[name="rating"]:checked')?.value || 0;

        if(!content.trim() || rating === 0) { alert("ë‚´ìš©ê³¼ í‰ì ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”!"); return; }

        const url = reviewId ? `/hotplace/reviews/update/${reviewId}` : `/hotplace/reviews/${activePlaceId}`;
        const res = await fetch(url, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ content, rating })
        });

        if (res.status === 403) { alert("ë³¸ì¸ì´ ì‘ì„±í•œ ë¦¬ë·°ë§Œ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."); return; }
        if (res.ok) { resetReviewForm(); await loadReviews(activePlaceId); updateStats(activePlaceId); }
    };

    document.getElementById('btnDelete').onclick = async () => {
        if (!checkLogin()) return;
        const reviewId = document.getElementById('editReviewId').value;
        if (!reviewId || !confirm("ì´ ë¦¬ë·°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        const res = await fetch(`/hotplace/reviews/delete/${reviewId}`, { method: 'POST' });
        if (res.ok) { resetReviewForm(); loadReviews(activePlaceId); updateStats(activePlaceId); }
    };

    async function updateStats(id) {
        const res = await fetch('/hotplace/stats', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify([id.toString()]) });
        const data = await res.json();
        if(data.length > 0) {
            const s = data[0];
            document.querySelectorAll(`[id^="avg-rating-${id}"]`).forEach(el => el.innerText = s.avgRating || 0);
            document.querySelectorAll(`[id^="view-count-${id}"]`).forEach(el => el.innerText = s.viewCount);
            document.querySelectorAll(`[id^="heart-count-${id}"]`).forEach(el => el.innerText = s.heartCount);
            document.querySelectorAll(`[id^="review-count-${id}"]`).forEach(el => el.innerText = s.reviewCount);
            currentOverlays.forEach(o => { if (o.placeId === id) o.stats = s; });
        }
    }

    function createCustomPin(position, place, stats) {
        const content = document.createElement('div'); content.className = 'custom-pin';
        const pinOverlay = new kakao.maps.CustomOverlay({ position: position, content: content, yAnchor: 1.1 });
        pinOverlay.placeId = place.id; pinOverlay.stats = stats;
        content.onmouseover = () => {
            const s = pinOverlay.stats;
            const tooltipContent = `<div class="pin-tooltip"><div class="mb-2 text-[15px] font-black border-b pb-1">${place.place_name}</div><div class="flex gap-4 text-[13px] text-orange-500 font-bold italic items-center"><span class="flex items-center gap-1.5">â­ <span>${s.avgRating || 0}</span></span><span class="flex items-center gap-1.5">ğŸ‘ï¸ <span>${s.viewCount}</span></span><span class="flex items-center gap-1.5">â¤ï¸ <span>${s.heartCount}</span></span><span class="flex items-center gap-1.5">ğŸ“ <span>${s.reviewCount}</span></span></div></div>`;
            hoverTooltip.setContent(tooltipContent); hoverTooltip.setPosition(position); hoverTooltip.setMap(map);
        };
        content.onmouseout = () => hoverTooltip.setMap(null);
        content.onclick = () => handleView(place.id, place.place_url);
        pinOverlay.setMap(map); currentOverlays.push(pinOverlay);
    }

    async function renderPlaces(data, status) {
        currentOverlays.forEach(o => o.setMap(null)); currentOverlays = [];
        const listEl = document.getElementById('placesList'); listEl.innerHTML = '';
        if (status === kakao.maps.services.Status.OK) {
            const statsRes = await fetch('/hotplace/stats', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data.map(p => p.id)) });
            const statsList = await statsRes.json();
            const statsMap = {}; statsList.forEach(s => statsMap[s.kakaoPlaceId] = s);
            data.forEach(place => {
                const pos = new kakao.maps.LatLng(place.y, place.x);
                const stats = statsMap[place.id] || { viewCount:0, heartCount: 0, reviewCount: 0, liked: false, avgRating: 0 };
                createCustomPin(pos, place, stats);
                const item = document.createElement('div'); item.className = 'place-item';
                item.innerHTML = `
                    <h4 class="font-black text-gray-800 text-xl mb-1 italic">${place.place_name}</h4>
                    <div class="flex gap-4 mb-2 text-[13px] font-bold text-orange-400 italic items-center">
                        <span class="flex items-center gap-1.5">â­ <span id="avg-rating-${place.id}" class="text-gray-700">${stats.avgRating || 0}</span></span>
                        <span class="flex items-center gap-1.5">ğŸ‘ï¸ <span id="view-count-${place.id}" class="text-gray-700">${stats.viewCount}</span></span>
                        <button onclick="handleHeart('${place.id}', event)" class="ani-btn ${stats.liked ? 'liked' : ''}">â¤ <span id="heart-count-${place.id}" class="heart-count-text">${stats.heartCount}</span></button>
                        <div class="flex items-center gap-1">
                            <span class="flex items-center gap-1.5">ğŸ“ <span id="review-count-${place.id}" class="text-gray-700">${stats.reviewCount}</span></span>
                            <button onclick="openReviewModal('${place.id}', event)" class="px-2 py-0.5 bg-orange-100 text-[#FF8A5B] rounded-md text-[10px] hover:bg-[#FF8A5B] hover:text-white transition-all">WRITE</button>
                        </div>
                    </div>
                    <p class="text-[13px] text-gray-400 font-bold italic">${place.address_name}</p>
                    <button onclick="handleView('${place.id}', '${place.place_url}')" class="info-btn">INFO</button>
                `;
                item.onclick = (e) => { if(!e.target.closest('button')) map.panTo(pos); };
                listEl.appendChild(item);
            });
        }
    }

    async function loadAreaData() { if (Object.keys(areaData).length) return; const res = await fetch('/Korea_city_List.json'); areaData = await res.json(); renderSido(); }
    function renderSido() {
        const list = document.getElementById('sidoList'); list.innerHTML = '';
        Object.keys(areaData).forEach(sido => {
            const li = document.createElement('li'); li.className = "p-3 cursor-pointer hover:bg-orange-50 rounded-lg font-bold";
            li.innerText = sido;
            li.onclick = () => { resetActive('sidoList'); li.classList.add('active-item'); currentSelection.sido = sido; renderSigugun(sido); };
            list.appendChild(li);
        });
    }
    function renderSigugun(sido) {
        const list = document.getElementById('sigugunList'); list.innerHTML = '';
        Object.keys(areaData[sido]).forEach(sigu => {
            const li = document.createElement('li'); li.className = "p-3 cursor-pointer hover:bg-orange-50 rounded-lg font-bold";
            li.innerText = sigu;
            li.onclick = () => { resetActive('sigugunList'); li.classList.add('active-item'); currentSelection.sigugun = sigu; renderDong(sido, sigu); };
            list.appendChild(li);
        });
    }
    function renderDong(sido, sigu) {
        const list = document.getElementById('dongList'); list.innerHTML = '';
        areaData[sido][sigu].forEach(dong => {
            const li = document.createElement('li'); li.className = "p-3 cursor-pointer hover:bg-orange-50 rounded-lg font-bold";
            li.innerText = dong;
            li.onclick = () => { currentSelection.dong = dong; document.getElementById('display-area').innerText = `${sido} ${sigu} ${dong}`; closeAll(); updateSearch(); };
            list.appendChild(li);
        });
    }
    async function loadFoodData() { if (Object.keys(foodData).length) return; const res = await fetch('/Food_List.json'); foodData = await res.json(); renderFoodCategory(); }
    function renderFoodCategory() {
        const list = document.getElementById('foodCategoryList'); list.innerHTML = '';
        Object.keys(foodData).forEach(cat => {
            const li = document.createElement('li'); li.className = "p-3 cursor-pointer hover:bg-orange-50 rounded-lg font-bold";
            li.innerText = cat;
            li.onclick = () => { resetActive('foodCategoryList'); li.classList.add('active-item'); renderFoodNames(cat); };
            list.appendChild(li);
        });
    }
    function renderFoodNames(cat) {
        const list = document.getElementById('foodNameList'); list.innerHTML = '';
        foodData[cat].forEach(food => {
            const li = document.createElement('li'); li.className = "p-3 cursor-pointer hover:bg-orange-50 rounded-lg font-bold";
            li.innerText = food.name;
            li.onclick = () => { currentSelection.foodName = food.name; document.getElementById('display-food').innerText = food.name; closeAll(); updateSearch(); };
            list.appendChild(li);
        });
    }
 // [ìˆ˜ì •ëœ ë¶€ë¶„] ê¸°ì¡´ ê¸°ëŠ¥ + ê²€ìƒ‰ì°½ í†µí•© í•¨ìˆ˜
    function updateSearch() {
        let keyword = "";

        // 1. ì„ íƒëœ ì§€ì—­ ì •ë³´ ì¡°í•©
        if (currentSelection.dong) {
            keyword += `${currentSelection.sido} ${currentSelection.sigugun} ${currentSelection.dong} `;
        }

        // 2. ì„ íƒëœ ìŒì‹ ì¹´í…Œê³ ë¦¬ ì¡°í•©
        if (currentSelection.foodName) {
            keyword += `${currentSelection.foodName} `;
        }

        // 3. ê²€ìƒ‰ì°½ ì…ë ¥ê°’ ì¡°í•©
        const userKeyword = keywordInput.value.trim();
        if (userKeyword) {
            keyword += userKeyword;
        }

        // í•„í„°ë‚˜ ê²€ìƒ‰ì–´ê°€ ì•„ë¬´ê²ƒë„ ì—†ìœ¼ë©´ 'ë§›ì§‘'ìœ¼ë¡œ ê¸°ë³¸ ê²€ìƒ‰
        if (!keyword.trim()) {
            ps.keywordSearch('ë§›ì§‘', renderPlaces);
            return;
        }

        // ì§€ë„ ì´ë™ ë° ê²€ìƒ‰ ì‹¤í–‰
        if (currentSelection.dong) {
            geocoder.addressSearch(`${currentSelection.sido} ${currentSelection.sigugun} ${currentSelection.dong}`, (result, status) => {
                if (status === kakao.maps.services.Status.OK) {
                    map.setCenter(new kakao.maps.LatLng(result[0].y, result[0].x));
                    ps.keywordSearch(keyword, renderPlaces);
                }
            });
        } else {
            // ì§€ì—­ ì„ íƒì´ ì—†ëŠ” ê²½ìš° í˜„ì¬ ì§€ë„ ìœ„ì¹˜ ê¸°ì¤€ìœ¼ë¡œ í‚¤ì›Œë“œ ê²€ìƒ‰
            ps.keywordSearch(keyword, renderPlaces);
        }
    }

    function resetActive(id) {
        const list = document.getElementById(id);
        if (list) Array.from(list.children).forEach(li => li.classList.remove('active-item'));
    }

    // ì´ˆê¸° ë¡œë”© ë° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
    window.onload = () => {
        ps.keywordSearch('ë§›ì§‘', renderPlaces);
    };

    // ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
    btnSearch.onclick = () => updateSearch();

    // ê²€ìƒ‰ì°½ì—ì„œ Enterí‚¤ ì…ë ¥ ì´ë²¤íŠ¸
    keywordInput.onkeypress = (e) => {
        if (e.key === 'Enter') {
            updateSearch();
        }
    };
</script>
</script>
</body>
</html>