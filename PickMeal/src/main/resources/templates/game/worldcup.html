<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Pick Meal - ì›”ë“œì»µ ì§„í–‰ì¤‘</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@700;800&display=swap" rel="stylesheet">
    <style>
        /* [2] ê¸°ë³¸ ì„¤ì •: ë¡œê·¸ì¸/ì„¤ì •ì°½ê³¼ í†µì¼ */
        body {
            font-family: 'Fredoka', sans-serif;
            background-color: #FFF5F0;
            margin: 0;
            overflow-x: hidden;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* ìŒì‹ ì¹´ë“œ ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼ */
        .food-card {
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .food-card:hover {
            transform: translateY(-15px) scale(1.02);
            box-shadow: 0 25px 50px -12px rgba(255, 138, 91, 0.3);
        }

        /* ëŒ€ê²° ì• ë‹ˆë©”ì´ì…˜ í´ë˜ìŠ¤ */
        .selected-left {
            transform: translateX(250px) scale(1.1) rotate(5deg) !important;
            opacity: 0;
            pointer-events: none;
        }
        .selected-right {
            transform: translateX(-250px) scale(1.1) rotate(-5deg) !important;
            opacity: 0;
            pointer-events: none;
        }

        /* VS í…ìŠ¤íŠ¸ ê·¸ë¦¼ì */
        .vs-badge {
            text-shadow: 3px 3px 0px rgba(255, 138, 91, 0.15);
        }

        /* [ë¹„ìœ ] íƒˆë½í•œ ì¹´ë“œëŠ” ì—°ê¸°ì²˜ëŸ¼ ì‚¬ë¼ì§€ë©° ìë¦¬(ê³µê°„)ë„ ì°¨ì§€í•˜ì§€ ì•Šê²Œ ë©ë‹ˆë‹¤. */
        .eliminated {
        opacity: 0;
        transform: scale(0.5); /* ì‘ì•„ì§€ë©´ì„œ ì‚¬ë¼ì§€ëŠ” íš¨ê³¼ */
        display: none;        /* [í•µì‹¬] í™”ë©´ êµ¬ì„±ì—ì„œ ì•„ì˜ˆ ì œì™¸ì‹œì¼œ ê³µê°„ì„ ì§€ì›ë‹ˆë‹¤. */
        transition: all 0.4s ease;
    }
    </style>
</head>
<body>
<header th:replace="~{fragments/header :: headerFragment}"></header>
<main>
<div class="text-center mt-12 mb-8">
    <h1 id="roundTitle" class="text-6xl font-black text-[#FF8A5B] italic mb-2 uppercase tracking-tighter" th:text="${totalRound} + 'ê°•'">ë¼ìš´ë“œ</h1>
    <div id="matchStatus" class="text-gray-400 font-bold italic text-xl">ê²½ê¸°ì§„í–‰ ì •ë³´</div>
</div>

<div class="match-container flex flex-col md:flex-row items-center justify-center gap-10 md:gap-20 w-full max-w-6xl px-4">
    <div class="food-card bg-white p-6 rounded-[3.5rem] shadow-xl w-full max-w-sm text-center border-4 border-transparent hover:border-[#FF8A5B] cursor-pointer" id="cardA" onclick="selectFood(0)">
        <div class="overflow-hidden rounded-[2.5rem] mb-6 h-80 shadow-inner">
            <img id="imgA" th:src="${foods[0].imagePath}" class="w-full h-full object-cover">
        </div>
        <div class="bg-[#FFF5F0] py-4 rounded-2xl">
            <span id="nameA" class="text-2xl font-black text-gray-700 italic" th:text="${foods[0].foodName}">ìŒì‹ì´ë¦„A</span>
        </div>
    </div>

    <div class="vs-badge text-6xl md:text-8xl font-black text-[#FF8A5B] italic tracking-tighter">VS</div>

    <div class="food-card bg-white p-6 rounded-[3.5rem] shadow-xl w-full max-w-sm text-center border-4 border-transparent hover:border-[#FF8A5B] cursor-pointer" id="cardB" onclick="selectFood(1)">
        <div class="overflow-hidden rounded-[2.5rem] mb-6 h-80 shadow-inner">
            <img id="imgB" th:src="${foods[1].imagePath}" class="w-full h-full object-cover">
        </div>
        <div class="bg-[#FFF5F0] py-4 rounded-2xl">
            <span id="nameB" class="text-2xl font-black text-gray-700 italic" th:text="${foods[1].foodName}">ìŒì‹ì´ë¦„B</span>
        </div>
    </div>
</div>
</main>
<footer th:replace="~{fragments/footer :: footerFragment}"></footer>
<script th:inline="javascript">
    // [1] ë°ì´í„° ì´ˆê¸°í™”
    let foods = [[${foods}]];
    let winners = [];
    let currentIndex = 0;
    let currentRoundTotal = [[${totalRound}]];

    // [2] í™”ë©´ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (ì´ë¯¸ì§€, ë¼ìš´ë“œ í…ìŠ¤íŠ¸ ê°±ì‹ )
    function updateUI() {
        if (!foods[currentIndex] || !foods[currentIndex + 1]) return;

        let titleText = currentRoundTotal + "ê°•";
        if (currentRoundTotal === 2) titleText = "FINAL ğŸ†";
        document.getElementById('roundTitle').innerText = titleText;

        const currentMatch = (currentIndex / 2) + 1;
        const totalMatches = currentRoundTotal / 2;
        document.getElementById('matchStatus').innerText = `MATCH: ${currentMatch} / ${totalMatches}`;

        document.getElementById('imgA').src = foods[currentIndex].imagePath;
        document.getElementById('nameA').innerText = foods[currentIndex].foodName;
        document.getElementById('imgB').src = foods[currentIndex + 1].imagePath;
        document.getElementById('nameB').innerText = foods[currentIndex + 1].foodName;

        document.getElementById('cardA').classList.remove('selected-left');
        document.getElementById('cardB').classList.remove('selected-right');
        document.getElementById('cardA').style.opacity = "1";
        document.getElementById('cardB').style.opacity = "1";
        document.getElementById('cardA').style.pointerEvents = "auto";
        document.getElementById('cardB').style.pointerEvents = "auto";
    }

    // [3] ìŒì‹ ì„ íƒ í•¨ìˆ˜ (í´ë¦­ ì´ë²¤íŠ¸)
    function selectFood(offset) {
        const selectedCard = (offset === 0) ? document.getElementById('cardA') : document.getElementById('cardB');
        const rejectedCard = (offset === 0) ? document.getElementById('cardB') : document.getElementById('cardA');

        if(offset === 0) selectedCard.classList.add('selected-left');
        else selectedCard.classList.add('selected-right');

        rejectedCard.style.opacity = "0";
        rejectedCard.style.transition = "all 0.4s ease";
        rejectedCard.style.pointerEvents = "none";

        setTimeout(() => {
            winners.push(foods[currentIndex + offset]);
            currentIndex += 2;

            if (currentIndex >= foods.length) {
                if (winners.length === 1) {
                    const winnerFood = winners[0];
                    const foodIdForServer = winnerFood.foodId;

                    fetch('/worldcup/win/' + foodIdForServer, { method: 'POST' })
                    .then(response => {
                        alert(`ğŸ† ì¶•í•˜í•©ë‹ˆë‹¤! \nì¹˜ì—´í•œ ëŒ€ê²° ëì— '${winnerFood.foodName}'ì´(ê°€) ìµœì¢… ìš°ìŠ¹í–ˆìŠµë‹ˆë‹¤!`);
                        showWinnerEffect(winnerFood);
                    })
                    .catch(err => {
                        console.error("ê¸°ë¡ ì‹¤íŒ¨:", err);
                        showWinnerEffect(winnerFood);
                    });
                    return;
                }

                let nextRoundNum = winners.length;
                let nextRoundText = nextRoundNum === 2 ? "ê²°ìŠ¹(FINAL)" : nextRoundNum + "ê°•";
                alert(`ğŸŠ ${currentRoundTotal}ê°• ê²½ê¸°ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! \n${nextRoundText}ìœ¼ë¡œ ì§„ì¶œí•©ë‹ˆë‹¤!`);

                foods = winners;
                winners = [];
                currentIndex = 0;
                currentRoundTotal = foods.length;
            }
            updateUI();
        }, 500);
    }

    // [4] í´ë¦½ë³´ë“œ ë³µì‚¬ í•¨ìˆ˜ (ë…ë¦½ì ìœ¼ë¡œ ì„ ì–¸)
    // worldcup.htmlì˜ ìŠ¤í¬ë¦½íŠ¸ ìˆ˜ì •
    window.copyToClipboard = function(foodName) {
    // [ë¹„ìœ ] ë­í‚¹ ì£¼ì†Œë§Œ ë³´ë‚´ëŠ” ê²Œ ì•„ë‹ˆë¼, ë‚´ê°€ ë½‘ì€ ìš°ìŠ¹ì ì´ë¦„ë„ í•¨ê»˜ ì ì–´ ë³´ëƒ…ë‹ˆë‹¤.
    const currentUrl = window.location.origin + "/worldcup/ranking";
    const textToCopy = `ğŸ† Pick Meal ì›”ë“œì»µ ìµœì¢… ìš°ìŠ¹! ğŸ†\nì˜¤ëŠ˜ ì œê°€ ì„ íƒí•œ ë©”ë‰´ëŠ” '${foodName}'ì…ë‹ˆë‹¤!\n\nì „ì²´ ë­í‚¹ í™•ì¸í•˜ê¸° ğŸ‘‡\n${currentUrl}`;

    navigator.clipboard.writeText(textToCopy).then(() => {
        alert(`âœ¨ '${foodName}' ìš°ìŠ¹ì„ ì¶•í•˜í•©ë‹ˆë‹¤!\n\n1. ë­í‚¹ ì£¼ì†Œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.\n2. í˜„ì¬ ìš°ìŠ¹ í™”ë©´ì„ ìº¡ì²˜í•´ì„œ ì¹œêµ¬ì—ê²Œ ë³´ë‚´ë³´ì„¸ìš”! ğŸ“¸`);
    });
};

    // [5] ìš°ìŠ¹ íš¨ê³¼ í•¨ìˆ˜
    function showWinnerEffect(winner) {
        const body = document.querySelector('body');
        body.innerHTML = `
        <div class="flex flex-col items-center justify-center min-h-screen p-6 text-center">
            <div class="mb-6">
                <h2 class="text-[#FF8A5B] font-black text-3xl mb-2 animate-bounce">ğŸ† CHAMPION ğŸ†</h2>
            </div>
            <div class="bg-white p-8 rounded-[4rem] shadow-2xl border-4 border-[#FF8A5B] max-w-md w-full">
                <div class="overflow-hidden rounded-[3rem] mb-6 h-80 shadow-md">
                    <img src="${winner.imagePath}" class="w-full h-full object-cover">
                </div>
                <h1 class="text-5xl font-black text-gray-800 italic mb-2">${winner.foodName}</h1>
                <div class="grid grid-cols-2 gap-3 mb-6">
                    <button onclick="location.href='/game'" class="py-3 bg-gray-100 rounded-2xl font-bold">HOME ğŸ </button>
                    <button onclick="location.href='/worldcup/setup'" class="py-3 bg-gray-100 rounded-2xl font-bold">RESTART ğŸ”„</button>
                    <button onclick="location.href='/worldcup/ranking'" class="py-3 bg-gray-100 rounded-2xl font-bold">RANK ğŸ†</button>
                    <button onclick="window.copyToClipboard('${winner.foodName}')" class="py-3 bg-gray-100 rounded-2xl font-bold">SHARE ğŸ”—</button>
                </div>
                <button onclick="window.open('https://map.kakao.com/link/search/' + encodeURIComponent('${winner.foodName}'))"
                        class="w-full py-5 bg-[#FAE100] rounded-full font-black text-xl">
                    ì£¼ë³€ ë§›ì§‘ ì°¾ê¸° ğŸ“
                </button>
            </div>
        </div>
        `;
        setTimeout(() => {
            if (typeof confetti === 'function') {
                confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, zIndex: 9999 });
            }
        }, 100);
    }

    // [6] ë§ˆì§€ë§‰: ê²Œì„ ì‹œì‘!
    updateUI();
</script>

</body>
</html>