<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pick Meal - ì›”ë“œì»µ ì§„í–‰ì¤‘</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@700;800&display=swap" rel="stylesheet">
    <style>
        /* [ë ˆì´ì•„ì›ƒ] ë£°ë ›ì°½ ê¸°ë°˜ ê³ ì • êµ¬ì¡° */
        body {
            font-family: 'Fredoka', sans-serif;
            background-color: #FFF5F0;
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        .nav-link {
            font-family: 'Fredoka', sans-serif !important;
            font-weight: 700 !important;
            font-style: italic !important;
        }

        main {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding-top: 80px;
            box-sizing: border-box;
            position: relative;
        }

        .food-card {
            background: white;
            border-radius: 3rem;
            transition: all 0.5s ease;
            cursor: pointer;
            border: 4px solid transparent;
        }

        /* í˜¸ë²„ ì‹œ í”ë“¤ë¦¼ ì œì™¸, ì‚´ì§ ìœ„ë¡œë§Œ ì´ë™ */
        .food-card:hover {
            border-color: #FF8A5B;
            transform: translateY(-10px);
            box-shadow: 0 20px 40px rgba(255, 138, 91, 0.2);
        }

        /* [í•µì‹¬ ìˆ˜ì •] ì„ íƒëœ ì¹´ë“œê°€ ê°€ìš´ë°ë¡œ ì˜¤ëŠ” ì• ë‹ˆë©”ì´ì…˜ (ê¸°ìš¸ê¸° ì œê±° ë° ì†ë„ ë™ê¸°í™”) */
        .selected-left {
            /* íšŒì „(rotate)ì„ 0degë¡œ ê³ ì •í•˜ì—¬ ê¸°ìš¸ì´ì§€ ì•ŠìŒ */
            transform: translateX(250px) scale(1.05) rotate(0deg) !important;
            opacity: 0;
            pointer-events: none;
            /* ì†ë„ë¥¼ 1.2ì´ˆë¡œ ì•„ì£¼ ì²œì²œíˆ ì„¤ì • */
            transition: all 1.2s cubic-bezier(0.4, 0, 0.2, 1) !important;
        }

        .selected-right {
            transform: translateX(-250px) scale(1.05) rotate(0deg) !important;
            opacity: 0;
            pointer-events: none;
            transition: all 1.2s cubic-bezier(0.4, 0, 0.2, 1) !important;
        }

        /* [í•µì‹¬ ìˆ˜ì •] ìƒëŒ€í¸ ì¹´ë“œ ì‚¬ë¼ì§€ëŠ” ì†ë„ë„ 1.2ì´ˆë¡œ ì™„ë²½ ë™ê¸°í™” */
        .fade-out {
            opacity: 0 !important;
            transform: scale(0.8) !important;
            pointer-events: none;
            transition: all 1.2s cubic-bezier(0.4, 0, 0.2, 1) !important;
        }

        .vs-badge { text-shadow: 3px 3px 0px rgba(255, 138, 91, 0.15); font-style: italic; }

        /* ìš°ìŠ¹ì°½ ì¤‘ê°„ ì‚¬ì´ì¦ˆ ìµœì í™” */
        .winner-card-mid {
            max-width: 410px !important;
            padding: 2rem !important;
            border-radius: 3.5rem !important;
        }
        .winner-img-mid {
            height: 280px !important;
            border-radius: 2.5rem !important;
        }
    </style>
</head>
<body>

<header th:replace="~{fragments/header :: headerFragment}"></header>

<main class="px-10" id="game-main">
    <div class="text-center mb-10">
        <h1 id="roundTitle" class="text-6xl font-black text-[#FF8A5B] italic uppercase tracking-tighter mb-2" th:text="${totalRound} + 'ê°•'">ë¼ìš´ë“œ</h1>
        <p class="text-[#FF8A5B] font-bold italic uppercase text-xl">Which one will win?</p>
    </div>

    <div class="flex items-center justify-center gap-10 md:gap-20 w-full max-w-6xl">
        <div class="food-card p-6 shadow-xl w-full max-w-sm text-center" id="cardA" onclick="selectFood(0)">
            <div class="bg-[#FFF5F0] rounded-[2.5rem] overflow-hidden mb-6 h-72 shadow-inner">
                <img id="imgA" th:src="${foods[0].imagePath}" class="w-full h-full object-cover">
            </div>
            <h3 id="nameA" class="text-2xl font-black text-gray-800 italic uppercase" th:text="${foods[0].foodName}">ìŒì‹A</h3>
        </div>

        <div class="vs-badge text-7xl font-black text-[#FF8A5B]" id="vs-text">VS</div>

        <div class="food-card p-6 shadow-xl w-full max-w-sm text-center" id="cardB" onclick="selectFood(1)">
            <div class="bg-[#FFF5F0] rounded-[2rem] overflow-hidden mb-6 h-72 shadow-inner">
                <img id="imgB" th:src="${foods[1].imagePath}" class="w-full h-full object-cover">
            </div>
            <h3 id="nameB" class="text-2xl font-black text-gray-800 italic uppercase" th:text="${foods[1].foodName}">ìŒì‹B</h3>
        </div>
    </div>
</main>

<footer th:replace="~{fragments/footer :: footerFragment}"></footer>

<script th:inline="javascript">
    let foods = [[${foods}]];
    let winners = [];
    let currentIndex = 0;
    let currentRoundTotal = [[${totalRound}]];

    function updateUI() {
        if (!foods[currentIndex] || !foods[currentIndex + 1]) return;

        document.getElementById('roundTitle').innerText = currentRoundTotal === 2 ? "FINAL" : currentRoundTotal + "ê°•";
        document.getElementById('imgA').src = foods[currentIndex].imagePath;
        document.getElementById('nameA').innerText = foods[currentIndex].foodName;
        document.getElementById('imgB').src = foods[currentIndex + 1].imagePath;
        document.getElementById('nameB').innerText = foods[currentIndex + 1].foodName;

        const cardA = document.getElementById('cardA');
        const cardB = document.getElementById('cardB');
        const vsText = document.getElementById('vs-text');

        cardA.classList.remove('selected-left', 'fade-out');
        cardB.classList.remove('selected-right', 'fade-out');
        vsText.style.opacity = "1";

        cardA.style.opacity = "1";
        cardB.style.opacity = "1";
        cardA.style.pointerEvents = "auto";
        cardB.style.pointerEvents = "auto";
    }

    function selectFood(offset) {
        const cardA = document.getElementById('cardA');
        const cardB = document.getElementById('cardB');
        const vsText = document.getElementById('vs-text');

        vsText.style.opacity = "0";
        vsText.style.transition = "opacity 1.2s ease";

        if (offset === 0) {
            cardA.classList.add('selected-left');
            cardB.classList.add('fade-out');
        } else {
            cardB.classList.add('selected-right');
            cardA.classList.add('fade-out');
        }

        // ì• ë‹ˆë©”ì´ì…˜ ì†ë„(1.2ì´ˆ)ì— ë§ì¶° ì—¬ìœ ìˆê²Œ 1.3ì´ˆ í›„ ë‹¤ìŒ UIë¡œ ì „í™˜
        setTimeout(() => {
            winners.push(foods[currentIndex + offset]);
            currentIndex += 2;

            if (currentIndex >= foods.length) {
                if (winners.length === 1) {
                    showWinnerEffect(winners[0]);
                    return;
                }
                foods = winners;
                winners = [];
                currentIndex = 0;
                currentRoundTotal = foods.length;
            }
            updateUI();
        }, 1300);
    }

    function showWinnerEffect(winner) {
        fetch('/worldcup/win/' + winner.foodId, { method: 'POST' }).catch(e => {});

        const main = document.getElementById('game-main');
        main.style.paddingTop = "90px";

        main.innerHTML = `
            <div class="flex flex-col items-center justify-center w-full animate-bounce mb-2">
                <h2 class="text-[#FF8A5B] font-black text-5xl uppercase italic tracking-tighter">WINNER</h2>
            </div>
            <div class="bg-white winner-card-mid shadow-2xl border-4 border-[#FF8A5B] w-full text-center">
                <div class="overflow-hidden winner-img-mid mb-6 shadow-md">
                    <img src="${winner.imagePath}" class="w-full h-full object-cover">
                </div>
                <h1 class="text-4xl font-black text-gray-800 italic mb-6 uppercase tracking-tighter">${winner.foodName}</h1>
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <button onclick="location.href='/game'" class="py-3 bg-gray-100 rounded-2xl font-bold italic uppercase text-sm hover:bg-gray-200 transition">HOME ğŸ </button>
                    <button onclick="location.href='/worldcup/setup'" class="py-3 bg-gray-100 rounded-2xl font-bold italic uppercase text-sm hover:bg-gray-200 transition">RESTART ğŸ”„</button>
                    <button onclick="location.href='/worldcup/ranking'" class="py-3 bg-gray-100 rounded-2xl font-bold italic uppercase text-sm hover:bg-gray-200 transition">RANK ğŸ†</button>
                    <button onclick="copyToClipboard('${winner.foodName}')" class="py-3 bg-gray-100 rounded-2xl font-bold italic uppercase text-sm hover:bg-gray-200 transition">SHARE ğŸ”—</button>
                </div>
                <button onclick="window.open('https://map.kakao.com/link/search/' + encodeURIComponent('${winner.foodName}'))"
                        class="w-full py-4 bg-[#FAE100] rounded-full font-black text-lg shadow-md hover:bg-[#ebd300] transition italic">
                    ì£¼ë³€ ë§›ì§‘ ì°¾ê¸° ğŸ“
                </button>
            </div>
        `;
        confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, zIndex: 9999 });
    }

    window.copyToClipboard = function(foodName) {
        navigator.clipboard.writeText(`ğŸ† ë‚˜ì˜ ì›í”½ ë©”ë‰´: [${foodName}]`).then(() => alert("ë³µì‚¬ ì™„ë£Œ!"));
    };

    updateUI();
</script>
</body>
</html>