<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf?.token}" th:if="${_csrf}"/>
    <meta name="_csrf_header" th:content="${_csrf?.headerName}" th:if="${_csrf}"/>

    <title>Pick Meal - ìŠ¤ë¬´ê³ ê°œ ê²Œì„</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@700;800&display=swap" rel="stylesheet">

    <style>
        /* [ê³µí†µ] í°íŠ¸ ë° ë°°ê²½ ì„¤ì • - ê²Œì„ì›”ë“œì™€ í†µì¼ */
        body {
            font-family: 'Fredoka', sans-serif;
            background-color: #FFF5F0; /* ë°°ê²½ìƒ‰ í†µì¼ */
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            margin: 0;
            overflow-x: hidden;
        }

        /* [í•µì‹¬] í—¤ë” ë””ìì¸ ê³ ì • - í•«í”Œë ˆì´ìŠ¤ ë°©ì‹ ê·¸ëŒ€ë¡œ ê°•ì œ ê¸°ìš¸ê¸° ì ìš© */
        [data-custom-header] a,
        [data-custom-header] button,
        [data-custom-header] span,
        .custom-italic {
            font-family: 'Fredoka', sans-serif !important;
            font-weight: 800 !important;
            font-style: italic !important;
            display: inline-block !important;
        }

        main {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            padding: 100px 20px 40px; /* í—¤ë” ì—¬ë°± í™•ë³´ */
        }

        /* ìŠ¤ë¬´ê³ ê°œ ì»¨í…Œì´ë„ˆ ë””ìì¸ ì¡°ì ˆ */
        .container {
            background-color: #FFFDF0;
            border-radius: 2.5rem; /* ë‹¤ë¥¸ ì°½ë“¤ì˜ ì¹´ë“œ ê³¡ë¥ ê³¼ í†µì¼ */
            padding: 40px;
            box-shadow: 0 20px 50px rgba(255, 138, 91, 0.1);
            width: 100%;
            max-width: 600px;
            text-align: center;
            border: 4px solid #FF8A5B;
        }

        .header h1 {
            color: #FF8A5B;
            font-size: 3.5rem;
            margin-bottom: 30px;
            font-weight: 800;
            font-style: italic;
            letter-spacing: -2px;
        }

        .question-box {
            background-color: #FFF;
            border: 4px solid #FF8A5B;
            border-radius: 2rem;
            padding: 30px;
            font-size: 1.6em;
            color: #333;
            margin-bottom: 40px;
            position: relative;
            font-weight: 700;
        }

        /* ë§í’ì„  ê¼¬ë¦¬ ìƒ‰ìƒ ë³€ê²½ */
        .question-box::after {
            content: '';
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            border-top: 20px solid #FFF;
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
        }
        .question-box::before {
            content: '';
            position: absolute;
            bottom: -28px;
            left: 50%;
            transform: translateX(-50%);
            border-top: 28px solid #FF8A5B;
            border-left: 18px solid transparent;
            border-right: 18px solid transparent;
        }

        .buttons-box {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 40px;
        }

        /* ë²„íŠ¼ ë””ìì¸: ê²Œì„ì›”ë“œ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ê³„ìŠ¹ */
        .btn {
            color: white;
            border-radius: 50px;
            padding: 15px 45px;
            font-size: 1.5em;
            font-weight: 800;
            font-style: italic;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            box-shadow: 0 6px 0 rgba(0,0,0,0.1);
        }

        .btn.yes { background-color: #FF8A5B; }
        .btn.no { background-color: #4CAF50; }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(255, 138, 91, 0.2);
        }
        .btn:active { transform: translateY(2px); box-shadow: none; }

        .btn-icon { margin-right: 10px; font-size: 1.2em; }

        /* ì§„í–‰ ë°” ìŠ¤íƒ€ì¼ ìœ ì§€í•˜ë˜ í¬ì¸íŠ¸ ì»¬ëŸ¬ ë³€ê²½ */
        .progress-bar {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            height: 80px;
            position: relative;
            margin-top: 20px;
        }

        .character {
            position: absolute;
            bottom: 25px;
            left: 0;
            transition: left 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 10;
        }

        .progress-track {
            display: flex;
            justify-content: space-between;
            width: 100%;
            position: relative;
        }

        .progress-step {
            width: 18px;
            height: 18px;
            background-color: #E2E8F0;
            border-radius: 50%;
            border: 3px solid #FF8A5B;
            z-index: 1;
        }
        .progress-step.active { background-color: #FFEB3B; }
        .progress-step.current { background-color: #FF8A5B; transform: scale(1.3); }
        .progress-step.final {
            background-color: #FFD700;
            width: 30px;
            height: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2em;
        }

        .progress-line {
            position: absolute;
            top: 50%;
            left: 0;
            width: 100%;
            height: 4px;
            background-color: #FED7D7;
            transform: translateY(-50%);
            z-index: 0;
        }

        .progress-count {
            position: absolute;
            right: 0;
            bottom: -30px;
            font-size: 1.1em;
            font-weight: 800;
            font-style: italic;
            color: #FF8A5B;
        }
    </style>
</head>
<body>
<div data-custom-header style="width: 100%;">
    <header th:replace="~{fragments/header :: headerFragment}"></header>
</div>

<main>
    <div class="container">
        <div class="header">
            <h1 class="custom-italic">ìŠ¤ë¬´ê³ ê°œ</h1>
        </div>

        <div class="question-box">
            <span id="question-text">ì§ˆë¬¸ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤... ğŸ¤”</span>
        </div>

        <div class="buttons-box">
            <button class="btn yes" onclick="nextQuestion(true)">
                <span class="btn-icon">ğŸ‘</span> ë„¤!
            </button>
            <button class="btn no" onclick="nextQuestion(false)">
                <span class="btn-icon">ğŸ‘</span> ì•„ë‹ˆìš”!
            </button>
        </div>

        <div class="progress-bar">
            <div class="character" id="character">
                <img src="/images/meal.png" style="width: 45px; height: 45px;" alt="character">
            </div>
            <div class="progress-track">
                <div class="progress-line"></div>
            </div>
            <div class="progress-count" id="progress-count">0/20</div>
        </div>
    </div>
</main>

<footer th:replace="~{fragments/footer :: footerFragment}"></footer>

<script th:inline="javascript">
    let currentState = {
        category_korean: null,
        category_western: null,
        category_chinese: null,
        category_japanese: null,
        category_asian: null,
        isSpicy: null,
        isSoup: null,
        isFried: null,
        isRoasted: null,
        hasPork: null,
        hasBeef: null,
        askedQuestionIds: []
    };

    let currentAttribute = "";
    let currentQuestionStep = 0;
    const maxSteps = 20;

    let remainingFoods = [];
    let finalTemplate = "";
    let currentSuggestingFood = "";

    window.onload = () => {
        fetchNextStep();
    };

    async function fetchNextStep() {
        const csrfHeaderMeta = document.querySelector('meta[name="_csrf_header"]');
        const csrfTokenMeta = document.querySelector('meta[name="_csrf"]');

        const headers = { 'Content-Type': 'application/json' };
        if (csrfHeaderMeta && csrfTokenMeta) {
            headers[csrfHeaderMeta.content] = csrfTokenMeta.content;
        }

        try {
            const response = await fetch('/twenty-questions/next', {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(currentState)
            });
            const data = await response.json();

            if (data.status === "QUESTION") {
                document.getElementById('question-text').innerText = data.nextQuestion_text;
                currentAttribute = data.nextAttribute_name;
                currentState.askedQuestionIds.push(parseInt(data.nextQuestion_id));
                currentQuestionStep++;
                updateProgressBar();

            } else if (data.status === "FINAL_CHOICE") {
                remainingFoods = data.remain_foodList;
                finalTemplate = data.nextQuestion_text;
                askFinalFood();

            } else if (data.status === "NO_FOOD") {
                alert("í—‰! ì¡°ê±´ì— ë”± ë§ëŠ” ìŒì‹ì´ ì—†ë„¤ìš” ğŸ˜¢ ì²˜ìŒë¶€í„° ë‹¤ì‹œ ì°¾ì•„ë³¼ê¹Œìš”?");
                location.reload();
            }
        } catch (error) {
            console.error("ì„œë²„ í†µì‹  ì—ëŸ¬:", error);
            document.getElementById('question-text').innerText = "ì„œë²„ì™€ ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤ ğŸ˜­";
        }
    }

    function askFinalFood() {
        if (remainingFoods.length > 0) {
            currentSuggestingFood = remainingFoods.shift();
            let text = currentSuggestingFood + finalTemplate;
            document.getElementById('question-text').innerText = text;
            currentQuestionStep++;
            updateProgressBar();
        } else {
            alert("ì¶”ì²œí•´ ë“œë¦° ìŒì‹ì´ ë‹¤ ë§ˆìŒì— ì•ˆ ë“œì‹œë‚˜ìš”? ğŸ˜­ ë‹¤ì‹œ ì°¾ì•„ë³¼ê¹Œìš”?");
            location.reload();
        }
    }

    function nextQuestion(isYes) {
        if (currentSuggestingFood !== "") {
            if (isYes) {
                alert("ğŸ‰ í™•ì •! [" + currentSuggestingFood + "] ë§›ìˆê²Œ ë“œì„¸ìš”!");
            } else {
                askFinalFood();
            }
            return;
        }

        if (currentAttribute) {
            currentState[currentAttribute] = isYes ? 1 : 0;
        }
        fetchNextStep();
    }

    function updateProgressBar() {
        const track = document.querySelector('.progress-track');
        const character = document.getElementById('character');
        track.innerHTML = '<div class="progress-line"></div>';

        let displayStep = currentQuestionStep > maxSteps ? maxSteps : currentQuestionStep;
        document.getElementById('progress-count').innerText = `${displayStep}/${maxSteps}`;

        for (let i = 1; i <= maxSteps; i++) {
            const step = document.createElement('div');
            step.classList.add('progress-step');
            if (i <= displayStep) step.classList.add('active');
            if (i === displayStep) step.classList.add('current');
            if (i === maxSteps) {
                step.classList.add('final');
                step.innerHTML = 'ğŸ';
            }
            track.appendChild(step);
        }

        setTimeout(() => {
            const stepWidth = track.offsetWidth / (maxSteps - 1);
            const characterPosition = (displayStep - 1) * stepWidth;
            character.style.left = `${characterPosition}px`;
        }, 50);
    }
</script>
</body>
</html>