<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf?.token}" th:if="${_csrf}"/>
    <meta name="_csrf_header" th:content="${_csrf?.headerName}" th:if="${_csrf}"/>
    <title>Pick Meal - ìŠ¤ë¬´ê³ ê°œ ê²Œì„</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@700;800&display=swap" rel="stylesheet">
    <style>
        /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ ë™ì¼ */
        body { font-family: 'Fredoka', sans-serif; background-color: #FFF5F0; display: flex; flex-direction: column; min-height: 100vh; margin: 0; overflow-x: hidden; }
        [data-custom-header] a, [data-custom-header] button, [data-custom-header] span, .custom-italic { font-family: 'Fredoka', sans-serif !important; font-weight: 800 !important; font-style: italic !important; display: inline-block !important; }
        main { flex: 1; display: flex; justify-content: center; align-items: center; width: 100%; padding: 100px 20px 40px; }
        .container { background-color: #FFFDF0; border-radius: 2.5rem; padding: 40px; box-shadow: 0 20px 50px rgba(255, 138, 91, 0.1); width: 100%; max-width: 600px; text-align: center; border: 4px solid #FF8A5B; }
        .question-box { background-color: #FFF; border: 4px solid #FF8A5B; border-radius: 2rem; padding: 30px; font-size: 1.6em; color: #333; margin-bottom: 40px; position: relative; font-weight: 700; }
        .btn { background-color: #FF8A5B; color: white; border: 4px solid #6D4C41; border-radius: 50px; padding: 15px 45px; font-size: 1.5em; font-weight: 800; font-style: italic; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; box-shadow: 0 6px 0 rgba(0,0,0,0.1); }
        .progress-bar { display: flex; justify-content: space-between; align-items: flex-end; height: 80px; position: relative; margin-top: 20px; }
        .character { font-size: 3em; position: absolute; bottom: 25px; left: 0; transition: left 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 10; }
        .progress-step { width: 18px; height: 18px; background-color: #E2E8F0; border-radius: 50%; border: 3px solid #FF8A5B; z-index: 1; }
        .progress-step.active { background-color: #FFEB3B; }
        .winner-card-mid { max-width: 410px !important; padding: 2rem !important; border-radius: 3.5rem !important; background: white; margin: 0 auto; }
        .winner-img-mid { height: 220px !important; border-radius: 2.5rem !important; overflow: hidden; box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
    </style>
</head>
<body>
<div data-custom-header style="width: 100%;">
    <header th:replace="~{fragments/header :: headerFragment}"></header>
</div>

<main id="game-main">
    <div class="container" id="main-container">
        <div class="header">
            <h1 class="text-[#FF8A5B] text-6xl font-black italic uppercase tracking-tighter mb-8">ìŠ¤ë¬´ê³ ê°œ</h1>
        </div>

        <div class="question-box">
            <span id="question-text">ì§ˆë¬¸ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤... ğŸ¤”</span>
        </div>

        <div class="buttons-box flex justify-center gap-5 mb-10">
            <button class="btn yes" onclick="nextQuestion(true)">ğŸ‘ ë„¤!</button>
            <button class="btn no" style="background-color: #4CAF50;" onclick="nextQuestion(false)">ğŸ‘ ì•„ë‹ˆìš”!</button>
        </div>

        <div class="progress-bar">
            <div class="character" id="character">
                <img src="/images/meal.png" style="width: 45px; height: 45px;" alt="character">
            </div>
            <div class="progress-track flex justify-between w-full relative" id="progress-track">
                <div class="progress-line absolute top-1/2 left-0 w-full h-[4px] bg-[#FED7D7] translate-y-[-50%] z-0"></div>
            </div>
            <div class="progress-count absolute right-0 bottom-[-30px] font-bold text-[#FF8A5B]" id="progress-count">0/20</div>
        </div>
    </div>
</main>

<footer th:replace="~{fragments/footer :: footerFragment}"></footer>

<script th:inline="javascript">
    // [ë³´ì •] DTOì™€ ì´ë¦„ì´ ê°™ì€ ì¹´ë©œì¼€ì´ìŠ¤ ê°ì²´
    let currentState = {
        categoryKorean: null, categoryWestern: null, categoryChinese: null,
        categoryJapanese: null, categoryAsian: null,
        isSpicy: null, isSoup: null, isFried: null, isRoasted: null,
        hasPork: null, hasBeef: null, askedQuestionIds: []
    };

    let currentAttribute = "";
    let currentQuestionStep = 0;
    const maxSteps = 20;
    let remainingFoods = [];
    let finalTemplate = "";
    let currentSuggestingFood = "";

    window.onload = () => { fetchNextStep(); };

    async function fetchNextStep() {
        const csrfHeaderMeta = document.querySelector('meta[name="_csrf_header"]');
        const csrfTokenMeta = document.querySelector('meta[name="_csrf"]');
        const headers = { 'Content-Type': 'application/json' };
        if (csrfHeaderMeta && csrfTokenMeta) headers[csrfHeaderMeta.content] = csrfTokenMeta.content;

        try {
            const response = await fetch('/twenty-questions/next', {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(currentState)
            });
            const data = await response.json();

            if (data.status === "QUESTION") {
                document.getElementById('question-text').innerText = data.nextQuestion_text;
                // [ì£¼ì˜] DB ì»¬ëŸ¼ëª…ì¸ 'category_korean' ë“±ì´ ë“¤ì–´ì˜´
                currentAttribute = data.nextAttribute_name;
                currentState.askedQuestionIds.push(parseInt(data.nextQuestion_id));
                currentQuestionStep++;
                updateProgressBar();
            } else if (data.status === "FINAL_CHOICE") {
                remainingFoods = data.remain_foodList;
                finalTemplate = data.nextQuestion_text;
                askFinalFood();
            } else if (data.status === "NO_FOOD") {
                alert("í—‰! ì¡°ê±´ì— ë”± ë§ëŠ” ìŒì‹ì´ ì—†ë„¤ìš” ğŸ˜¢ ì²˜ìŒë¶€í„° ë‹¤ì‹œ ì°¾ì•„ë³¼ê¹Œìš”?");
                location.reload();
            }
        } catch (error) {
            console.error("ì„œë²„ í†µì‹  ì—ëŸ¬:", error);
        }
    }

    function askFinalFood() {
    if (remainingFoods.length > 0) {
        currentSuggestingFood = remainingFoods.shift();
        // finalTemplateì´ nullì´ë©´ ê¸°ë³¸ê°’ ì²˜ë¦¬
        const template = finalTemplate || "ëŠ” ì–´ë– ì‹ ê°€ìš”? ğŸ¤”";
        document.getElementById('question-text').innerText = currentSuggestingFood + template;
        currentQuestionStep++;
        updateProgressBar();
    } else {
        alert("ì¶”ì²œí•´ ë“œë¦° ìŒì‹ì´ ë‹¤ ë§ˆìŒì— ì•ˆ ë“œì‹œë‚˜ìš”? ğŸ˜­ ë‹¤ì‹œ ì°¾ì•„ë³¼ê¹Œìš”?");
        location.reload();
    }
}

    async function nextQuestion(isYes) {
        if (currentSuggestingFood !== "") {
            if (isYes) {
                try {
                    const imgRes = await fetch(`/twenty-questions/api/food/imagePath?foodName=${encodeURIComponent(currentSuggestingFood)}`);
                    const realImagePath = await imgRes.text();
                    const idRes = await fetch(`/api/food/getIdByName?foodName=${encodeURIComponent(currentSuggestingFood)}`);
                    const foodId = await idRes.json();
                    if (foodId) {
                        fetch('/worldcup/win/' + foodId + '?gameType=twenty', { method: 'POST' }).catch(e => {});
                    }
                    renderWinner(realImagePath, currentSuggestingFood);
                } catch(error) {
                    console.error("ê²°ê³¼ ì²˜ë¦¬ ì¤‘ ì—ëŸ¬:", error);
                }
            } else {
                askFinalFood();
            }
            return;
        }

        if (currentAttribute) {
            // [í•µì‹¬ í•´ê²°ì‚¬] snake_case(category_korean)ë¥¼ camelCase(categoryKorean)ë¡œ ë³€í™˜
            const camelKey = currentAttribute.replace(/_([a-z])/g, (match, letter) => letter.toUpperCase());

            // ë³€í™˜ëœ í‚¤ê°€ currentStateì— ìˆìœ¼ë©´ ê°’ì„ ì—…ë°ì´íŠ¸
            if (currentState.hasOwnProperty(camelKey)) {
                currentState[camelKey] = isYes ? 1 : 0;
            } else {
                // ë³€í™˜ ì‹¤íŒ¨ ì‹œ ëŒ€ë¹„ìš©
                currentState[currentAttribute] = isYes ? 1 : 0;
            }
        }
        fetchNextStep();
    }

    function renderWinner(imagePath, foodName) {
        const main = document.getElementById('game-main');
        main.className = "flex flex-col items-center justify-center w-full min-h-[70vh] px-10";
        main.innerHTML = `
            <div class="flex flex-col items-center justify-center w-full animate-bounce mb-2">
                <h2 class="text-[#FF8A5B] font-black text-5xl uppercase italic tracking-tighter">WINNER</h2>
            </div>
            <div class="bg-white winner-card-mid shadow-2xl border-4 border-[#FF8A5B] w-full text-center">
                <div class="winner-img-mid mb-6 shadow-md bg-gray-50">
                    <img src="${imagePath}" class="w-full h-full object-cover" onerror="this.src='/images/meal.png'">
                </div>
                <h1 class="text-4xl font-black text-gray-800 italic mb-6 uppercase tracking-tighter">${foodName}</h1>
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <button onclick="location.href='/game'" class="py-3 bg-gray-100 rounded-2xl font-bold italic uppercase text-sm">HOME ğŸ </button>
                    <button onclick="location.reload()" class="py-3 bg-gray-100 rounded-2xl font-bold italic uppercase text-sm">RESTART ğŸ”„</button>
                    <button onclick="location.href='/worldcup/ranking'" class="py-3 bg-gray-100 rounded-2xl font-bold italic uppercase text-sm">RANK ğŸ†</button>
                    <button onclick="copyToClipboard('${foodName}')" class="py-3 bg-gray-100 rounded-2xl font-bold italic uppercase text-sm">SHARE ğŸ”—</button>
                </div>
                <button onclick="window.open('https://map.kakao.com/link/search/' + encodeURIComponent('${foodName}'))"
                        class="w-full py-4 bg-[#FAE100] rounded-full font-black text-lg shadow-md italic">
                    ì£¼ë³€ ë§›ì§‘ ì°¾ê¸° ğŸ“
                </button>
            </div>
        `;
        confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, zIndex: 9999 });
    }

    function updateProgressBar() {
        const track = document.getElementById('progress-track');
        const character = document.getElementById('character');
        track.innerHTML = '<div class="progress-line absolute top-1/2 left-0 w-full h-[4px] bg-[#FED7D7] translate-y-[-50%] z-0"></div>';
        let displayStep = currentQuestionStep > maxSteps ? maxSteps : currentQuestionStep;
        document.getElementById('progress-count').innerText = `${displayStep}/${maxSteps}`;
        for (let i = 1; i <= maxSteps; i++) {
            const step = document.createElement('div');
            step.classList.add('progress-step', 'z-10');
            if (i <= displayStep) step.classList.add('active');
            if (i === maxSteps) {
                step.classList.add('final', 'bg-[#FFD700]', 'w-[30px]', 'h-[30px]', 'flex', 'items-center', 'justify-center');
                step.innerHTML = 'ğŸ';
            }
            track.appendChild(step);
        }
        setTimeout(() => {
            const stepWidth = track.offsetWidth / (maxSteps - 1);
            const characterPosition = (displayStep - 1) * stepWidth;
            character.style.left = `${characterPosition}px`;
        }, 50);
    }

    window.copyToClipboard = function(foodName) {
        navigator.clipboard.writeText(`ğŸ† ë‚˜ì˜ ì›í”½ ë©”ë‰´: [${foodName}]`).then(() => alert("ë³µì‚¬ ì™„ë£Œ!"));
    };
</script>
</body>
</html>