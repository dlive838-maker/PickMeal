<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- CSRF Token -->
    <meta name="_csrf" th:content="${_csrf?.token}" th:if="${_csrf}"/>
    <meta name="_csrf_header" th:content="${_csrf?.headerName}" th:if="${_csrf}"/>

    <title>ìŠ¤ë¬´ê³ ê°œ ê²Œì„</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Jua', sans-serif;
            background-color: #FFF8E7;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            margin: 0;
        }

        main {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
        }

        .container {
            background-color: #FFFDF0;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            width: 80%;
            max-width: 600px;
            text-align: center;
            border: 5px solid #6D4C41;
        }

        .header h1 {
            color: #FF7F50;
            font-size: 3em;
            margin-bottom: 20px;
            text-shadow: 2px 2px 0 #fff, -2px -2px 0 #fff, 2px -2px 0 #fff, -2px 2px 0 #fff;
            -webkit-text-stroke: 2px #6D4C41;
        }

        .question-box {
            background-color: #FFF;
            border: 4px solid #6D4C41;
            border-radius: 20px;
            padding: 20px;
            font-size: 1.5em;
            color: #333;
            margin-bottom: 30px;
            position: relative;
        }

        /* ë§í’ì„  ê¼¬ë¦¬ */
        .question-box::after {
            content: '';
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            border-top: 20px solid #FFF;
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
        }
        .question-box::before {
            content: '';
            position: absolute;
            bottom: -26px;
            left: 50%;
            transform: translateX(-50%);
            border-top: 26px solid #6D4C41;
            border-left: 18px solid transparent;
            border-right: 18px solid transparent;
        }


        .buttons-box {
            display: flex;
            justify-content: space-around;
            margin-bottom: 30px;
        }

        .btn {
            background-color: #FF7F50;
            color: white;
            border: 4px solid #6D4C41;
            border-radius: 50px;
            padding: 15px 30px;
            font-size: 1.5em;
            cursor: pointer;
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
            box-shadow: 0 4px 0 #C0392B;
        }
        .btn.no {
            background-color: #4CAF50;
            box-shadow: 0 4px 0 #388E3C;
        }

        .btn:hover {
            transform: translateY(4px);
            box-shadow: none;
        }
        .btn.yes:hover { background-color: #E64A19; }
        .btn.no:hover { background-color: #2E7D32; }

        .btn-icon {
            margin-right: 10px;
            font-size: 1.2em;
        }
        .btn-deco {
            margin-left: 10px;
            font-size: 0.8em;
            color: #FFF;
        }

        .progress-bar {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            height: 80px;
            position: relative;
        }

        .character {
            font-size: 3em;
            position: absolute;
            bottom: 20px;
            left: 0;
            transition: left 0.3s;
        }

        .progress-track {
            display: flex;
            justify-content: space-between;
            width: 100%;
            position: relative;
        }

        .progress-step {
            width: 20px;
            height: 20px;
            background-color: #BDBDBD;
            border-radius: 50%;
            border: 3px solid #6D4C41;
            z-index: 1;
        }
        .progress-step.active {
            background-color: #FFEB3B;
        }
        .progress-step.current {
            background-color: #FF9800;
            transform: scale(1.2);
        }
        .progress-step.final {
            background-color: #FFD700;
            width: 30px;
            height: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2em;
        }

        .progress-line {
            position: absolute;
            top: 50%;
            left: 0;
            width: 100%;
            height: 4px;
            background-color: #6D4C41;
            transform: translateY(-50%);
            z-index: 0;
        }

        .progress-count {
            position: absolute;
            right: 0;
            bottom: -25px;
            font-size: 1.2em;
            color: #6D4C41;
        }
    </style>
</head>
<body>
<header th:replace="~{fragments/header :: headerFragment}"></header>
<main>
    <div class="container">
        <div class="header">
            <h1>ìŠ¤ë¬´ê³ ê°œ</h1>
        </div>

        <div class="question-box">
            <span id="question-text">ì§ˆë¬¸ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤... ğŸ¤”</span>
        </div>

        <div class="buttons-box">
            <button class="btn yes" onclick="nextQuestion(true)">
                <span class="btn-icon">+</span> ë„¤! <span class="btn-deco">âˆ´</span>
            </button>
            <button class="btn no" onclick="nextQuestion(false)">
                <span class="btn-icon">+</span> ì•„ë‹ˆìš”! <span class="btn-deco">âˆ´</span>
            </button>
        </div>

        <div class="progress-bar">
            <div class="character" id="character"><img src="/images/meal.png" style="width: 40px; height: 40px; margin-bottom: 13px; margin-left: -6px;" alt="character"></div>
            <div class="progress-track">
                <div class="progress-line"></div>
            </div>
            <div class="progress-count" id="progress-count">0/20</div>
        </div>
    </div>
</main>
<footer th:replace="~{fragments/footer :: footerFragment}"></footer>
<script>
    let currentState = {
        category_korean: null,
        category_western: null,
        category_chinese: null,
        category_japanese: null,
        category_asian: null,
        isSpicy: null,
        isSoup: null,
        isFried: null,
        isRoasted: null,
        hasPork: null,
        hasBeef: null,
        askedQuestionIds: []
    };

    let currentAttribute = "";
    let currentQuestionStep = 0;
    const maxSteps = 20;

    let remainingFoods = [];
    let finalTemplate = "";
    let currentSuggestingFood = "";

    window.onload = () => {
        fetchNextStep();
    };

    async function fetchNextStep() {

        // csrf í† í° ê°€ì ¸ì˜¤ê¸° ë¼ëŠ”ë° ë­”ì§€ ëª¨ë¥´ê² ìŒ..
        const csrfHeaderMeta = document.querySelector('meta[name="_csrf_header"]');
        const csrfTokenMeta = document.querySelector('meta[name="_csrf"]');

        const headers = { 'Content-Type': 'application/json' };
        if (csrfHeaderMeta && csrfTokenMeta) {
            headers[csrfHeaderMeta.content] = csrfTokenMeta.content;
        }

        try {
            const response = await fetch('/twenty-questions/next', {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(currentState)
            });
            const data = await response.json();

            if (data.status === "QUESTION") {
                document.getElementById('question-text').innerText = data.nextQuestion_text;
                currentAttribute = data.nextAttribute_name;

                currentState.askedQuestionIds.push(parseInt(data.nextQuestion_id));

                currentQuestionStep++;
                updateProgressBar();

            } else if (data.status === "FINAL_CHOICE") {
                remainingFoods = data.remain_foodList;
                finalTemplate = data.nextQuestion_text;
                askFinalFood();

            } else if (data.status === "NO_FOOD") {
                alert("í—‰! ì¡°ê±´ì— ë”± ë§ëŠ” ìŒì‹ì´ ì—†ë„¤ìš” ğŸ˜¢ ì²˜ìŒë¶€í„° ë‹¤ì‹œ ì°¾ì•„ë³¼ê¹Œìš”?");
                location.reload();
            }
        } catch (error) {
            console.error("ì„œë²„ í†µì‹  ì—ëŸ¬:", error);
            document.getElementById('question-text').innerText = "ì„œë²„ì™€ ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤ ğŸ˜­";
        }
    }

    function askFinalFood() {
        if (remainingFoods.length > 0) {
            currentSuggestingFood = remainingFoods.shift();

            let text = currentSuggestingFood + finalTemplate;
            document.getElementById('question-text').innerText = text;

            currentQuestionStep++;
            updateProgressBar();
        } else {
            alert("ì¶”ì²œí•´ ë“œë¦° ìŒì‹ì´ ë‹¤ ë§ˆìŒì— ì•ˆ ë“œì‹œë‚˜ìš”? ğŸ˜­ ë‹¤ì‹œ ì°¾ì•„ë³¼ê¹Œìš”?");
            location.reload();
        }
    }

    async function nextQuestion(isYes) {

        if (currentSuggestingFood !== "") {
            if (isYes) {
            try{
                const response = await fetch(`/twenty-questions/api/food/imagePath?foodName=${currentSuggestingFood}`);
                const realImagePath = await response.text();

                const body = document.querySelector('main');
                body.innerHTML = `
                <div class="flex flex-col items-center justify-center min-h-screen p-6 text-center">
                    <div class="mb-6">
                        <h2 class="text-[#FF8A5B] font-black text-3xl mb-2 animate-bounce">ğŸ† CHAMPION ğŸ†</h2>
                    </div>
                    <div class="bg-white p-8 rounded-[4rem] shadow-2xl border-4 border-[#FF8A5B] max-w-md w-full">
                        <div class="overflow-hidden rounded-[3rem] mb-6 h-80 shadow-md">
                            <img src="${realImagePath}" class="w-full h-full object-cover">
                        </div>
                        <h1 class="text-5xl font-black text-gray-800 italic mb-2">${currentSuggestingFood}</h1>
                        <div class="grid grid-cols-2 gap-3 mb-6">
                            <button onclick="location.href='/game'" class="py-3 bg-gray-100 rounded-2xl font-bold">HOME ğŸ </button>
                            <button onclick="location.href='/twenty-questions'" class="py-3 bg-gray-100 rounded-2xl font-bold">RESTART ğŸ”„</button>
                        </div>
                        <button onclick="window.open('https://map.kakao.com/link/search/' + encodeURIComponent('${currentSuggestingFood}'))"
                                class="w-full py-5 bg-[#FAE100] rounded-full font-black text-xl">
                            ì£¼ë³€ ë§›ì§‘ ì°¾ê¸° ğŸ“
                        </button>
                    </div>
                </div>
                `;
                setTimeout(() => {
                    if (typeof confetti === 'function') {
                        confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, zIndex: 9999 });
                    }
                }, 100);

                }catch(error){
                    console.error("ì´ë¯¸ì§€ ê²½ë¡œë¥¼ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.:", error);
                    alert("ê²°ê³¼ í™”ë©´ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                }

                // ì‹¤ì œ ê²°ê³¼ í˜ì´ì§€ ë”°ë¡œ ë§Œë“¤ ì‹œ ì´ ë¶€ë¶„ í™œìš©
                // window.location.href = `/result?foodName=${currentSuggestingFood}`;
            } else {
                askFinalFood();
            }
            return;
        }

        if (currentAttribute) {
            currentState[currentAttribute] = isYes ? 1 : 0; // 1: ë„¤, 0: ì•„ë‹ˆì˜¤
        }

        fetchNextStep();
    }

    // --- ê¸°ì¡´ ì§„í–‰ ë°” UI ì• ë‹ˆë©”ì´ì…˜ ë¡œì§ ---
    function updateProgressBar() {
        const track = document.querySelector('.progress-track');
        const character = document.getElementById('character');
        track.innerHTML = '<div class="progress-line"></div>';

        let displayStep = currentQuestionStep > maxSteps ? maxSteps : currentQuestionStep;

        document.getElementById('progress-count').innerText = `${displayStep}/${maxSteps}`;

        for (let i = 1; i <= maxSteps; i++) {
            const step = document.createElement('div');
            step.classList.add('progress-step');
            if (i <= displayStep) step.classList.add('active');
            if (i === displayStep) step.classList.add('current');
            if (i === maxSteps) {
                step.classList.add('final');
                step.innerHTML = 'ğŸ';
            }
            track.appendChild(step);
        }

        setTimeout(() => {
            const stepWidth = track.offsetWidth / (maxSteps - 1);
            const characterPosition = (displayStep - 1) * stepWidth;
            character.style.left = `${characterPosition}px`;
        }, 50);
    }
</script>
</body>
</html>