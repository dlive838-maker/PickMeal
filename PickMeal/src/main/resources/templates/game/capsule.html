<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Pick Meal - Capsule</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@700;800&display=swap" rel="stylesheet">
    <style>
        /* í—¤ë”ì™€ í‘¸í„°ë¥¼ ìµœìƒìœ„ë¡œ ì˜¬ë¦¼ */
        header, footer { z-index: 1200 !important; position: relative; }

        body {
            font-family: 'Fredoka', sans-serif;
            background-color: #FAF3F0;
            margin: 0; display: flex; flex-direction: column; min-height: 100vh; overflow-x: hidden;
        }

        .gacha-main-content { flex-grow: 1; display: flex; justify-content: center; align-items: center; position: relative; }
        .gacha-wrapper { position: relative; display: flex; flex-direction: column; align-items: center; transition: opacity 0.4s; transform: scale(0.9); }

        /* [ê¸°ê³„ ë””ìì¸ ìœ ì§€] */
        .glass-sphere { position: relative; width: 360px; height: 340px; background: radial-gradient(circle at 30% 25%, rgba(255, 255, 255, 0.9) 0%, rgba(255, 255, 255, 0.2) 65%); border: 2px solid rgba(0, 0, 0, 0.08); border-radius: 50%; z-index: 2; overflow: hidden; box-shadow: inset 0 0 30px rgba(255, 255, 255, 0.8); display: flex; justify-content: center; align-items: flex-end; }
        .capsule { position: absolute; width: 52px; height: 52px; border-radius: 50%; overflow: hidden; display: flex; flex-direction: column; }
        .capsule-top { height: 50%; background: rgba(255, 255, 255, 0.6); border-bottom: 1px solid rgba(0,0,0,0.1); }
        .capsule-bottom { height: 50%; }
        .machine-body { position: relative; width: 300px; height: 260px; background: #FF4D4D; border-radius: 50px 50px 60px 60px; margin-top: -85px; z-index: 1; display: flex; flex-direction: column; align-items: center; box-shadow: inset -12px -12px 0px rgba(0,0,0,0.08); }

        /* [ê²°ê³¼ í™”ë©´: í´ë¦­ ë°©í•´ ìš”ì†Œ ì œê±°] */
        #result-screen {
            position: fixed; display: none; flex-direction: column; align-items: center;
            z-index: 1000; top: 0; left: 0; width: 100%; height: 100%;
            justify-content: center;
            /* ê²°ê³¼ì°½ ë°°ê²½ ìì²´ëŠ” í´ë¦­ì„ í†µê³¼ì‹œí‚´ */
            pointer-events: none;
        }

        .capsule-container {
            position: relative; width: 300px; height: 230px;
            display: flex; justify-content: center; align-items: center;
        }

        .cap-half {
            position: absolute; width: 230px; height: 115px; border: 6px solid #333;
            transition: transform 0.8s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s 0.7s;
            z-index: 10; left: 50%; margin-left: -115px;
        }
        .top-cap { top: 0px; border-radius: 115px 115px 0 0; border-bottom: none; }
        .bottom-cap { top: 115px; border-radius: 0 0 115px 115px; border-top: none; }

        .is-open .top-cap { transform: translateY(-150px) rotate(-15deg); opacity: 0; }
        .is-open .bottom-cap { transform: translateY(150px) rotate(15deg); opacity: 0; }

        .result-content {
            display: flex; flex-direction: column; align-items: center;
            opacity: 0; transform: scale(0.1);
            transition: all 0.6s 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
            z-index: 5; margin-top: -20px;
        }
        .is-open .result-content { opacity: 1; transform: scale(1); }

        .food-img { width: 200px; height: 200px; border-radius: 30px; object-fit: cover; border: 6px solid white; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .result-txt { margin-top: 12px; font-size: 36px; font-weight: 800; color: #333; text-shadow: 2px 2px 0 white; text-align: center; word-break: keep-all; line-height: 1.1; }

        /* [ë²„íŠ¼ ê·¸ë£¹: í´ë¦­ ê°€ëŠ¥í•˜ê²Œ ë³µêµ¬] */
        #action-buttons {
            pointer-events: auto; /* ë²„íŠ¼ ì˜ì—­ì€ ë‹¤ì‹œ í´ë¦­ ê°€ëŠ¥í•˜ê²Œ ì„¤ì • */
        }

        .btn-style {
            padding: 10px 32px; border-radius: 18px; background: #FF4D4D; color: white;
            font-weight: 800; cursor: pointer; border: 4px solid #333; box-shadow: 4px 4px 0px #333;
            transition: transform 0.2s, opacity 0.5s;
        }
        .btn-style:active { transform: translateY(2px); box-shadow: 1px 1px 0px #333; }

        @keyframes mixing { 0%, 100% { transform: translate(0, 0) rotate(0deg); } 25% { transform: translate(120px, -130px) rotate(90deg); } 50% { transform: translate(-120px, -160px) rotate(180deg); } 75% { transform: translate(100px, -60px) rotate(270deg); } }
        @keyframes settle-down { to { transform: translate(var(--rand-x), var(--rand-y)) rotate(var(--rand-rot)); } }
        @keyframes roll-out { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 1; transform: translateY(130px) translateX(70px) rotate(360deg); } }
        .spin-action { transform: rotate(110deg); }
    </style>
</head>
<body>
<header th:replace="~{fragments/header :: headerFragment}"></header>

<main class="gacha-main-content">
    <div class="gacha-wrapper" id="machine-all">
        <div class="glass-sphere" id="sphere"></div>
        <div class="machine-body">
            <div class="cat-box mt-[90px] bg-white border-[3px] border-[#FF4D4D] rounded-[30px] px-4 py-1 flex items-center z-10">
                <span class="arrow-btn cursor-pointer text-xl text-[#FF4D4D] px-2" onclick="moveCat(-1)">â—€</span>
                <span id="cat-label" class="font-black text-[#FF4D4D] text-xl">ì „ì²´</span>
                <span class="arrow-btn cursor-pointer text-xl text-[#FF4D4D] px-2" onclick="moveCat(1)">â–¶</span>
            </div>
            <div class="lever-btn-wrapper mt-4 cursor-pointer transition-transform duration-700" id="lever-wrapper" onclick="draw()">
                <div class="w-20 h-20 bg-white rounded-full flex justify-center items-center shadow-inner">
                    <div class="bg-[#FFD700] px-4 py-2 rounded-2xl text-sm font-bold shadow-[0_4px_0_#C9A000]">Click!</div>
                </div>
            </div>
            <div class="exit-gate mt-2 w-24 h-12 bg-[#D32F2F] rounded-t-xl relative">
                <div id="out-cap-pos" class="absolute top-0 left-6"></div>
            </div>
        </div>
    </div>

    <div id="result-screen">
        <div class="capsule-container">
            <div class="cap-half top-cap" id="result-top-cap"></div>
            <div class="result-content" id="final-content">
                <img id="food-img" src="" alt="ìŒì‹" class="food-img">
                <div class="result-txt" id="food-res">MENU</div>
            </div>
            <div class="cap-half bottom-cap" id="result-bottom-cap"></div>
        </div>
        <div id="action-buttons" class="flex flex-col items-center gap-4 mt-8 opacity-0 transition-opacity duration-700">
            <div class="flex gap-4">
                <button class="btn-style" onclick="location.reload()">NEW</button>
                <button class="btn-style" style="background:#A8D5BA;" onclick="retry()">RETRY</button>
            </div>
            <button class="btn-style w-full max-w-[300px]"
                    style="background:#FFEB3B; color:#3A1D1D; border-color:#3A1D1D; box-shadow: 4px 4px 0px #3A1D1D;"
                    onclick="findRestaurants()">
                ğŸ“ ì£¼ë³€ ë§›ì§‘ ì°¾ê¸°
            </button>
        </div>
    </div>
</main>
<footer th:replace="~{fragments/footer :: footerFragment}"></footer >

<script>
    const categoryMap = [{ label: "ì „ì²´", value: "" },{ label: "í•œì‹", value: "Korean food" },{ label: "ì¤‘ì‹", value: "Chinese food" },{ label: "ì¼ì‹", value: "Japanese food" },{ label: "ì–‘ì‹", value: "Western food" },{ label: "ì•„ì‹œì•ˆì‹", value: "Asian food" }];
    const colors = ["#FFADAD", "#FFD6A5", "#FDFFB6", "#CAFFBF", "#9BF6FF", "#A0C4FF"];
    let idx = 0; let playing = false; let currentFoodName = "";
    const sphere = document.getElementById('sphere');

    function initCapsules() {
        sphere.innerHTML = '';
        for(let i=0; i<18; i++) {
            const cap = createCapsuleElement(colors[i % colors.length]);
            const angle = (Math.PI / 10) * (Math.random() * 8 - 4);
            const dist = 90 + Math.random() * 30;
            cap.style.left = (180 + Math.sin(angle) * dist - 26) + 'px';
            cap.style.top = (170 + Math.cos(angle) * dist + 15) + 'px';
            cap.style.transform = `rotate(${Math.random() * 360}deg)`;
            sphere.appendChild(cap);
        }
    }

    function createCapsuleElement(color) {
        const cap = document.createElement('div'); cap.className = 'capsule';
        const top = document.createElement('div'); top.className = 'capsule-top';
        const bot = document.createElement('div'); bot.className = 'capsule-bottom';
        bot.style.background = color; cap.append(top, bot); return cap;
    }

    function moveCat(d) {
        if(playing) return;
        idx = (idx + d + categoryMap.length) % categoryMap.length;
        document.getElementById('cat-label').innerText = categoryMap[idx].label;
    }

    async function draw() {
        if(playing) return; playing = true;
        const lever = document.getElementById('lever-wrapper');
        const capsules = document.querySelectorAll('.capsule');
        lever.classList.add('spin-action');
        capsules.forEach(c => c.style.animation = `mixing 0.8s infinite ease-in-out`);

        try {
            const selectedValue = categoryMap[idx].value;
            const res = await fetch(`/api/food/draw?category=${encodeURIComponent(selectedValue)}`);
            if (!res.ok) throw new Error("ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜");
            const data = await res.json();
            currentFoodName = data.foodName;
            const winColor = colors[Math.floor(Math.random() * colors.length)];

            setTimeout(() => {
                lever.classList.remove('spin-action');
                capsules.forEach(c => {
                    c.style.setProperty('--rand-x', (Math.random()*20-10)+'px');
                    c.style.setProperty('--rand-y', (Math.random()*10-5)+'px');
                    c.style.setProperty('--rand-rot', (Math.random()*360)+'deg');
                    c.style.animation = `settle-down 2s forwards`;
                });

                setTimeout(() => {
                    const outPos = document.getElementById('out-cap-pos');
                    const outCap = createCapsuleElement(winColor);
                    outCap.style.animation = 'roll-out 1.5s forwards';
                    outPos.appendChild(outCap);

                    setTimeout(() => {
                        const foodResEl = document.getElementById('food-res');
                        if (currentFoodName.length > 10) foodResEl.style.fontSize = "22px";
                        else if (currentFoodName.length > 6) foodResEl.style.fontSize = "28px";
                        else foodResEl.style.fontSize = "36px";

                        document.getElementById('result-top-cap').style.backgroundColor = 'rgba(255, 255, 255, 0.6)';
                        document.getElementById('result-bottom-cap').style.backgroundColor = winColor;
                        document.getElementById('food-img').src = data.imagePath;
                        foodResEl.innerText = currentFoodName;
                        showFinal();
                    }, 1600);
                }, 2000);
            }, 2500);
        } catch (err) {
            playing = false;
            lever.classList.remove('spin-action');
            capsules.forEach(c => c.style.animation = 'none');
        }
    }

    function showFinal() {
        document.getElementById('machine-all').style.opacity = '0';
        setTimeout(() => {
            document.getElementById('machine-all').style.display = 'none';
            const rs = document.getElementById('result-screen');
            rs.style.display = 'flex';
            setTimeout(() => {
                rs.classList.add('is-open');
                setTimeout(() => {
                    fireConfetti();
                    const btns = document.getElementById('action-buttons');
                    btns.classList.remove('opacity-0');
                    // ë²„íŠ¼ í´ë¦­ ê°€ëŠ¥í•˜ê²Œ ìŠ¤íƒ€ì¼ ì§ì ‘ ë¶€ì—¬
                    btns.style.pointerEvents = 'auto';
                }, 800);
            }, 100);
        }, 400);
    }

    function fireConfetti() {
        const end = Date.now() + 2000;
        (function frame() {
            confetti({ particleCount: 7, angle: 60, spread: 55, origin: { x: 0, y: 0.8 } });
            confetti({ particleCount: 7, angle: 120, spread: 55, origin: { x: 1, y: 0.8 } });
            if (Date.now() < end) requestAnimationFrame(frame);
        }());
    }

    function retry() {
        const rs = document.getElementById('result-screen');
        const btns = document.getElementById('action-buttons');
        rs.classList.remove('is-open');
        btns.classList.add('opacity-0');
        btns.style.pointerEvents = 'none'; // ë‹¤ì‹œ í´ë¦­ ë°©ì§€
        setTimeout(() => {
            rs.style.display = 'none';
            const machine = document.getElementById('machine-all');
            machine.style.display = 'flex';
            machine.style.opacity = '1';
            document.getElementById('out-cap-pos').innerHTML = '';
            playing = false;
            draw();
        }, 500);
    }

    function findRestaurants() {
        if(!currentFoodName) return;
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;
                const query = encodeURIComponent(currentFoodName);
                const searchUrl = `https://map.kakao.com/link/search/${query}?cx=${lon}&cy=${lat}&lvl=1`;
                window.open(searchUrl, '_blank');
            }, function() {
                window.open(`https://map.kakao.com/link/search/${encodeURIComponent(currentFoodName)}?lvl=1`, '_blank');
            });
        }
    }

    initCapsules();
</script>
</body>
</html>