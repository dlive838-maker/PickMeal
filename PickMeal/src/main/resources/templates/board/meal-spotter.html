<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Meal-Spotter | ë§›ì§‘ íƒì§€ê¸°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@700;800&display=swap" rel="stylesheet">
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=24546b16104e0273c6d8c5c4cc508b44&libraries=services"></script>
    <style>
        body { font-family: 'Fredoka', sans-serif; margin: 0; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }
        .main-container { flex-grow: 1; display: flex; margin-top: 80px; overflow: hidden; height: calc(100vh - 140px); }
        .side-panel { width: 380px; background: white; border-right: 1px solid #eee; display: flex; flex-direction: column; z-index: 10; height: 100%; }
        #map { flex-grow: 1; height: 100%; }
        .place-list { flex-grow: 1; overflow-y: auto; padding: 10px; }
        .place-item { padding: 20px; border-bottom: 1px solid #f9f9f9; cursor: pointer; transition: 0.2s; position: relative; }
        .place-item:hover { background: #fffaf8; border-left: 6px solid #FF8A5B; }

        /* [ì¶”ê°€] ë¦¬ë·° ëª©ë¡ íŒì—… ìŠ¤íƒ€ì¼ */
        #reviewListModal {
            position: fixed; z-index: 3000; left: 0; top: 0;
            width: 100%; height: 100%; background-color: rgba(0,0,0,0.6);
            display: none; align-items: center; justify-content: center;
        }
        #reviewListModal .modal-content {
            background-color: white; padding: 30px; border-radius: 20px;
            width: 450px; max-height: 80vh; overflow-y: auto; position: relative;
        }
        .close { position: absolute; right: 20px; top: 15px; font-size: 28px; cursor: pointer; color: #aaa; }
    </style>
</head>
<body>

<header th:replace="~{fragments/header :: headerFragment}"></header>

<div class="main-container">
    <aside class="side-panel">
        <div id="placesList" class="place-list">
            <div th:each="res : ${restaurantList}"
                 class="place-item border-b border-gray-100 py-5 px-6 hover:bg-gray-50 transition cursor-pointer"
                 th:onclick="|handleStoreClick(${res.restId}, ${res.restLat}, ${res.restLng})|">

                <h4 class="font-bold ..." th:text="${res.restName}">ì‹ë‹¹ì´ë¦„</h4>

                <div class="wish-btn text-xl flex items-center gap-1 cursor-pointer"
                     th:onclick="'toggleWish(event, ' + ${res.restId} + ')'">
                    <span th:id="'heart-shape-' + ${res.restId}">[[${res.isWished ? 'â¤ï¸' : 'ğŸ¤'}]]</span>
                    <span th:id="'wish-count-' + ${res.restId}" class="wish-count text-sm"
                          th:text="${res.wishCount != null ? res.wishCount : 0}">0</span>
                </div>

                <p class="text-[12px] ..." th:text="${res.restAddress}">ì‹ë‹¹ ì£¼ì†Œ</p>

                <p class="text-[12px] ..." th:text="|ëŒ€í‘œë©”ë‰´ : ${res.restMenu}|">ëŒ€í‘œë©”ë‰´</p>

                <div class="flex items-center gap-3">
                    <span class="...">ğŸ‘ï¸ [[${res.restViews}]]</span>

                    <span class="..." th:onclick="showReviewList([[${res.restId}]], [[${res.restName}]])">
            ğŸ“ <span th:id="'review-count-' + ${res.restId}"
                    th:text="${res.reviewCount}">0</span>
        </span>

                    <button class="..." th:onclick="'openReviewModal(event, ' + ${res.restId} + ')'">EVALUATION</button>
                </div>
            </div>
        </div>
    </aside>
    <div id="map"></div>
</div>

<div id="reviewListModal">
    <div class="modal-content">
        <span class="close" onclick="closeReviewListModal()">&times;</span>
        <h2 id="modalRestName" class="text-xl font-black italic text-[#FF8A5B] mb-4">ì‹ë‹¹ ì´ë¦„</h2>
        <hr class="mb-4">
        <div id="reviewListContainer">
        </div>
    </div>
</div>

<script th:inline="javascript">
    // 1. ì§€ë„ ì´ˆê¸°í™” (ìœ„ë„/ê²½ë„ ì„¤ì •)
    var map = new kakao.maps.Map(document.getElementById('map'), {
        center: new kakao.maps.LatLng(37.49027, 126.92753),
        level: 3
    });

    // 2. ë§ˆì»¤ í‘œì‹œ ë¡œì§ (DTO í•„ë“œëª… ì—°ë™)
    const restaurants = /*[[${restaurantList}]]*/ [];

    restaurants.forEach(res => {
    // 1. ë§ˆì»¤ ìƒì„± ë¡œì§
    const marker = new kakao.maps.Marker({
        map: map,
        position: new kakao.maps.LatLng(res.restLat, res.restLng),
        image: new kakao.maps.MarkerImage('https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png', new kakao.maps.Size(24, 35))
    });

    // 2. ì»¤ìŠ¤í…€ ì˜¤ë²„ë ˆì´ ìƒì„± ë¡œì§
    const content = '<div class="custom-overlay" style="padding:10px; background:white; border:2px solid #FF8A5B; border-radius:15px; box-shadow:0 2px 10px rgba(0,0,0,0.1); min-width:150px;">' +
        '<div style="font-weight:bold; font-size:14px; margin-bottom:8px; text-align:center; border-bottom:1px solid #eee; padding-bottom:5px; color:#333;">' +
            res.restName +
        '</div>' +
        '<div style="display:flex; justify-content:center; gap:10px; font-size:12px; color:#666;">' +
            '<span>ğŸ‘ï¸ ' + res.restViews + '</span>' +
            '<span style="color:#FF4081;">â¤ï¸ <span id="wish-count-' + res.restId + '">' + (res.wishCount ? res.wishCount : 0) + '</span></span>' +
            '<span style="color:#4CAF50;">ğŸ“ ' + (res.reviewCount ? res.reviewCount : 0) + '</span>' +
    '</div>' +
        '</div>' +
    '</div>';

    const overlay = new kakao.maps.CustomOverlay({
        content: content,
        position: marker.getPosition(),
        yAnchor: 1.5 //
    });

    // â˜… [ì¤‘ìš”] ìƒíƒœ ë³€ìˆ˜ëŠ” ë§ˆì»¤ ìƒì„± ì§í›„ì— ì„ ì–¸ë˜ì–´ì•¼ í•©ë‹ˆë‹¤!
    let isOpen = false;

    // 3. ë§ˆì»¤ í´ë¦­ ì‹œ ì¼œê³  ë„ê¸° ë¡œì§ (ê°ì²´ ì¡´ì¬ ì—¬ë¶€ë¡œ íŒë‹¨)
    kakao.maps.event.addListener(marker, 'click', function() {
        // í˜„ì¬ ì˜¤ë²„ë ˆì´ê°€ ì§€ë„(map) ìœ„ì— ì˜¬ë¼ê°€ ìˆëŠ”ì§€ ì§ì ‘ ë¬¼ì–´ë´…ë‹ˆë‹¤.
        if (!overlay.getMap()) {
            // ì§€ë„ì— ì—†ë‹¤ë©´ -> ë„ì›ë‹ˆë‹¤.
            overlay.setMap(map);
            handleStoreClick(res.restId, res.restLat, res.restLng); // ì¡°íšŒìˆ˜ ì¦ê°€ ì‹¤í–‰
        } else {
            // ì´ë¯¸ ì§€ë„ì— ìˆë‹¤ë©´ -> ì§€ì›ë‹ˆë‹¤.
            overlay.setMap(null);
        }
    });
});

    // ê¸°ëŠ¥ í•¨ìˆ˜ë“¤
    function handleStoreClick(restId, lat, lng) {
        map.panTo(new kakao.maps.LatLng(lat, lng));
        // ë¹„ë™ê¸°ë¡œ ì¡°íšŒìˆ˜ ì¦ê°€ ìš”ì²­ (Fetch API)
        fetch('/api/restaurant/view/' + restId, { method: 'POST' });
    }

    function toggleWish(event, restId) {
    // 1. ì´ë²¤íŠ¸ ì „íŒŒ ë°©ì§€: í•˜íŠ¸ë¥¼ ëˆŒë €ì„ ë•Œ ì‹ë‹¹ ìƒì„¸í˜ì´ì§€ë¡œ ì´ë™í•˜ëŠ” ê²ƒì„ ë§‰ìŠµë‹ˆë‹¤.
    event.stopPropagation();

    // 2. ì„œë²„ì— ì°œ ìƒíƒœ ë³€ê²½ ìš”ì²­ (POST ë°©ì‹)
    fetch(`/api/wishlist/${restId}`, { method: 'POST' })
    .then(res => res.text())
    .then(data => {
        // 3. ì„œë²„ ì‘ë‹µì´ ìˆ«ìì¸ì§€ í™•ì¸ (ì •ìƒì ì¸ ìµœì‹  ì°œ ê°œìˆ˜ì¸ì§€ í™•ì¸)
        if (!isNaN(data)) {
            const totalWishCount = parseInt(data);

            // [í•µì‹¬ 1] ë³¸ì (ë¦¬ìŠ¤íŠ¸) í•˜íŠ¸ ëª¨ì–‘ê³¼ ìˆ«ìë¥¼ 'ì¦‰ì‹œ' ë°”ê¿‰ë‹ˆë‹¤. (ì‚¬ìš©ì ì²´ê° ì†ë„ UP!)
            const listHearts = document.querySelectorAll(`[id="heart-shape-${restId}"]`);
            listHearts.forEach(span => {
                // ìˆ«ìê°€ 0ë³´ë‹¤ í¬ë©´ ë‚´ê°€ ì°œí•œ ìƒíƒœì´ë¯€ë¡œ ë¹¨ê°„ í•˜íŠ¸, ì•„ë‹ˆë©´ ë¹ˆ í•˜íŠ¸ë¡œ í‘œì‹œí•©ë‹ˆë‹¤.
                span.innerText = (totalWishCount > 0) ? 'â¤ï¸' : 'ğŸ¤';
            });

            const listCounts = document.querySelectorAll(`[id="wish-count-${restId}"]`);
            listCounts.forEach(el => {
                el.innerText = totalWishCount; // ë¦¬ìŠ¤íŠ¸ì˜ ìˆ«ìíŒì„ ìµœì‹  ê°’ìœ¼ë¡œ êµì²´
            });

            // [í•µì‹¬ 2] ë¶„ì (ì§€ë„ íŒì—…)ì€ ê·¸ë ¤ì§€ëŠ” ì‹œê°„ì´ í•„ìš”í•˜ë¯€ë¡œ 0.1ì´ˆì˜ ì—¬ìœ ë¥¼ ì¤ë‹ˆë‹¤.
            setTimeout(() => {
                // 0.1ì´ˆ ë’¤ì— í™”ë©´ ì „ì²´ë¥¼ ë‹¤ì‹œ í›‘ì–´ì„œ ì§€ë„ ìœ„ì— ìƒˆë¡œ ìƒê¸´ íŒì—…ì˜ ìˆ«ìíŒì„ ì°¾ì•„ ë°”ê¿‰ë‹ˆë‹¤.
                const allCounts = document.querySelectorAll(`[id="wish-count-${restId}"]`);
                allCounts.forEach(el => {
                    el.innerText = totalWishCount;
                });

                // [í•µì‹¬ 3] ëª¨ë“  ì „ê´‘íŒì´ ë‹¤ ë°”ë€ ê²ƒì„ ëˆˆìœ¼ë¡œ í™•ì¸í•œ 'ì§í›„'ì— ì•ˆë‚´ì°½ì„ ë„ì›ë‹ˆë‹¤.
                // ì´ ìˆœì„œì—¬ì•¼ë§Œ ì•Œë¦¼ì°½ ë•Œë¬¸ì— í™”ë©´ì´ ë©ˆì¶”ëŠ” í˜„ìƒì´ ë°œìƒí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                alert("ì°œ ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤! â¤ï¸");
            }, 100);

        } else {
            // ì„œë²„ì—ì„œ ìˆ«ìê°€ ì•„ë‹Œ ë©”ì‹œì§€ê°€ ì™”ì„ ë•Œ (ì˜ˆ: "ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤")
            alert(data);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert("í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.");
    });
}

// ë¦¬ë·° ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
    function showReviewList(restId, restName) {
    fetch(`/api/reviews/${restId}`)
        .then(res => res.json())
        .then(data => {
            const container = document.getElementById('reviewListContainer');
            document.getElementById('modalRestName').innerText = restName + " ë¦¬ë·° ğŸ“";
            container.innerHTML = "";

            if (data.length === 0) {
                container.innerHTML = "<p class='text-center py-5'>ì•„ì§ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤. ğŸ˜Š</p>";
            } else {
                data.forEach(review => {
              // [ì¤‘ìš”] review.reviewId ê°’ì´ ë¹„ì–´ìˆì§€ ì•Šì€ì§€ í™•ì¸í•˜ì„¸ìš”!
              // ë§Œì•½ ì—ëŸ¬ê°€ ë‚œë‹¤ë©´ review.id í˜¹ì€ review.resId ë“±ìœ¼ë¡œ ì´ë¦„ì„ ë°”ê¿”ë³´ì„¸ìš”.
             const rId = review.reviewId;

    const item = `
        <div style="border-bottom: 1px solid #eee; padding: 15px 0; position: relative;">
            <strong>ğŸ‘¤ ${review.userId}</strong>
            <span style="color:#ff9f43">â­ ${review.rating}</span>

            <div style="position: absolute; right: 0; top: 10px;">
                <button onclick="editReview(${rId}, '${review.content}', ${review.rating})"
                        style="font-size: 11px; color: #4A90E2; margin-right: 5px;">ìˆ˜ì •</button>
                <button onclick="deleteReview(${rId})"
                        style="font-size: 11px; color: #FF5A5F;">ì‚­ì œ</button>
            </div>

            <p style="margin-top: 5px;">${review.content}</p>
            <small style="color:#999">${review.createdAt}</small>
        </div>`;
    container.innerHTML += item;
                });
            }
            document.getElementById('reviewListModal').style.display = "flex";
            })
            .catch(err => {
        // [ì¶”ê°€] í†µì‹  ì¤‘ ì—ëŸ¬ê°€ ë°œìƒí•˜ë©´ ì½˜ì†”ì°½ì— ë¹¨ê°„ìƒ‰ìœ¼ë¡œ í‘œì‹œí•´ì¤ë‹ˆë‹¤.
        console.error("ë¦¬ë·° ë¡œë“œ ì‹¤íŒ¨:", err);
    });
    }

    // [ì¶”ê°€] ì‚­ì œ í•¨ìˆ˜: ì§€ìš°ê°œ ê¸°ëŠ¥ì„ ì„œë²„ì— ìš”ì²­í•¨
function deleteReview(reviewId) {
    console.log("ì‚­ì œí•˜ë ¤ëŠ” ë¦¬ë·° ë²ˆí˜¸:", reviewId); // [í™•ì¸ìš©] ì—¬ê¸°ì— undefinedê°€ ëœ¨ë©´ ì•ˆ ë©ë‹ˆë‹¤!

    if (!reviewId || reviewId === "undefined") {
        alert("ë¦¬ë·° ë²ˆí˜¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
    }

    if (confirm("ì •ë§ë¡œ ì´ ë¦¬ë·°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ğŸ—‘ï¸")) {
        fetch(`/api/review/delete/${reviewId}`, { method: 'DELETE' })
            .then(res => {
                if (res.ok) {
                    alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤! âœ¨");
                    location.reload();
                }
            });
    }
}
let isEditMode = false;

// [ì¶”ê°€] ìˆ˜ì • í•¨ìˆ˜: ì‘ì„±ì°½ì„ ë‹¤ì‹œ ë„ì›Œ ì—°í•„ë¡œ ê³ ì¹˜ëŠ” ê¸°ëŠ¥
function editReview(reviewId, content, rating) {
    isEditMode = true; // ìŠ¤ìœ„ì¹˜ë¥¼ 'ìˆ˜ì •'ìœ¼ë¡œ!
    document.getElementById('targetRestId').value = reviewId; // ë¦¬ë·° ë²ˆí˜¸ë¥¼ ë‹´ìŒ
    document.getElementById('reviewContent').value = content;
    document.getElementById('reviewRating').value = rating;
    document.getElementById('reviewModal').classList.remove('hidden');
}

    function closeReviewListModal() {
        document.getElementById('reviewListModal').style.display = "none";
    }

    // [2] ê¸°ì¡´ í•¨ìˆ˜ êµì²´: ì‹ ê·œ ë“±ë¡ìš©
    function openReviewModal(event, restId) {
    event.stopPropagation();
    isEditMode = false; // ìŠ¤ìœ„ì¹˜ë¥¼ 'ë“±ë¡'ìœ¼ë¡œ!
    document.getElementById('targetRestId').value = restId;
    document.getElementById('reviewContent').value = ""; // ì…ë ¥ì°½ ë¹„ìš°ê¸°
    document.getElementById('reviewRating').value = "5";
    document.getElementById('reviewModal').classList.remove('hidden');
}

    // [ì¶”ê°€] 2. ë¦¬ë·° ì‘ì„±ì°½ ë‹«ê¸° í•¨ìˆ˜ (ì·¨ì†Œ ë²„íŠ¼ìš©)
    function closeReviewModal() {
    document.getElementById('reviewModal').classList.add('hidden'); // ì°½ì„ ìˆ¨ê¹ë‹ˆë‹¤.
    document.getElementById('reviewContent').value = ""; // ì…ë ¥í–ˆë˜ ë‚´ìš©ì„ ì§€ì›ë‹ˆë‹¤.
}

    // [4] ê¸°ì¡´ submitReview í•¨ìˆ˜ë¥¼ ì´ ë‚´ìš©ìœ¼ë¡œ ë®ì–´ì“°ê¸°
function submitReview() {
    const id = document.getElementById('targetRestId').value;
    const rating = document.getElementById('reviewRating').value;
    const content = document.getElementById('reviewContent').value;

    const data = { rating: rating, content: content };
    let url = "";

    // ìŠ¤ìœ„ì¹˜ ìƒíƒœì— ë”°ë¼ ë°°ë‹¬ ì£¼ì†Œì™€ ë‹´ëŠ” ë¬¼ê±´ì„ ë‹¤ë¥´ê²Œ ì •í•¨
    if (isEditMode) {
        data.reviewId = id; // ìˆ˜ì •ì¼ ë• ë¦¬ë·° ë²ˆí˜¸
        url = '/api/review/update';
    } else {
        data.resId = id;    // ë“±ë¡ì¼ ë• ì‹ë‹¹ ë²ˆí˜¸
        url = '/api/review/save';
    }

    fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    }).then(response => {
        if (response.ok) {
            alert("ë¦¬ë·°ê°€ ì„±ê³µì ìœ¼ë¡œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤! âœ¨");
            location.reload();
        } else {
            alert("ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë¡œê·¸ì¸ ìƒíƒœë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.");
        }
    });
}

</script>

<footer th:replace="~{fragments/footer :: footerFragment}"></footer>
<div id="reviewModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[1000] flex items-center justify-center">
    <div class="bg-white p-8 rounded-2xl w-96">
        <h2 class="text-xl font-black italic text-[#FF8A5B] mb-4">LEAVE A REVIEW</h2>
        <input type="hidden" id="targetRestId">
        <div class="mb-4">
            <label class="block text-sm font-bold mb-2 italic text-gray-400">RATING (1-5)</label>
            <select id="reviewRating" class="w-full border p-2 rounded-lg italic font-bold text-[#FF8A5B]">
                <option value="5">â­â­â­â­â­ (5ì )</option>
                <option value="4">â­â­â­â­ (4ì )</option>
                <option value="3">â­â­â­ (3ì )</option>
                <option value="2">â­â­ (2ì )</option>
                <option value="1">â­ (1ì )</option>
            </select>
        </div>
        <textarea id="reviewContent" class="w-full border p-3 rounded-lg h-32 mb-4 italic" placeholder="ë§›ì€ ì–´ë– ì…¨ë‚˜ìš”?"></textarea>
        <div class="flex gap-2">
            <button onclick="closeReviewModal()" class="flex-1 py-3 bg-gray-100 rounded-xl font-bold italic text-gray-400">CANCEL</button>
            <button onclick="submitReview()" class="flex-1 py-3 bg-[#FF8A5B] text-white rounded-xl font-bold italic">POST</button>
        </div>
    </div>
</div>
</body>
</html>