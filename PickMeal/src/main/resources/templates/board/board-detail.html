<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="_csrf" th:content="${_csrf.token}"/>
  <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
  <title th:text="${board.title} + ' - PickMeal'">ê²Œì‹œê¸€ ìƒì„¸ - PickMeal</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@700;800&family=Jua&family=Nanum+Gothic:wght@700;800&family=Gamja+Flower&family=Black+Han+Sans&display=swap" rel="stylesheet">
  <style>
    /* í•™ìƒë‹˜ì˜ ê¸°ì¡´ CSS ìŠ¤íƒ€ì¼ 100% ë³´ì¡´ */
    body { font-family: 'Fredoka', sans-serif; background-color: #FFF5F0; margin: 0; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }
    .nav-link { font-family: 'Fredoka', sans-serif; font-weight: 700; font-style: italic; }
    main { padding: 40px 20px; display: flex; flex-direction: column; align-items: center; }
    .main-title-area { text-align: left; width: 100%; max-width: 900px; margin-bottom: 20px; }
    .main-title-area h1 { color: #FF7F50; font-size: 3em; margin: 0; }
    .main-title-area p { color: #FF7F50; font-size: 1.2em; margin-top: 10px; }
    .board-container { background-color: #fff; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); padding: 40px; width: 100%; max-width: 900px; box-sizing: border-box; }
    .board-header { margin-bottom: 20px; border-bottom: 2px solid #FF7F50; padding-bottom: 20px; }
    .board-title { font-size: 2.2em; color: #FF7F50; margin: 0 0 15px 0; word-break: break-all; }
    .board-meta { display: flex; justify-content: space-between; color: #777; font-size: 1em; flex-wrap: wrap; gap: 10px; }
    .board-meta span { margin-right: 15px; }
    .like-count { color: #FF7F50; font-weight: bold; }
    .board-content { padding: 30px 0; min-height: 300px; font-size: 1.1em; line-height: 1.8; color: #444; white-space: pre-wrap; }
    .board-buttons { display: flex; justify-content: flex-end; gap: 15px; margin-top: 30px; border-top: 1px solid #eee; padding-top: 30px; }
    .btn { padding: 12px 25px; border-radius: 30px; font-size: 1.1em; font-family: 'Jua', sans-serif; text-decoration: none; border: none; cursor: pointer; transition: all 0.3s; }
    .btn-orange { background-color: #FF7F50; color: white; box-shadow: 0 4px 0 #E64A19; }
    .btn-orange:hover { background-color: #FF6337; transform: translateY(2px); box-shadow: 0 2px 0 #E64A19; }
    .btn-light { background-color: #f0f0f0; color: #555; box-shadow: 0 4px 0 #d0d0d0; }
    .btn-danger { background-color: #FF5252; color: white; box-shadow: 0 4px 0 #D32F2F; }
    .post-content { font-family: 'Fredoka', sans-serif; font-size: 20px; font-weight: bold; color: #444; line-height: 1.8; }
    .reaction-container { display: flex; justify-content: center; gap: 20px; margin: 40px 0 20px 0; }
    .reaction-btn { display: flex; align-items: center; gap: 10px; padding: 10px 25px; border-radius: 30px; border: 2px solid #FDF5E6; background-color: white; cursor: pointer; transition: all 0.2s ease-in-out; font-family: 'Fredoka', 'Jua', sans-serif; font-size: 1.3em; font-weight: bold; color: #555; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
    .reaction-btn img { width: 28px; height: 28px; }
    .reaction-btn.like.active { border-color: #007BFF; color: #007BFF; }
    .reaction-btn.dislike.active { border-color: #FF5252; color: #FF5252; }
    .comment-container { background-color: #fff; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); padding: 40px; width: 100%; max-width: 900px; box-sizing: border-box; margin-top: 30px; }
    .comment-title { color: #FF7F50; font-family: 'Jua', sans-serif; font-size: 1.8em; border-bottom: 2px solid #FF7F50; padding-bottom: 15px; margin-bottom: 25px; margin-top: 0; }
    .comment-form textarea { width: 100%; border: 2px solid #FDF5E6; border-radius: 15px; padding: 15px; font-size: 1.1em; resize: vertical; outline: none; box-sizing: border-box; }
    .comment-item { border-bottom: 1px solid #eee; padding: 20px 0; }
    .comment-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .comment-author { font-weight: bold; color: #FF7F50; font-size: 1.2em; }
    .comment-date { color: #999; font-size: 0.9em; margin-left: 10px; }
    .comment-content { color: #444; line-height: 1.6; font-size: 1.1em; white-space: pre-wrap; }
    .btn-text { background: none; border: none; color: #999; font-size: 0.9em; cursor: pointer; padding: 0 5px; }
  </style>
</head>
<body>

<header th:replace="~{fragments/header :: headerFragment}"></header>
<div class="overflow-y-auto flex-grow" >
  <main class="flex items-center justify-center content-slide-up py-10">
    <div class="main-title-area">
      <h1>COMMUNITY BOARD</h1>
      <p>Share your tasty experiences!</p>
    </div>

    <div class="board-container">
      <div class="board-header">
        <h2 class="board-title" th:text="${board.title}">ê²Œì‹œê¸€ ì œëª©</h2>
        <div class="board-meta">
          <div>
            <span th:text="'ê¸€ì“´ì´ : ' + ${board.nickname}">ì‘ì„±ì</span>
            <span th:if="${board.updateDate == null}" th:text="'ì‘ì„±ì¼ : ' + ${#dates.format(board.createDate, 'yyyy-MM-dd HH:mm')}">ì‘ì„±ì¼</span>
            <span th:if="${board.updateDate != null}" th:text="'ìµœì¢… ìˆ˜ì •ì¼ : ' + ${#dates.format(board.updateDate, 'yyyy-MM-dd HH:mm')} + ' (ìˆ˜ì •ë¨)'">ìˆ˜ì •ì¼</span>
          </div>
          <div>
            <span th:text="'VIEWS : ' + ${board.viewCount}">ì¡°íšŒìˆ˜</span>
            <span class="like-count">â¤ï¸ <span th:text="${board.likeCount}">15</span></span>
          </div>
        </div>
      </div>

      <div class="post-content" th:utext="${board.content}"></div>

      <div class="reaction-container">
        <button type="button" class="reaction-btn like" th:classappend="${userReaction == 1} ? 'active' : ''" th:onclick="|updateReaction(1, ${board.boardId})|">
          <img src="/images/thumbs-up.png" alt="ì¢‹ì•„ìš”">
          <span id="like-count" th:text="${board.likeCount}">0</span>
        </button>
        <button type="button" class="reaction-btn dislike" th:classappend="${userReaction == -1} ? 'active' : ''" th:onclick="|updateReaction(-1, ${board.boardId})|">
          <img src="/images/thumbs-down.png" alt="ì‹«ì–´ìš”">
          <span id="dislike-count" th:text="${board.dislikeCount}">0</span>
        </button>
      </div>

      <div class="board-buttons">
        <a href="/board/list" class="btn btn-light">ëª©ë¡ìœ¼ë¡œ</a>
        <th:block th:if="${isWriter}">
          <a th:href="@{/board/edit/{boardId}(boardId=${board.boardId})}" class="btn btn-orange">ìˆ˜ì •</a>
          <button type="button" class="btn btn-danger" th:boardId="${board.boardId}" onclick="deleteBoard(this.getAttribute('boardId'))">ì‚­ì œ</button>
        </th:block>
      </div>

      <hr class="my-5">
      <div class="comment-container">
        <h3 class="comment-title">ëŒ“ê¸€ <span th:text="${#lists.size(comments)}">0</span></h3>

        <form class="comment-form" th:action="@{/comment/write/{boardId}(boardId=${board.boardId})}" th:method="post" onsubmit="return handleCommentSubmit(event)">
          <input type="hidden" name="boardId" th:value="${board.boardId}">
          <textarea name="content" rows="3" placeholder="ë§›ìˆëŠ” ê²½í—˜ì„ ëŒ“ê¸€ë¡œ ë‚¨ê²¨ì£¼ì„¸ìš”!" required></textarea>
          <div style="text-align: right; margin-top: 15px;">
            <button type="submit" class="btn btn-orange">ëŒ“ê¸€ ë“±ë¡</button>
          </div>
        </form>

        <div class="comment-list">
          <div th:if="${#lists.isEmpty(comments)}" style="text-align: center; color: #999; padding: 40px 0; font-family: 'Jua', sans-serif; font-size: 1.2em;">
            ì²« ë²ˆì§¸ ëŒ“ê¸€ì˜ ì£¼ì¸ê³µì´ ë˜ì–´ë³´ì„¸ìš”! ğŸ”
          </div>

          <div th:each="comment : ${comments}" class="comment-item">
            <div th:id="'comment-view-' + ${comment.comment_id}">
              <div class="comment-header">
                <div>
                  <span class="comment-author" th:text="${comment.nickname}">ì‘ì„±ì</span>
                  <span class="comment-date" th:if="${comment.updateCommentDate == null}" th:text="${#dates.format(comment.createCommentDate, 'yyyy-MM-dd HH:mm')}">ì‘ì„±ì¼</span>
                  <span class="comment-date" th:if="${comment.updateCommentDate != null}" th:text="${#dates.format(comment.updateCommentDate, 'yyyy-MM-dd HH:mm')} + ' (ìˆ˜ì •ë¨)'">ìˆ˜ì •ì¼</span>
                </div>
                <div th:if="${user != null and user.user_id == comment.user_id}" style="display: flex; gap: 5px;">
                  <button type="button" class="btn-text" th:onclick="|toggleEditMode(${comment.comment_id})|">ìˆ˜ì •</button>
                  <form th:action="@{/comment/delete/{comment_id}(comment_id=${comment.comment_id})}" method="post" style="margin:0;">
                    <input type="hidden" name="boardId" th:value="${board.boardId}">
                    <button type="submit" class="btn-text" onclick="return confirm('ëŒ“ê¸€ì„ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">ì‚­ì œ</button>
                  </form>
                </div>
              </div>
              <div class="comment-content" th:text="${comment.content}">ë‚´ìš©</div>
            </div>

            <div th:id="'comment-edit-' + ${comment.comment_id}" style="display: none;">
              <form class="comment-form" th:action="@{/comment/update/{comment_id}(comment_id=${comment.comment_id})}" method="post">
                <input type="hidden" name="boardId" th:value="${board.boardId}">
                <textarea name="content" rows="3" th:text="${comment.content}" required></textarea>
                <div style="text-align: right; margin-top: 15px;">
                  <button type="button" class="btn btn-light" th:onclick="|toggleEditMode(${comment.comment_id})|">ì·¨ì†Œ</button>
                  <button type="submit" class="btn btn-orange">ìˆ˜ì • ì™„ë£Œ</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
  <footer th:replace="~{fragments/footer :: footerFragment}"></footer>
</div>

<script th:inline="javascript">
  const currentUser = /*[[${user}]]*/ null;

  function checkAuth() {
      if (!currentUser) {
          if (confirm("ë¡œê·¸ì¸í•œ íšŒì›ë§Œ ì´ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. \në¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
              location.href = "/users/login";
          }
          return false;
      }
      return true;
  }

  function handleCommentSubmit(event) {
      if (!checkAuth()) {
          event.preventDefault();
          return false;
      }
      return true;
  }

  function deleteBoard(boardId) {
      if (confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
          const form = document.createElement('form');
          form.method = 'post';
          form.action = `/board/remove/${encodeURIComponent(boardId)}`;
          const csrfToken = document.querySelector('meta[name="_csrf"]').content;
          const csrfInput = document.createElement('input');
          csrfInput.type = 'hidden';
          csrfInput.name = '_csrf';
          csrfInput.value = csrfToken;
          form.appendChild(csrfInput);
          document.body.appendChild(form);
          form.submit();
      }
  }

  function updateReaction(likeType, boardId) {
      if (!checkAuth()) return;
      const csrfToken = document.querySelector('meta[name="_csrf"]').content;
      const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;
      const formData = new FormData();
      formData.append("like_type", likeType);
      fetch(`/board/reaction/${boardId}`, {
          method: "POST",
          headers: { [csrfHeader]: csrfToken },
          body: formData
      }).then(response => { if (response.ok) location.reload(); })
        .catch(error => console.error("Error:", error));
  }

  function toggleEditMode(comment_id) {
      const viewDiv = document.getElementById('comment-view-' + comment_id);
      const editDiv = document.getElementById('comment-edit-' + comment_id);
      viewDiv.style.display = viewDiv.style.display === 'none' ? 'block' : 'none';
      editDiv.style.display = editDiv.style.display === 'none' ? 'block' : 'none';
  }
</script>
</body>
</html>