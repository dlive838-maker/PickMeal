<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pick Meal - Set New Password</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@700;800&display=swap" rel="stylesheet">
  <style>
    body {
        font-family: 'Fredoka', sans-serif;
        background-color: #FFF5F0;
        margin: 0;
        overflow: hidden;
        height: 100vh;
        display: flex;
        flex-direction: column;
    }

    .content-slide-up {
        animation: slideUp 0.8s cubic-bezier(0.65, 0, 0.35, 1) forwards;
        will-change: transform, opacity;
    }

    @keyframes slideUp {
        from { transform: translateY(100px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }

    .reset-card { border-radius: 3rem; background: white; box-shadow: 0 20px 50px rgba(0,0,0,0.1); }
    .input-field { border-radius: 1.2rem; transition: all 0.3s; border: 2px solid #FDF5E6; width: 100%; }
    .input-field:focus { border-color: #FF8A5B; outline: none; background: white; }

    .btn-primary { background-color: #FF8A5B; transition: all 0.3s; }
    .btn-primary:hover:not(:disabled) { background-color: #e67a4d; transform: scale(1.02); }

    /* ìœ íš¨ì„± ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
    .validation-msg { font-size: 0.75rem; font-weight: 700; transition: all 0.3s; }
    .invalid { color: #9ca3af; } /* íšŒìƒ‰ (ë¯¸ì¶©ì¡±) */
    .valid { color: #FF8A5B; }   /* ì˜¤ë Œì§€ìƒ‰ (ì¶©ì¡±) */
  </style>
</head>
<body>
<header th:replace="~{fragments/header :: headerFragment}"></header>

<main class="flex-grow flex items-center justify-center content-slide-up">
  <div class="reset-card p-12 w-full max-w-lg text-center mx-4 border-2 border-gray-50">
    <h2 class="text-4xl font-black text-[#FF8A5B] italic mb-2 uppercase tracking-tighter">New Password</h2>
    <p class="text-gray-400 font-bold mb-10 italic">Set your new secure password</p>

    <form id="resetForm" class="space-y-6 text-left">
      <input type="hidden" id="token" th:value="${token}">

      <div class="space-y-2">
        <label class="font-black text-gray-700 italic ml-2 uppercase text-sm">New Password</label>
        <input type="password" id="newPassword" placeholder="NEW PASSWORD" class="input-field px-6 py-4 bg-gray-50 font-bold" required>

        <div class="px-2 space-y-1">
          <p id="lengthCheck" class="validation-msg invalid">âœ” 8ê¸€ì ì´ìƒ</p>
          <p id="patternCheck" class="validation-msg invalid">âœ” ì˜ë¬¸, ìˆ«ì, íŠ¹ìˆ˜ë¬¸ì í¬í•¨</p>
        </div>
      </div>

      <div class="space-y-2">
        <label class="font-black text-gray-700 italic ml-2 uppercase text-sm">Confirm Password</label>
        <input type="password" id="confirmPassword" placeholder="CONFIRM PASSWORD" class="input-field px-6 py-4 bg-gray-50 font-bold" required>
        <p id="matchCheck" class="validation-msg invalid px-2">âœ” ë¹„ë°€ë²ˆí˜¸ ì¼ì¹˜</p>
      </div>

      <button type="submit" id="submitBtn" class="btn-primary w-full text-white py-5 rounded-full font-black text-xl shadow-lg transition italic uppercase active:scale-95 mt-4 opacity-50 cursor-not-allowed" disabled>
        Update Password
      </button>
    </form>
  </div>
</main>

<script>
  const newPasswordInput = document.getElementById('newPassword');
  const confirmPasswordInput = document.getElementById('confirmPassword');
  const submitBtn = document.getElementById('submitBtn');

  // ì •ê·œí‘œí˜„ì‹: ì˜ë¬¸, ìˆ«ì, íŠ¹ìˆ˜ë¬¸ì í¬í•¨ í™•ì¸
  const passwordPattern = /^(?=.*[A-Za-z])(?=.*\d)(?=.*[@$!%*#?&])[A-Za-z\d@$!%*#?&]{1,}$/;

  function validatePassword() {
      const pw = newPasswordInput.value;
      const cpw = confirmPasswordInput.value;

      const isLengthValid = pw.length >= 8;
      const isPatternValid = passwordPattern.test(pw);
      const isMatchValid = pw.length > 0 && pw === cpw;

      // UI ì—…ë°ì´íŠ¸
      updateStatus('lengthCheck', isLengthValid);
      updateStatus('patternCheck', isPatternValid);
      updateStatus('matchCheck', isMatchValid);

      // ëª¨ë“  ì¡°ê±´ ì¶©ì¡± ì‹œ ë²„íŠ¼ í™œì„±í™”
      if (isLengthValid && isPatternValid && isMatchValid) {
          submitBtn.disabled = false;
          submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
      } else {
          submitBtn.disabled = true;
          submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
      }
  }

  function updateStatus(id, isValid) {
      const element = document.getElementById(id);
      if (isValid) {
          element.classList.remove('invalid');
          element.classList.add('valid');
      } else {
          element.classList.remove('valid');
          element.classList.add('invalid');
      }
  }

  // ì…ë ¥í•  ë•Œë§ˆë‹¤ ì‹¤ì‹œê°„ìœ¼ë¡œ ê²€ì‚¬
  newPasswordInput.addEventListener('input', validatePassword);
  confirmPasswordInput.addEventListener('input', validatePassword);

  // í¼ ì œì¶œ ë¡œì§
  document.getElementById('resetForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      const token = document.getElementById('token').value;
      const newPassword = newPasswordInput.value;

      try {
          const response = await fetch('/users/reset-password', {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/x-www-form-urlencoded',
              },
              body: new URLSearchParams({
                  'token': token,
                  'newPassword': newPassword
              })
          });

          const result = await response.text();

          if (result === 'success') {
              alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤! âœ¨");
              location.href = '/login';
          } else {
              alert("ìœ íš¨í•˜ì§€ ì•Šê±°ë‚˜ ë§Œë£Œëœ ë§í¬ì…ë‹ˆë‹¤. ë‹¤ì‹œ ì‹ ì²­í•´ ì£¼ì„¸ìš”. ğŸ˜¢");
              location.href = '/users/find-password';
          }
      } catch (error) {
          console.error('Error:', error);
          alert("ì„œë²„ì™€ í†µì‹  ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      }
  });
</script>
</body>
</html>