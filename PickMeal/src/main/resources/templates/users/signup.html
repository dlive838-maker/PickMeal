<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Pick Meal - íšŒì›ê°€ì…</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@700;800&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Fredoka', sans-serif; background-color: #FFF5F0; margin: 0; }
    .signup-card { border-radius: 3rem; background: white; box-shadow: 0 20px 50px rgba(0,0,0,0.1); }
    .input-field { border-radius: 1.2rem; transition: all 0.3s; border: 2px solid #FDF5E6; width: 100%; font-weight: 700; }
    .input-field:focus { border-color: #FF8A5B; outline: none; background: white; }
    .btn-check { background-color: #FF8A5B; color: white; font-weight: 800; border-radius: 1.2rem; padding: 0 1.5rem; transition: all 0.3s; white-space: nowrap; height: 3.25rem; }
    .btn-check:disabled { background-color: #ccc; cursor: not-allowed; }
    .status-msg { font-size: 0.75rem; font-weight: 800; margin-left: 0.5rem; transition: color 0.3s; }
    #timer { font-family: monospace; min-width: 50px; text-align: center; }
  </style>
</head>
<body class="py-20">
<main class="flex items-center justify-center px-4">
  <div class="signup-card p-12 w-full max-w-2xl text-center border-2 border-gray-50">
    <h2 class="text-4xl font-black text-[#FF8A5B] italic mb-2 uppercase tracking-tighter">Create Account</h2>
    <p class="text-gray-400 font-bold mb-10 italic">Tell us more about your taste!</p>

    <form id="signupForm" th:action="@{/users/signup}" th:object="${user}" method="post"
          onsubmit="return validateForm()" class="grid grid-cols-1 md:grid-cols-2 gap-6 text-left">

      <input type="hidden" th:field="*{socialId}">
      <input type="hidden" th:field="*{socialLoginSite}">

      <div class="space-y-4 md:col-span-2">
        <label class="font-black text-gray-700 italic ml-2 uppercase">Basic Info</label>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="flex flex-col gap-1">
            <div class="flex gap-2">
              <input type="text" th:field="*{id}" placeholder="ì•„ì´ë””"
                     class="input-field px-6 py-3 bg-gray-50" th:readonly="${isSocial}" required>
              <button type="button" th:if="${!isSocial}" id="btnCheckId" onclick="checkIdDuplication()"
                      class="btn-check text-xs uppercase">ì¤‘ë³µí™•ì¸
              </button>
            </div>
            <span id="idStatus" class="status-msg text-red-400"></span>
          </div>
          <input type="password" th:field="*{password}" placeholder="ë¹„ë°€ë²ˆí˜¸"
                 th:if="${!isSocial}" class="input-field px-6 py-3 bg-gray-50" required>
        </div>
      </div>

      <div class="space-y-4 md:col-span-1">
        <label class="font-black text-gray-700 italic ml-2 uppercase">User Info</label>
        <input type="text" th:field="*{name}" placeholder="ì´ë¦„" class="input-field px-6 py-3 bg-gray-50"
               required>

        <div class="flex flex-col gap-1">
          <div class="flex gap-2">
            <input type="text" th:field="*{nickname}" placeholder="ë‹‰ë„¤ì„"
                   class="input-field px-6 py-3 bg-gray-50" required>
            <button type="button" id="btnCheckNickname" onclick="checkNicknameDuplication()"
                    class="btn-check text-xs uppercase">ì¤‘ë³µí™•ì¸
            </button>
          </div>
          <span id="nicknameStatus" class="status-msg text-red-400"></span>
        </div>
      </div>

      <div class="space-y-4 md:col-span-1">
        <label class="font-black text-gray-700 italic ml-2 uppercase">Detail Info</label>
        <div class="flex flex-col gap-2">
          <div class="flex gap-2">
            <input type="email" th:field="*{email}" placeholder="ì´ë©”ì¼ ì£¼ì†Œ"
                   class="input-field px-6 py-3 bg-gray-50"
                   th:readonly="${isSocial}" required>
            <button type="button" id="btnSendMail" onclick="sendAuthMail()"
                    th:if="${!isSocial}" class="btn-check text-xs uppercase">ë°œì†¡
            </button>
          </div>
          <div class="flex gap-2 items-center" th:if="${!isSocial}">
            <input type="text" id="emailAuthCode" placeholder="ì¸ì¦ë²ˆí˜¸ ì…ë ¥"
                   class="input-field px-6 py-3 bg-gray-50 text-sm">
            <button type="button" id="btnVerifyMail" onclick="verifyEmailCode()"
                    class="btn-check text-xs uppercase bg-gray-400">ì¸ì¦
            </button>
            <span id="timer" class="text-[#FF8A5B] font-bold text-sm ml-2" style="display: none;">05:00</span>
          </div>
          <div th:if="${isSocial}" class="ml-2 text-green-500 text-xs font-bold italic">
            âœ… ì†Œì…œ ê³„ì • ì´ë©”ì¼ì´ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.
          </div>
        </div>
        <input type="tel" th:field="*{phoneNumber}" placeholder="ì „í™”ë²ˆí˜¸ (010-0000-0000)"
               class="input-field px-6 py-3 bg-gray-50" required>
      </div>

      <div class="space-y-4 md:col-span-2">
        <label class="font-black text-gray-700 italic ml-2 uppercase">Birth Info</label>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <input type="date" th:field="*{birthDate}" class="input-field px-6 py-3 bg-gray-50 text-gray-400" required>
          <select th:field="*{gender}" class="input-field px-6 py-3 bg-gray-50 text-gray-400">
            <option value="">ì„±ë³„ ì„ íƒ</option>
            <option value="M">ë‚¨ì„±</option>
            <option value="F">ì—¬ì„±</option>
          </select>
        </div>
      </div>

      <div class="space-y-4 md:col-span-2">
        <label class="font-black text-gray-700 italic ml-2 uppercase text-sm">Food Taste</label>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <input type="text" th:field="*{likeMenu}" placeholder="ì¢‹ì•„í•˜ëŠ” ìŒì‹ (í”¼ì)" class="input-field px-6 py-3 bg-[#FFF5EF]">
          <input type="text" th:field="*{disLikeMenu}" placeholder="ì‹«ì–´í•˜ëŠ” ìŒì‹ (ê³ ìˆ˜)" class="input-field px-6 py-3 bg-[#FFEBEE]">
        </div>
      </div>

      <button type="submit"
              class="bg-[#FF8A5B] md:col-span-2 text-white py-5 rounded-full font-black text-xl shadow-lg transition italic uppercase active:scale-95 mt-4">
        Welcome Aboard!
      </button>
    </form>
  </div>
</main>

<script th:inline="javascript">
  const isSocial = /*[[${isSocial}]]*/ false;
  let lastCheckedId = isSocial ? document.querySelector('input[name="id"]').value : '';
  let lastCheckedNickname = '';

  // [ì¤‘ìš”] ì†Œì…œ ë¡œê·¸ì¸ ìœ ì €ëŠ” ì²˜ìŒë¶€í„° ì¸ì¦ ì™„ë£Œ ìƒíƒœë¡œ ì„¤ì •í•©ë‹ˆë‹¤.
  let isEmailVerified = isSocial;

  let timerInterval;

  const idInput = document.querySelector('input[name="id"]');
  const nickInput = document.querySelector('input[name="nickname"]');

  // 1. ì‹¤ì‹œê°„ ì¤‘ë³µ ì²´í¬ ìƒíƒœ ì—…ë°ì´íŠ¸ ë¡œì§
  if(idInput && !idInput.readOnly) {
      idInput.addEventListener('input', () => {
          const status = document.getElementById('idStatus');
          if(idInput.value !== lastCheckedId) {
              status.innerText = "ì•„ì´ë”” ì¤‘ë³µí™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.";
              status.className = "status-msg text-red-400";
          } else if(lastCheckedId !== "") {
              status.innerText = "ì‚¬ìš© ê°€ëŠ¥í•œ ì•„ì´ë””ì…ë‹ˆë‹¤! âœ¨";
              status.className = "status-msg text-green-400";
          }
      });
  }

  nickInput.addEventListener('input', () => {
      const status = document.getElementById('nicknameStatus');
      if(nickInput.value !== lastCheckedNickname) {
          status.innerText = "ë‹‰ë„¤ì„ ì¤‘ë³µí™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.";
          status.className = "status-msg text-red-400";
      } else if(lastCheckedNickname !== "") {
          status.innerText = "ì‚¬ìš© ê°€ëŠ¥í•œ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤! âœ¨";
          status.className = "status-msg text-green-400";
      }
  });

  // 2. ì„œë²„ í†µì‹  í•¨ìˆ˜ë“¤
  async function checkIdDuplication() {
      const id = idInput.value.trim();
      if(!id) return alert("ì•„ì´ë””ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!");
      const response = await fetch(`/users/check-id?id=${id}`);
      const result = await response.text();
      const status = document.getElementById('idStatus');
      if(result === 'success') {
          lastCheckedId = id;
          status.innerText = "ì‚¬ìš© ê°€ëŠ¥í•œ ì•„ì´ë””ì…ë‹ˆë‹¤! âœ¨";
          status.className = "status-msg text-green-400";
          alert("ì‚¬ìš© ê°€ëŠ¥í•œ ì•„ì´ë””ì…ë‹ˆë‹¤! âœ¨");
      } else {
          alert("ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì•„ì´ë””ì…ë‹ˆë‹¤. ğŸ˜¢");
          status.innerText = "ì‚¬ìš© ë¶ˆê°€.";
          status.className = "status-msg text-red-400";
      }
  }

  async function checkNicknameDuplication() {
      const nickname = nickInput.value.trim();
      if(!nickname) return alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
      const response = await fetch(`/users/check-nickname?nickname=${encodeURIComponent(nickname)}`);
      const result = await response.text();
      const status = document.getElementById('nicknameStatus');
      if(result === 'success') {
          lastCheckedNickname = nickname;
          status.innerText = "ì‚¬ìš© ê°€ëŠ¥í•œ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤! âœ¨";
          status.className = "status-msg text-green-400";
          alert("ì‚¬ìš© ê°€ëŠ¥í•œ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤! âœ¨");
      } else {
          alert("ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤. ğŸ˜¢");
          status.innerText = "ì‚¬ìš© ë¶ˆê°€.";
          status.className = "status-msg text-red-400";
      }
  }

  function startTimer() {
      let timeLeft = 300;
      const timerDisplay = document.getElementById('timer');
      timerDisplay.style.display = 'inline-block';
      timerDisplay.innerText = "05:00";
      timerDisplay.style.color = "#FF8A5B";

      if(timerInterval) clearInterval(timerInterval);

      timerInterval = setInterval(() => {
          const min = Math.floor(timeLeft / 60);
          const sec = timeLeft % 60;
          timerDisplay.innerText = `${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;

          if(timeLeft <= 0) {
              clearInterval(timerInterval);
              timerDisplay.innerText = "ì‹œê°„ ë§Œë£Œ";
              timerDisplay.style.color = "red";
              alert("ì¸ì¦ ì‹œê°„ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë©”ì¼ì„ ë‹¤ì‹œ ë°œì†¡í•´ì£¼ì„¸ìš”.");
          }
          timeLeft--;
      }, 1000);
  }

  async function sendAuthMail() {
      const email = document.querySelector('input[name="email"]').value;
      if(!email) return alert("ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");

      const response = await fetch('/mail/send', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: `email=${encodeURIComponent(email)}`
      });

      if(response.ok) {
          alert("ì…ë ¥í•˜ì‹  ë©”ì¼ë¡œ ì¸ì¦ë²ˆí˜¸ê°€ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤! âœ‰ï¸");
          startTimer();
      } else {
          alert("ë©”ì¼ ë°œì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
      }
  }

  async function verifyEmailCode() {
      const code = document.getElementById('emailAuthCode').value.trim();
      if(!code) return alert("ì¸ì¦ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!");
      const response = await fetch('/mail/verify', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: `code=${code}`
      });
      const result = await response.text();
      if(result === "success") {
          alert("ì´ë©”ì¼ ì¸ì¦ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! âœ…");
          isEmailVerified = true;
          clearInterval(timerInterval);
          document.getElementById('timer').innerText = "ì¸ì¦ ì™„ë£Œ";
          document.getElementById('timer').style.color = "green";
          document.getElementById('emailAuthCode').readOnly = true;
      } else if(result === "timeout") {
          alert("ì¸ì¦ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ìš”ì²­í•´ì£¼ì„¸ìš”.");
      } else {
          alert("ì˜ëª»ëœ ì¸ì¦ë²ˆí˜¸ì…ë‹ˆë‹¤. ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”. âŒ");
      }
  }

  // 3. ìµœì¢… í¼ ì œì¶œ ê²€ì¦
  function validateForm() {
      if(!isSocial && idInput.value.trim() !== lastCheckedId) {
          alert("ì•„ì´ë”” ì¤‘ë³µí™•ì¸ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”!");
          return false;
      }
      if(nickInput.value.trim() !== lastCheckedNickname) {
          alert("ë‹‰ë„¤ì„ ì¤‘ë³µí™•ì¸ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”!");
          return false;
      }
      if(!isEmailVerified) {
          alert("ì´ë©”ì¼ ì¸ì¦ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”!");
          return false;
      }
      return true;
  }
</script>
</body>
</html>