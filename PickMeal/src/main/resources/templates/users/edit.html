<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pick Meal - Edit Profile</title>

  <meta name="_csrf" th:content="${_csrf?.token}"/>
  <meta name="_csrf_header" th:content="${_csrf?.headerName}"/>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@700;800&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Fredoka', sans-serif; background-color: #FFF5F0; margin: 0; }
    .edit-card { border-radius: 3rem; background: white; box-shadow: 0 20px 50px rgba(0,0,0,0.05); border: 2px solid #FDF5E6; }
    .input-field { width: 100%; padding: 1rem 1.5rem; border-radius: 1.5rem; border: 2px solid #FFF5F0; background-color: #FDFDFD; font-weight: 800; color: #444; transition: all 0.3s ease; font-size: 1.15rem; }
    .input-field:focus { outline: none; border-color: #FF8A5B; background-color: white; box-shadow: 0 0 0 4px rgba(255, 138, 91, 0.1); }
    .input-readonly { background-color: #f3f4f6 !important; color: #9ca3af !important; border: 2px solid #e5e7eb !important; cursor: not-allowed; }
    .label-text { color: #FFB08E; font-size: 0.85rem; font-weight: 800; margin-left: 1rem; margin-bottom: 0.2rem; display: block; }
    .btn-action { padding: 0 1.5rem; height: 3.8rem; border-radius: 1.5rem; background-color: #FF8A5B; color: white; font-weight: 800; transition: all 0.3s ease; white-space: nowrap; }
    .btn-action:hover:not(:disabled) { background-color: #e67a4d; transform: scale(1.02); }
    .btn-action:disabled { background-color: #cbd5e1; cursor: not-allowed; }
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000; display: none; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s ease; }
    .modal-overlay.active { display: flex; opacity: 1; }
    .modal-card { background: white; width: 90%; max-width: 500px; border-radius: 2.5rem; padding: 2.5rem; transform: translateY(20px); transition: transform 0.3s ease; }
    .modal-overlay.active .modal-card { transform: translateY(0); }
    .peer:checked + label.like-tag { background-color: #3B82F6; color: white; border-color: #3B82F6; }
    .peer:checked + label.dislike-tag { background-color: #EF4444; color: white; border-color: #EF4444; }
    .content-slide-up { animation: slideUp 0.8s cubic-bezier(0.65, 0, 0.35, 1) forwards; }
    @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
  </style>
</head>
<body class="min-h-screen flex flex-col">

<header th:replace="~{fragments/header :: headerFragment}"></header>

<main class="flex-grow container mx-auto px-6 pt-40 pb-20 max-w-6xl content-slide-up">
  <div class="text-center mb-16">
    <h2 class="text-6xl font-black text-[#FF8A5B] italic tracking-tighter uppercase inline-block relative">
      Edit Profile
      <span class="absolute -bottom-2 left-0 w-full h-2 bg-[#FF8A5B]/10 rounded-full"></span>
    </h2>
  </div>

  <form id="editForm" th:action="@{/users/edit}" th:object="${user}" method="post">
    <input type="hidden" th:field="*{user_id}">
    <input type="hidden" th:field="*{id}">

    <div class="grid grid-cols-1 md:grid-cols-2 gap-10">
      <div class="edit-card p-12 space-y-6">
        <div>
          <label class="label-text">ì•„ì´ë”” (ë³€ê²½ë¶ˆê°€)</label>
          <input type="text" th:value="${displayId}" class="input-field input-readonly" readonly disabled>
          <input type="hidden" th:field="*{id}">
        </div>
        <div>
          <label class="label-text">ì´ë©”ì¼</label>
          <div class="flex gap-3">
            <input type="email" id="emailDisplay"
                   th:value="${user.email != null ? user.email.replaceAll('(^[^@]{2})[^@]+(@[^@]{1})[^@]+(\.[^@]+$)', '$1******$2*******$3') : ''}"
                   class="input-field input-readonly" readonly>

            <button th:if="${user.socialLoginSite == null or user.socialLoginSite == ''}"
                    type="button" onclick="openModal('emailModal')" class="btn-action">ìˆ˜ì •</button>

            <span th:unless="${user.socialLoginSite == null or user.socialLoginSite == ''}"
                  class="flex items-center text-xs text-gray-400 font-bold px-2">
              ì†Œì…œ ê³„ì •ì€ ì´ë©”ì¼ ë³€ê²½ì´ ë¶ˆê°€í•©ë‹ˆë‹¤.
            </span>
          </div>
        </div>
        <div th:if="${user.socialLoginSite == null or user.socialLoginSite == ''}">
          <label class="label-text">ë¹„ë°€ë²ˆí˜¸</label>
          <div class="flex gap-3">
            <input type="password" value="********" class="input-field input-readonly" readonly>
            <button type="button" onclick="openModal('pwModal')" class="btn-action">ìˆ˜ì •</button>
          </div>
        </div>
        <div>
          <label class="label-text">ë‹‰ë„¤ì„</label>
          <div class="flex gap-3">
            <input type="text" th:field="*{nickname}" id="nicknameInput" class="input-field" required>
            <button type="button" id="checkNicknameBtn" class="btn-action">ì¤‘ë³µí™•ì¸</button>
          </div>
          <p id="nicknameStatus" class="text-xs mt-2 ml-4 font-bold"></p>
        </div>
        <div>
          <label class="label-text">ì´ë¦„ (ë³€ê²½ë¶ˆê°€)</label>
          <input type="text" th:field="*{name}" class="input-field input-readonly" readonly disabled>
        </div>
        <div>
          <label class="label-text">ì „í™”ë²ˆí˜¸ (ë³€ê²½ë¶ˆê°€)</label>
          <input type="text"
                 th:value="${user.phoneNumber != null ? user.phoneNumber.replaceAll('(\d{3})-(\d{1})\d{3}-(\d{1})\d{3}', '$1-$2***-$3***') : ''}"
                 class="input-field input-readonly" readonly disabled>
        </div>
      </div>

      <div class="edit-card p-12 bg-[#FF8A5B]/2 space-y-10">
        <h3 class="text-3xl font-black text-[#FF8A5B] mb-10 italic uppercase tracking-tight">Taste Preference</h3>
        <div>
          <label class="label-text text-blue-400">ì¢‹ì•„í•˜ëŠ” ìŒì‹ â¤ï¸</label>
          <div class="flex flex-wrap gap-2 mt-2 mb-4">
            <th:block th:each="food : ${ {'í•œì‹', 'ì¼ì‹', 'ì¤‘ì‹', 'ì–‘ì‹', 'ì¹˜í‚¨', 'í”¼ì', 'ê³ ê¸°', 'ë©´ìš”ë¦¬', 'ë¶„ì‹', 'ë””ì €íŠ¸'} }">
              <input type="checkbox" th:id="${'like-' + food}" name="likeMenuCheck" th:value="${food}"
                     th:checked="${user.likeMenu != null and user.likeMenu.contains(food)}" class="hidden peer">
              <label th:for="${'like-' + food}" class="like-tag px-4 py-2 border-2 border-blue-100 text-blue-400 rounded-full cursor-pointer font-bold text-xs transition-all hover:bg-blue-50">[[${food}]]</label>
            </th:block>
          </div>
          <input type="text" id="likeInput" th:field="*{likeMenu}" class="input-field text-lg" placeholder="ì—¬ëŸ¬ ê°œë¥¼ ì„ íƒí•˜ê±°ë‚˜ ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”">
        </div>
        <div>
          <label class="label-text text-red-400">ì‹«ì–´í•˜ëŠ” ìŒì‹ ğŸ’”</label>
          <div class="flex flex-wrap gap-2 mt-2 mb-4">
            <th:block th:each="food : ${ {'ê³ ìˆ˜', 'ì˜¤ì´', 'ê°€ì§€', 'ë¯¼ì´ˆ', 'ë§¤ìš´ê²ƒ', 'ëŠë¼í•œê²ƒ', 'í•´ì‚°ë¬¼', 'ë‚ ê²ƒ', 'í–¥ì‹ ë£Œ'} }">
              <input type="checkbox" th:id="${'dislike-' + food}" name="disLikeMenuCheck" th:value="${food}"
                     th:checked="${user.disLikeMenu != null and user.disLikeMenu.contains(food)}" class="hidden peer">
              <label th:for="${'dislike-' + food}" class="dislike-tag px-4 py-2 border-2 border-red-100 text-red-400 rounded-full cursor-pointer font-bold text-xs transition-all hover:bg-red-50">[[${food}]]</label>
            </th:block>
          </div>
          <input type="text" id="dislikeInput" th:field="*{disLikeMenu}" class="input-field text-lg" placeholder="ì—¬ëŸ¬ ê°œë¥¼ ì„ íƒí•˜ê±°ë‚˜ ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”">
        </div>
      </div>
    </div>

    <div class="mt-16 flex justify-center gap-6">
      <button type="submit" id="submitBtn" class="px-12 py-5 bg-[#FF8A5B] text-white rounded-full font-black text-xl shadow-xl hover:bg-[#e67a4d] hover:scale-105 transition-all duration-300 italic uppercase">Save Changes</button>
      <a th:href="@{/users/mypage}" class="px-12 py-5 bg-slate-200 text-slate-500 rounded-full font-black text-xl hover:bg-red-50 hover:text-red-500 transition-all duration-300 italic uppercase">Cancel</a>
    </div>
  </form>
</main>

<div id="emailModal" class="modal-overlay" onclick="closeModalOnOutSide(event)">
  <div class="modal-card space-y-6">
    <h3 class="text-3xl font-black text-[#FF8A5B]">ì´ë©”ì¼ ë³€ê²½</h3>
    <div id="emailStep1">
      <label class="label-text">í˜„ì¬ ë“±ë¡ëœ ì´ë©”ì¼ ì…ë ¥</label>
      <div class="flex gap-2">
        <input type="email" id="currEmail" class="input-field" placeholder="í˜„ì¬ ì´ë©”ì¼">
        <button type="button" onclick="verifyEmailStep1()" class="btn-action px-6">í™•ì¸</button>
      </div>
    </div>
    <div id="emailStep2" class="hidden space-y-4">
      <label class="label-text">ë³€ê²½í•  ìƒˆ ì´ë©”ì¼</label>
      <div class="flex gap-2">
        <input type="email" id="newEmail" class="input-field" placeholder="ìƒˆ ì´ë©”ì¼">
        <button type="button" onclick="sendCode()" class="btn-action px-6">ì¸ì¦ë²ˆí˜¸</button>
      </div>
      <div class="relative">
        <input type="text" id="verifyCode" class="input-field" placeholder="ì¸ì¦ë²ˆí˜¸ 6ìë¦¬">
        <span id="timer" class="absolute right-32 top-1/2 -translate-y-1/2 text-red-500 font-bold hidden">05:00</span>
        <button type="button" id="codeVerifyBtn" onclick="verifyEmailCode()" class="btn-action px-6 absolute right-0 top-0">ì¸ì¦</button>
      </div>
    </div>
    <div class="flex justify-end gap-3 mt-4 border-t pt-6">
      <button type="button" onclick="closeModal('emailModal')" class="font-bold text-gray-400 mr-auto">ì·¨ì†Œ</button>
      <button type="button" id="emailUpdateSubmit" onclick="apiUpdateEmail()" class="btn-action px-10" disabled>ìˆ˜ì •í•˜ê¸°</button>
    </div>
  </div>
</div>

<div id="pwModal" class="modal-overlay" onclick="closeModalOnOutSide(event)">
  <div class="modal-card space-y-4">
    <h3 class="text-3xl font-black text-[#FF8A5B]">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h3>

    <div>
      <label class="label-text">í˜„ì¬ ë¹„ë°€ë²ˆí˜¸</label>
      <input type="password" id="currPw" class="input-field" placeholder="í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
      <p id="currPwError" class="text-xs mt-1 ml-4 font-bold text-red-500 hidden">í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.</p>
    </div>

    <div>
      <label class="label-text">ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
      <input type="password" id="modalNewPw" class="input-field" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
      <p id="pwComplexityMsg" class="text-[0.7rem] mt-1 ml-4 font-bold text-gray-400">ì˜ë¬¸+ìˆ«ì+íŠ¹ìˆ˜ë¬¸ì í¬í•¨ 8ì ì´ìƒ</p>
    </div>

    <div>
      <label class="label-text">ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
      <input type="password" id="modalNewPwCheck" class="input-field" placeholder="í•œ ë²ˆ ë” ì…ë ¥">
      <p id="pwMatchMsg" class="text-[0.7rem] mt-1 ml-4 font-bold text-gray-400">ë¹„ë°€ë²ˆí˜¸ë¥¼ í•œ ë²ˆ ë” ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
    </div>

    <div class="flex justify-end gap-4 mt-6 border-t pt-6">
      <button type="button" onclick="closeModal('pwModal')" class="font-bold text-gray-400 mr-auto">ì·¨ì†Œ</button>
      <button type="button" id="pwUpdateSubmitBtn" onclick="apiUpdatePassword()" class="btn-action px-10" disabled>ìˆ˜ì •í•˜ê¸°</button>
    </div>
  </div>
</div>

<script th:inline="javascript">
  /*<![CDATA[*/
    const csrfToken = document.querySelector('meta[name="_csrf"]')?.content;
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content;

    const modalNewPw = document.getElementById('modalNewPw');
    const modalNewPwCheck = document.getElementById('modalNewPwCheck');
    const pwComplexityMsg = document.getElementById('pwComplexityMsg');
    const pwMatchMsg = document.getElementById('pwMatchMsg');
    const pwUpdateSubmitBtn = document.getElementById('pwUpdateSubmitBtn');

    // ë¹„ë°€ë²ˆí˜¸ ë³µì¡ë„ ì •ê·œì‹ (ì˜ë¬¸, ìˆ«ì, íŠ¹ìˆ˜ë¬¸ì í¬í•¨ 8ì ì´ìƒ)
    const pwRegex = /^(?=.*[A-Za-z])(?=.*\d)(?=.*[@$!%*#?&])[A-Za-z\d@$!%*#?&]{8,}$/;

    function openModal(id) { document.getElementById(id).classList.add('active'); }
    function closeModal(id) { document.getElementById(id).classList.remove('active'); resetModals(); }
    function closeModalOnOutSide(e) { if(e.target.classList.contains('modal-overlay')) closeModal(e.target.id); }

    function resetModals() {
      if (timerInterval) clearInterval(timerInterval);
      document.getElementById('emailStep1').classList.remove('hidden');
      document.getElementById('emailStep2').classList.add('hidden');
      document.getElementById('emailUpdateSubmit').disabled = true;
      document.getElementById('timer').classList.add('hidden');
      document.querySelectorAll('.modal-card input').forEach(i => i.value = '');
      document.querySelectorAll('.modal-card p.text-red-500').forEach(p => p.classList.add('hidden'));

      // ë¹„ë°€ë²ˆí˜¸ ë©”ì‹œì§€ ì´ˆê¸°í™”
      pwComplexityMsg.innerText = "ì˜ë¬¸+ìˆ«ì+íŠ¹ìˆ˜ë¬¸ì í¬í•¨ 8ì ì´ìƒ";
      pwComplexityMsg.className = "text-[0.7rem] mt-1 ml-4 font-bold text-gray-400";
      pwMatchMsg.innerText = "ë¹„ë°€ë²ˆí˜¸ë¥¼ í•œ ë²ˆ ë” ì…ë ¥í•´ì£¼ì„¸ìš”.";
      pwMatchMsg.className = "text-[0.7rem] mt-1 ml-4 font-bold text-gray-400";
      pwUpdateSubmitBtn.disabled = true;
    }

    // [ì¶”ê°€] ì‹¤ì‹œê°„ ë¹„ë°€ë²ˆí˜¸ ê²€ì¦ ë¡œì§
    function validatePasswords() {
      const p1 = modalNewPw.value;
      const p2 = modalNewPwCheck.value;
      let isComplexityValid = false;
      let isMatchValid = false;

      // 1. ë³µì¡ë„ ê²€ì‚¬
      if (p1.length === 0) {
        pwComplexityMsg.innerText = "ì˜ë¬¸+ìˆ«ì+íŠ¹ìˆ˜ë¬¸ì í¬í•¨ 8ì ì´ìƒ";
        pwComplexityMsg.className = "text-[0.7rem] mt-1 ml-4 font-bold text-gray-400";
      } else if (pwRegex.test(p1)) {
        pwComplexityMsg.innerText = "ì•ˆì „í•œ ë¹„ë°€ë²ˆí˜¸ì…ë‹ˆë‹¤! âœ…";
        pwComplexityMsg.className = "text-[0.7rem] mt-1 ml-4 font-bold text-green-500";
        isComplexityValid = true;
      } else {
        pwComplexityMsg.innerText = "ì˜ë¬¸+ìˆ«ì+íŠ¹ìˆ˜ë¬¸ì ì¡°í•© 8ì ì´ìƒ í•„ìˆ˜ âŒ";
        pwComplexityMsg.className = "text-[0.7rem] mt-1 ml-4 font-bold text-red-500";
      }

      // 2. ì¼ì¹˜ ê²€ì‚¬
      if (p2.length === 0) {
        pwMatchMsg.innerText = "ë¹„ë°€ë²ˆí˜¸ë¥¼ í•œ ë²ˆ ë” ì…ë ¥í•´ì£¼ì„¸ìš”.";
        pwMatchMsg.className = "text-[0.7rem] mt-1 ml-4 font-bold text-gray-400";
      } else if (p1 === p2) {
        pwMatchMsg.innerText = "ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•©ë‹ˆë‹¤! âœ¨";
        pwMatchMsg.className = "text-[0.7rem] mt-1 ml-4 font-bold text-green-500";
        isMatchValid = true;
      } else {
        pwMatchMsg.innerText = "ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. âŒ";
        pwMatchMsg.className = "text-[0.7rem] mt-1 ml-4 font-bold text-red-500";
      }

      // 3. ë²„íŠ¼ í™œì„±í™” ì œì–´
      pwUpdateSubmitBtn.disabled = !(isComplexityValid && isMatchValid);
    }

    modalNewPw.addEventListener('input', validatePasswords);
    modalNewPwCheck.addEventListener('input', validatePasswords);

    let timerInterval;
    function startTimer(duration) {
        clearInterval(timerInterval);
        const timerDisplay = document.getElementById('timer');
        const verifyBtn = document.getElementById('codeVerifyBtn');
        timerDisplay.classList.remove('hidden');
        verifyBtn.disabled = false;

        let timer = duration, minutes, seconds;
        timerInterval = setInterval(() => {
            minutes = parseInt(timer / 60, 10);
            seconds = parseInt(timer % 60, 10);
            minutes = minutes < 10 ? "0" + minutes : minutes;
            seconds = seconds < 10 ? "0" + seconds : seconds;
            timerDisplay.textContent = minutes + ":" + seconds;

            if (--timer < 0) {
                clearInterval(timerInterval);
                timerDisplay.textContent = "ë§Œë£Œ";
                verifyBtn.disabled = true;
                alert("ì¸ì¦ ì‹œê°„ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
            }
        }, 1000);
    }

    async function verifyEmailStep1() {
      const email = document.getElementById('currEmail').value;
      const originalEmail = /*[[${user.email}]]*/ '';
      if(email !== originalEmail) return alert("í˜„ì¬ ë“±ë¡ëœ ì´ë©”ì¼ê³¼ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
      document.getElementById('emailStep1').classList.add('hidden');
      document.getElementById('emailStep2').classList.remove('hidden');
    }

async function sendCode() {
  const newEmail = document.getElementById('newEmail').value.trim();
  if(!newEmail) return alert("ìƒˆ ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”.");

  try {
      const response = await fetch('/mail/send', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded', [csrfHeader]: csrfToken },
          body: new URLSearchParams({ email: newEmail, type: 'EDIT' })
      });

      if (response.ok) {
          startTimer(300);
          alert("ì¸ì¦ë²ˆí˜¸ê°€ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤. âœ‰ï¸");
      }
      // [í•µì‹¬ ì¶”ê°€] ì„œë²„ì—ì„œ 409 ì—ëŸ¬(ì¤‘ë³µ)ë¥¼ ë³´ëƒˆì„ ë•Œ ì²˜ë¦¬
      else if (response.status === 409) {
          const errorMsg = await response.text();
          if(errorMsg.startsWith("social_")) {
              alert("ì´ë¯¸ " + errorMsg.split("_")[1] + " ê³„ì •ìœ¼ë¡œ ê°€ì…ëœ ì´ë©”ì¼ì…ë‹ˆë‹¤. ğŸ˜¢");
          } else {
              alert("ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì´ë©”ì¼ì…ë‹ˆë‹¤. ë‹¤ë¥¸ ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”. ğŸ˜¢");
          }
      } else {
          alert("ë©”ì¼ ë°œì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
      }
  } catch (e) {
      alert("ì„œë²„ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
  }
}

    async function verifyEmailCode() {
      const code = document.getElementById('verifyCode').value;
      if(!code) return alert("ì¸ì¦ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
      try {
          const response = await fetch('/mail/verify', {
              method: 'POST',
              headers: { 'Content-Type': 'application/x-www-form-urlencoded', [csrfHeader]: csrfToken },
              body: new URLSearchParams({ code: code })
          });
          const result = await response.text();
          if (result === "success") {
              alert("ì¸ì¦ ì„±ê³µ!");
              clearInterval(timerInterval);
              document.getElementById('timer').classList.add('hidden');
              document.getElementById('emailUpdateSubmit').disabled = false;
          } else if (result === "timeout") { alert("ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤."); }
          else { alert("ì¸ì¦ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤."); }
      } catch (e) { alert("ì¸ì¦ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ"); }
    }

    async function apiUpdateEmail() {
  const newEmail = document.getElementById('newEmail').value.trim();
  try {
    const response = await fetch('/users/update-email', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', [csrfHeader]: csrfToken },
      body: JSON.stringify({ email: newEmail })
    });

    if(response.ok) {
      alert("ì´ë©”ì¼ì´ ì¦‰ì‹œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤! âœ¨");
      const atIndex = newEmail.indexOf('@');
      const idPart = newEmail.substring(0, atIndex);
      const domainPart = newEmail.substring(atIndex);
      let maskedId = idPart.length <= 2 ? idPart.substring(0, 1) + "******" : idPart.substring(0, 2) + "******";
      document.getElementById('emailDisplay').value = maskedId + domainPart;
      closeModal('emailModal');
    } else if (response.status === 409) {
      // [ì¶”ê°€] ë°±ì—”ë“œ UserControllerì—ì„œ ë³´ë‚¸ 409 ì—ëŸ¬ ì²˜ë¦¬
      alert("ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì´ë©”ì¼ì…ë‹ˆë‹¤. ğŸ˜¢");
    } else {
      alert("ì´ë©”ì¼ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
    }
  } catch (e) {
    alert("ì„œë²„ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
  }
}

    async function apiUpdatePassword() {
      const currPw = document.getElementById('currPw').value;
      const newP = modalNewPw.value;
      const currPwError = document.getElementById('currPwError');
      currPwError.classList.add('hidden');

      if(!currPw || !newP) return alert("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");

      try {
        const response = await fetch('/users/update-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', [csrfHeader]: csrfToken },
          body: JSON.stringify({ currentPassword: currPw, newPassword: newP })
        });
        const result = await response.text();

        if(response.ok && result === "success") {
            alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤! âœ¨");
            closeModal('pwModal');
        } else if (result === "current_password_incorrect") {
            currPwError.classList.remove('hidden');
        } else if (result === "invalid_password_format") {
            alert("ë¹„ë°€ë²ˆí˜¸ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        } else {
            alert("ë³€ê²½ ì‹¤íŒ¨: " + result);
        }
      } catch (e) { alert("í†µì‹  ì˜¤ë¥˜"); }
    }

    const nicknameInput = document.getElementById('nicknameInput');
    const checkBtn = document.getElementById('checkNicknameBtn');
    const statusMsg = document.getElementById('nicknameStatus');
    const initialNickname = /*[[${user.nickname}]]*/ '';
    let isNicknameValid = true;

    nicknameInput.addEventListener('input', () => {
      const currentVal = nicknameInput.value.trim();
      if (currentVal === initialNickname) { isNicknameValid = true; statusMsg.innerText = ""; checkBtn.disabled = true; }
      else { isNicknameValid = false; statusMsg.innerText = "ì¤‘ë³µ í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤."; statusMsg.className = "text-xs mt-2 ml-4 font-bold text-orange-400"; checkBtn.disabled = false; }
    });

    // HTML í•˜ë‹¨ <script> ë‚´ì˜ checkBtn í´ë¦­ ì´ë²¤íŠ¸ ë¶€ë¶„ ìˆ˜ì •
checkBtn.addEventListener('click', async () => {
  const nickname = nicknameInput.value.trim();
  if (!nickname) return;
  try {
    // 1. ìš”ì²­ ì£¼ì†Œê°€ ì •í™•í•œì§€ í™•ì¸ (/users/check-nickname)
    const response = await fetch(`/users/check-nickname?nickname=${encodeURIComponent(nickname)}`);

    // 2. [ì¤‘ìš”] .json() ëŒ€ì‹  .text()ë¥¼ ì‚¬ìš©í•´ì•¼ ì»¨íŠ¸ë¡¤ëŸ¬ì˜ ì‘ë‹µì„ ì½ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    const result = await response.text();

    if (result === "success") { // ì„œë¹„ìŠ¤ì—ì„œ ì¤‘ë³µì´ ì•„ë‹ ë•Œ ë°˜í™˜í•˜ëŠ” ê°’
      statusMsg.innerText = "ì‚¬ìš© ê°€ëŠ¥í•œ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤!";
      statusMsg.className = "text-xs mt-2 ml-4 font-bold text-green-500";
      isNicknameValid = true;
      checkBtn.disabled = true;
    } else {
      statusMsg.innerText = "ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤.";
      statusMsg.className = "text-xs mt-2 ml-4 font-bold text-red-500";
      isNicknameValid = false;
    }
  } catch (err) {
    console.error("ì˜¤ë¥˜:", err);
    alert("ì¤‘ë³µ ì²´í¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
  }
});

    document.getElementById('editForm').addEventListener('submit', (e) => {
      if (!isNicknameValid) { e.preventDefault(); return alert("ë‹‰ë„¤ì„ ì¤‘ë³µ í™•ì¸ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”."); }
    });

    function updateInput(groupName, inputId) {
      const checkboxes = document.querySelectorAll(`input[name="${groupName}"]:checked`);
      const values = Array.from(checkboxes).map(cb => cb.value);
      document.getElementById(inputId).value = values.join(', ');
    }
    document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
      checkbox.addEventListener('change', (e) => {
        if (e.target.name === 'likeMenuCheck') updateInput('likeMenuCheck', 'likeInput');
        else if (e.target.name === 'disLikeMenuCheck') updateInput('disLikeMenuCheck', 'dislikeInput');
      });
    });
  /*]]>*/
</script>
</body>
</html>